SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for paas_etl
-- ----------------------------
DROP TABLE IF EXISTS `paas_etl`;
CREATE TABLE `paas_etl`  (
  `etl_id` int(11) NOT NULL AUTO_INCREMENT,
  `tag` varchar(40) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '分类标签',
  `etl_name` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '任务名称',
  `code` varchar(4000) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'JSON配置代码',
  `is_enabled` int(11) NOT NULL DEFAULT 0 COMMENT '是否启动 ',
  `is_extract` int(11) NOT NULL DEFAULT 0 COMMENT '是否启用抽取器',
  `is_load` int(11) NOT NULL DEFAULT 0 COMMENT '是否启用加载器',
  `is_transform` int(11) NOT NULL DEFAULT 1 COMMENT '是否启用转换器',
  `cursor_type` int(11) NOT NULL DEFAULT 0 COMMENT '0时间；1数值',
  `cursor` bigint(20) NOT NULL DEFAULT 0 COMMENT '游标',
  `alarm_mobile` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT '报警手机号（多个以,隔开）',
  `e_enabled` int(11) NOT NULL DEFAULT 0,
  `e_max_instance` int(11) NOT NULL DEFAULT 1 COMMENT '抽取器集群数',
  `e_last_exectime` datetime NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `t_enabled` int(11) NOT NULL DEFAULT 0,
  `t_max_instance` int(11) NOT NULL DEFAULT 1 COMMENT '转换器集群数',
  `t_last_exectime` datetime NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `l_enabled` int(11) NOT NULL DEFAULT 0,
  `l_max_instance` int(11) NOT NULL DEFAULT 1 COMMENT '加载器集群数',
  `l_last_exectime` datetime NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `last_extract_time` datetime NULL DEFAULT NULL COMMENT '最后抽取时间',
  `last_load_time` datetime NULL DEFAULT NULL COMMENT '最后加载时间',
  `last_transform_time` datetime NULL DEFAULT NULL COMMENT '最后转换时间',
  PRIMARY KEY (`etl_id`) USING BTREE,
  UNIQUE INDEX `IX_key`(`tag`, `etl_name`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = 'PAAS-ETL配置表' ROW_FORMAT = DYNAMIC;

-- ----------------------------
-- Records of paas_etl
-- ----------------------------

-- ----------------------------
-- Table structure for paas_file
-- ----------------------------
DROP TABLE IF EXISTS `paas_file`;
CREATE TABLE `paas_file`  (
  `file_id` int(11) NOT NULL AUTO_INCREMENT COMMENT '文件ID',
  `file_type` int(11) NOT NULL DEFAULT 0 COMMENT '文件类型(0:api, 1:pln, 2:tml)',
  `tag` varchar(40) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '分组村签',
  `label` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '标记',
  `path` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '文件路径',
  `rank` int(11) NOT NULL DEFAULT 0 COMMENT '排列（小的排前）',
  `is_staticize` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否静态',
  `is_editable` tinyint(1) NOT NULL DEFAULT 1 COMMENT '是否可编辑',
  `is_disabled` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否禁用',
  `is_exclude` tinyint(1) NOT NULL DEFAULT 0 COMMENT '排除导入',
  `link_to` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT '连接到',
  `edit_mode` varchar(40) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '编辑模式',
  `content_type` varchar(60) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '内容类型',
  `content` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL COMMENT '内容',
  `note` varchar(99) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '' COMMENT '备注',
  `plan_state` int(11) NOT NULL DEFAULT 0 COMMENT '计划状态',
  `plan_begin_time` datetime NULL DEFAULT NULL COMMENT '计划开始执行时间',
  `plan_last_time` datetime NULL DEFAULT NULL COMMENT '计划最后执行时间',
  `plan_last_timespan` bigint(20) NOT NULL DEFAULT 0 COMMENT '计划最后执行时间长度',
  `plan_interval` varchar(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT '' COMMENT '计划执行间隔',
  `plan_max` int(11) NOT NULL DEFAULT 0 COMMENT '计划执行最多次数',
  `plan_count` int(11) NOT NULL DEFAULT 0 COMMENT '计划执行累计次数',
  `create_fulltime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_fulltime` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
  `use_whitelist` varchar(40) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT '安全名单',
  PRIMARY KEY (`file_id`) USING BTREE,
  UNIQUE INDEX `IX_key`(`path`) USING BTREE,
  INDEX `IX_tag`(`tag`) USING BTREE,
  INDEX `IX_label`(`label`) USING BTREE,
  INDEX `IX_file_type`(`file_type`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = 'PAAS-文件表' ROW_FORMAT = DYNAMIC;



-- ----------------------------
-- Records of paas_file
-- ----------------------------
INSERT INTO `paas_file` VALUES (12, 2, '_code', 'tml', '/_code/java_model', -1, 1, 1, 0, 0, NULL, 'freemarker', '', 'import lombok.Data;\nimport java.util.*;\n\n@Data\npublic class ${table_camel!}Model {\n    \n    <#list fields!! as f>\n  /** ${(f.comment)!} */\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n}', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-15 18:27:22', '2021-05-27 11:30:39', NULL);
INSERT INTO `paas_file` VALUES (13, 0, 'sdk_water', 'hook.start', '/sdk_water/_init.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'if(__global.water && __global.water.ver==1){\n    return {msg:\'old\'};\n}\n\n// 不带 var 开头的变量为引擎全局变量\n__global.water = {ver:2};\n\nwater = __global.water;\n    \nWaterClient = Java.type(\'org.noear.water.WaterClient\');\nWaterProxy  = Java.type(\'org.noear.water.WaterProxy\');\nWaterJob    = Java.type(\'org.noear.water.WaterJob\');\n\nwater.client = WaterClient;\nwater.proxy  = WaterProxy;\n\nwater.cfg = function(tagKey){return WaterClient.Config.getByTagKey(tagKey)};\nwater.db = function(tagKey){return water.cfg(tagKey).getDb()};\nwater.rd = function(tagKey,i){return water.cfg(tagKey).getRd(i)};\nwater.mg = function(tagKey,c){return water.cfg(tagKey).getMg(c)};\nwater.updateCache = function(tags){WaterClient.Notice.updateCache(tags)};\n\nwater.job = function(service,job){var rst = WaterJob.call(service,job);XUtil.log(\"Job return: \"+rst);return rst;}\n\nwater.call = function(service,fun,args){if(!args){args={}} return WaterProxy.call(service,fun,args);};\nwater.paas = function(path,args){if(!args){args={}} return WaterProxy.paas(path,args)};\nwater.raas = function(path,args){var args2={};if(args){for(var k in args){var v=args[k];if(v){if(v instanceof Object){args2[k]=JSON.stringify(v)}else{args2[k]=v}}}}return WaterProxy.raas(path,args2)};\n\nwater.heihei = function(target,msg){return WaterClient.Notice.heihei(target, msg);};\n\nwater.sendMessage = function(topic,message){ return WaterClient.Message.sendMessage(topic, message); }\n\nLocalDate = Java.type(\'java.time.LocalDate\');\nLocalTime = Java.type(\'java.time.LocalTime\');\nLocalDateTime = Java.type(\'java.time.LocalDateTime\');\n\n\nreturn \'OK\';', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-16 15:23:58', '2021-05-28 10:06:18', '');
INSERT INTO `paas_file` VALUES (14, 0, 'sdk_water', '', '/sdk_water/_test.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'return water.db(\'water/water\')\n            .table(\'water_cfg_properties\')\n            .limit(1)\n            .select(\'*\').getMap();\n\n\n\n// let list = water.db(\'water/water\')\n//             .table(\'water_cfg_properties\')\n//             .limit(4)\n//             .select(\'*\')\n//             .getMapList();\n            \n            \n// for(let m in list){\n//     if(m == 0){\n//     return \'0\';\n//     }\n// }\n\n// return \'OK2\';\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-16 16:04:53', '2020-07-01 12:06:26', NULL);
INSERT INTO `paas_file` VALUES (15, 0, 'sdk_rock', 'hook.start', '/sdk_rock/_init.jsx', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'if(__global.rock && __global.rock.ver==2){\n    return {msg:\'old\'};\n}\n\n// 不带 var 开头的变量为引擎全局变量\n__global.rock = {ver:1};\n\nrock = __global.rock;\n    \nRockClient = Java.type(\'sponge.rock.RockClient\');\nRockUtil   = Java.type(\'sponge.rock.RockUtil\');\n\nRockClient.tryInit(cache);\n\n\nrock.client = RockClient;\nrock.util   = RockUtil;\n\nrock.app = function(appID){\n    return RockClient.getApp(appID)\n};\n\nrock.cmd = function(service,cmd,args){\n    var appID  = args.app;\n    var appVer = args.ver;\n    \n    var appKey = RockClient.getApp(appID).app_key;\n\n    var p = JSON.stringify(args.data);\n\n    var token = cmd + \"#\" + p + \"#\" + appKey;\n    var k = appID + \".\" + appVer + \".\" + XUtil.sha1(token, \"UTF-8\");\n\n\n    var form = XUtil.newMap();\n\n    form.put(\"p\", p);\n    form.put(\"k\", k);\n    form.put(\"cmd\", cmd);\n\n    return WaterProxy.call(service, cmd, form); \n};\n\nrock.api = function(service,fun,args){\n    return WaterProxy.call(service, fun, args);//WaterProxy\n};\n\nrock.newID = function(group,key,times){\n    return rock.client.newID(group, key, times);\n};\n\n\n\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-16 17:04:31', '2020-06-18 11:22:27', NULL);
INSERT INTO `paas_file` VALUES (16, 0, 'sdk_rock', '', '/sdk_rock/_test.jsx', 0, 0, 1, 1, 0, NULL, 'javascript', '', '// return rock.app(1).app_key;\n\nlet id = rock.newID(\'LOG_ID\', \'sword_stats_overview\', 60 * 60 * 24 * 365); \n\nXUtil.log(\'new_id:\'+id);\n\nreturn id;', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-16 17:07:17', '2020-05-26 14:32:11', NULL);
INSERT INTO `paas_file` VALUES (24, 2, '_code', '', '/_code/java_model_ibinder', -1, 1, 1, 0, 0, NULL, 'freemarker', '', 'import lombok.Getter;\nimport lombok.Setter;\nimport org.noear.weed.GetHandlerEx;\nimport org.noear.weed.IBinder;\nimport java.math.BigDecimal;\nimport java.util.*;\n\n@Getter\n@Setter\npublic class ${table_camel!}Model implements IBinder {\n    \n    <#list fields!! as f>\n /** ${(f.comment)!} */\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n    @Override\n public void bind(GetHandlerEx s) {\n        <#list fields as f>\n        ${(f.field)!} = s.get(\"${(f.field)!}\").value(${(f.def)!});\n        </#list>\n }\n \n  @Override\n public IBinder clone() {\n    return new ${table_camel!}Model();\n  }\n\n}', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:45:58', '2020-08-19 16:15:06', NULL);
INSERT INTO `paas_file` VALUES (25, 2, '_code', '', '/_code/java_edit', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'public static void edit${table_camel!} (<#list fields!! as f>${(f.type)!} ${(f.field)!}<#sep>,\n                             </#sep></#list>) throws SQLException {\n                                 \n    DbTableQuery query = db().table(\"${tb!}\")<#list fields!! as f><#if (f.field)! != pri_key!>.set(\"${(f.field)!}\", ${(f.field)!})</#if><#sep>\n                             </#sep></#list>;\n\n    if (${pri_key!} > 0) {\n        query.where(\"${pri_key!} = ?\", ${pri_key!})\n             .update();\n    } else {\n        query.insert();\n    }\n\n}\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:46:29', '2020-01-17 14:46:37', NULL);
INSERT INTO `paas_file` VALUES (26, 2, '_code', '', '/_code/java_edit2', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'public static void edit${table_camel!} (${table_camel!}Model m) throws SQLException {\n                                 \n    DbTableQuery qr = db().table(\"${tb!}\")\n                          .setEntity(m);\n\n    if (${pri_key!} > 0) {\n        qr.where(\"${pri_key!} = ?\", ${pri_key!})\n          .update();\n    } else {\n        qr.insert();\n    }\n\n}\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:46:51', '2020-01-17 14:47:02', NULL);
INSERT INTO `paas_file` VALUES (27, 2, '_code', '', '/_code/java_crud', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'public static void save${table_camel!} (${table_camel!}Model m) throws Exception {\n                                 \n    DbTableQuery qr = db().table(\"${tb!}\")\n                          .setEntity(m);\n\n    if (m.${pri_key!} > 0) {\n        qr.where(\"${pri_key!} = ?\", m.${pri_key!})\n          .update();\n    } else {\n        qr.set(\"operator\",Session.current().getUserName())\n          .set(\"log_date\",Datetime.Now().getDate())\n          .set(\"log_fulltime\",Datetime.Now().getFullTime())\n          .insert();\n    }\n}\n\npublic static void del${table_camel!} (int ${pri_key!}) throws SQLException {\n                                 \n    db().table(\"${tb!}\")\n        .where(\"${pri_key!} = ?\", ${pri_key!})\n        .delete();\n}\n\npublic static ${table_camel!}Model get${table_camel!} (int ${pri_key!}) throws SQLException {\n                                 \n    return db().table(\"${tb!}\")\n              .where(\"${pri_key!} = ?\", ${pri_key!})\n              .orderBy(\"log_fulltime desc\")\n              .limit(1)\n              .select(\"*\")\n              .getItem(new ${table_camel!}Model());\n}\n\n\npublic static List<${table_camel!}Model> get${table_camel!}List (${table_camel!}Model m) throws SQLException {\n                                 \n    return db().table(\"${tb!}\")\n              .where(\"1=1\")\n              .orderBy(\"log_fulltime desc\")\n              .select(\"*\")\n              .getList(new ${table_camel!}Model());\n}\n\n\npublic static List<${table_camel!}Model> get${table_camel!}ListByPage (${table_camel!}Model m, PageModel pageModel) throws SQLException {\n                                 \n    DbTableQuery query = db().table(\"${tb!}\")\n                        .where(\"1=1\");\n    if (pageModel != null) {\n      int start = (pageModel.page - 1) * pageModel.pageSize;\n      DbTableQuery queryCount = query;\n      pageModel.setRowCount(queryCount.select(\"count(*)\").getCount());\n      return query\n          .orderBy(\"log_fulltime desc\")\n          .limit(start, pageModel.pageSize)\n          .select(\"*\")\n          .getList(new ${table_camel!}Model());\n    } else {\n      return query.orderBy(\"log_fulltime desc\").select(\"*\").getList(new ${table_camel!}Model());\n    }          \n}\n\n\n\nimport lombok.Getter;\nimport lombok.Setter;\n\n@Getter\n@Setter\npublic class PageModel {\n\n    public Integer page;\n    public Integer pageSize;\n    public long    rowCount;\n\n  public PageModel() { }\n\n  public PageModel(Integer page, Integer pageSize) {\n    this.page = (page == null || page == 0)?1:page;\n    this.pageSize = (pageSize == null || pageSize == 0)?10:pageSize;\n  }\n}\n\n\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:47:15', '2020-01-17 14:47:27', NULL);
INSERT INTO `paas_file` VALUES (28, 2, '_code', '', '/_code/java_insert', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'import noear.weed.DbQueryProcedure;\nimport webapp.Config;\n\npublic class ${tb!}_add extends DbQueryProcedure {\n\n    <#list fields!! as f>\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n    public ${tb!}_add() {\n\n        super(Config.${key!});\n\n        sql(\"INSERT INTO `${tb!}` (<#list fields!! as f>`${(f.field)!}`<#sep>, </#sep></#list>)\" +\n            \" VALUES (<#list fields!! as f>@${(f.field)!}<#sep>,  </#sep></#list>);\");\n\n        <#list fields!! as f>\n        set(\"@${(f.field)!}\", () -> ${(f.field)!});\n        </#list>\n\n    }\n\n}\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:47:48', '2020-01-17 14:47:54', NULL);
INSERT INTO `paas_file` VALUES (29, 2, '_code', '', '/_code/paas_stats_save', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'function insertOrUpdateResult(target_date, <#list fields!! as f><#if f.field != pri_key>${(f.field)!}<#sep>, </#sep></#if></#list>) {\n    <#list fields!! as f>\n    <#if f.field != pri_key>\n    if (!${f.field}) {\n    ${f.field} = 0;\n    }\n    </#if>\n    </#list>\n\n  var is_exist = water\n    .db(\"${tag}.${key}\")\n    .table(\"${tb}\")\n   .where(\"target_date = ?\", target_date)\n    .selectCount();\n \n  if (is_exist && 0 < is_exist) {\n   water\n            .db(\"${tag}.${key}\")\n            .table(\"${tb}\")\n            <#list fields!! as f>\n            <#if f.field != pri_key>\n            .set(\"${f.field}\", ${f.field})\n            </#if>\n            </#list>\n     .set(\"update_date\", now.getDate())\n      .set(\"update_fulltime\", now.getFulltime())\n      .where(\"target_date = ?\", target_date)\n      .update();\n  } else {\n    water\n            .db(\"${tag}.${key}\")\n            .table(\"${tb}\")\n            .set(\"${pri_key}\", rock.client.newID(\"${tag?upper_case}\", \"${tb}_id\", 315360000))\n            <#list fields!! as f>\n            <#if f.field != pri_key>\n            .set(\"${f.field}\", ${f.field})\n            </#if>\n            </#list>\n      .set(\"target_date\", target_date)\n            .set(\"create_date\", now.getDate())\n            .set(\"create_fulltime\", now.getFulltime())\n      .set(\"update_date\", now.getDate())\n      .set(\"update_fulltime\", now.getFulltime())\n      .insert();\n  }\n}', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:48:07', '2021-04-05 16:14:28', NULL);
INSERT INTO `paas_file` VALUES (30, 2, '_code', '', '/_code/weed_xml_insert', 0, 1, 1, 0, 0, NULL, 'freemarker', '', '<sql id=\"add_${tb!}\"\n     :return=\"long\"\n     :caching=\"cache_${key!}\"\n     :cacheClear=\"${tb!}_<#noparse>${</#noparse>${pri_key!}<#noparse>}</#noparse>\"\n     :remarks=\"新增${tb!}\">\n    INSERT INTO `${tb!}` (<#list fields!! as f>`${(f.field)!}`<#sep>, </#sep></#list>)\n                  VALUES (<#list fields!! as f>@{${(f.field)!}:${(f.type)!}}<#sep>, </#sep></#list>)\n</sql>', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:48:34', '2020-08-07 14:18:35', NULL);
INSERT INTO `paas_file` VALUES (31, 2, '_code', '', '/_code/java_model_ibinder_2', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'import org.noear.weed.*;\n\nimport java.util.*;\n\npublic class ${table_camel!}Model implements IBinder {\n    \n    <#list fields!! as f>\n // ${(f.comment)!}\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n  public void bind(GetHandlerEx s) {\n        <#list fields as f>\n        ${(f.field)!} = s.get(\"${(f.field)!}\").value(${(f.def)!});\n        </#list>\n }\n \n  public IBinder clone() {\n    return new ${table_camel!}Model();\n  }\n\n}\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-01-17 14:48:57', '2020-01-17 14:49:07', NULL);
INSERT INTO `paas_file` VALUES (34, 0, '_demo', '', '/_demo/ali_oss_cfg_xutil', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'return XUtil.cfg(\'_demo/aliyun_oss\').getProp();', '测试', 0, NULL, NULL, 0, '', 0, 0, '2020-01-21 15:12:05', '2021-04-07 13:07:24', NULL);
INSERT INTO `paas_file` VALUES (35, 0, 'water', '', '/water/paas/help/api/', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'var System = Java.type(\'java.lang.System\');\n\n\nvar sysinfo = (\'Running on Java version: \' + System.getProperty(\'java.version\')) + \'；\' + (\'Unix time from Java: \' + System.currentTimeMillis());\n\n\nreturn modelAndView(\"/water/paas/help/api/view\",{sysinfo:sysinfo});', '', 0, NULL, NULL, 0, '', 0, 0, '2020-02-05 11:25:59', '2021-03-05 14:46:54', NULL);
INSERT INTO `paas_file` VALUES (36, 0, 'water', '', '/water/paas/help/api/view', 0, 0, 1, 0, 0, NULL, 'freemarker', 'code/internal', '<!doctype html>\n<html class=\"frm10\">\n<head>\n    <title>接口手册</title>\n    <link rel=\"stylesheet\" href=\"//jtx.noear.org/img/_core/durian/main.css?v=14\" />\n    <script src=\"//cdn.bootcss.com/jquery/3.4.1/jquery.min.js\"></script>\n    <style>\n    block{margin:0 10px;}\n    </style>\n</head>\n<body>\n<main>\n\n<div class=\"mar10-t mar10-b\"><h2>概要：</h2></div>\n<br/>\n\n<block>\n${sysinfo!}\n</block>\n<br/>\n<block>\n    <h2>已安装的 脚本或模板执行器</h2>\n    <hr/>\n    <ul>\n        <#list XUtil.executorList() as m1>\n        <li>\n            <div>${m1}</div>\n        </li>\n        </#list>\n    </ul>\n</block>\n<br/>\n\n<block>\n    <h2>脚本和模板执行器 共享嵌入接口或对象</h2>\n    <hr/>\n    <ul>\n        <li>\n            <div class=\"t3\">/** 默认数据访问对象（:org.noear.weed.DbContext） */</div>\n            <div>db</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 默认缓存服务对象（:org.noear.weed.cache.ICacheServiceEx），可被替换 */</div>\n            <div>cache</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 当前上下文对象（:org.noear.solon.core.handle.Context） */</div>\n            <div>ctx</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 本地缓存服务对象（:org.noear.weed.cache.ICacheServiceEx） */</div>\n            <div>localCache</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入基础工具 */</div>\n            <div>XUtil</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入锁工具 */</div>\n            <div>XLock</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入函数总线（用于跨语法共享函数） */</div>\n            <div>XFun</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入消息总线（用于水平拆分或扩展业务处理） */</div>\n            <div>XMsg</div>\n        </li>\n    </ul>\n</block>\n<br/>\n\n<block>\n    <h2>脚本执行器 专属嵌入接口或对象</h2>\n    <hr/>\n    <ul>\n        <li>\n            <div class=\"t3\">/** 加载模块或类 */</div>\n            <div>var obj = <b>requireX</b>(path);</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 返回模块和视图 */</div>\n            <div>return <b>modelAndView</b>(path, model);</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 其它嵌入类 */</div>\n            <div>XContext、ONode、Datetime、Timecount、Timespan</div>\n        </li>\n    </ul>\n</block>\n\n<br/>\n<div class=\"mar10-t mar10-b\"><h2>具体：<n style=\'font-size:1rem;font-weight:normal; \'>（可借用浏览器查找功能快速定位）</n></h2></div>\n<br/>\n\n<#list XUtil.interfaceList() as l1>\n<block>\n    <div><h2>${l1.name}::${l1.type}</h2></div>\n    <hr/>\n    <ul>\n        <#list l1.methods as s1>\n        <li>\n            <div class=\"t3\">${XUtil.htmlEncode(s1.note)!}</div>\n            <div>${s1.code}</div>\n        </li>\n        </#list>\n    </ul>\n</block>\n</#list>\n\n\n</main>\n</body>\n</html>', '', 0, NULL, NULL, 0, '', 0, 0, '2020-02-05 11:37:27', '2021-01-14 12:12:22', NULL);
INSERT INTO `paas_file` VALUES (39, 0, 'sdk_water', '', '/sdk_water/_test_paas.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'return water.paas(\'/sdk_water/_test.jsx\',{});', '', 0, NULL, NULL, 0, '', 0, 0, '2020-03-12 10:00:31', '2020-03-17 10:26:17', NULL);
INSERT INTO `paas_file` VALUES (40, 0, 'sdk_water', '', '/sdk_water/_test_xfun.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'return XFun.callFile(\'/sdk_water/_test.jsx\',{});', '', 0, NULL, NULL, 0, '', 0, 0, '2020-03-12 10:04:52', '2020-03-12 10:05:15', NULL);
INSERT INTO `paas_file` VALUES (41, 0, 'sdk_water', '', '/sdk_water/_test_raas.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', '\nlet args = {\'req_device\':\'f62187db1ac4143a552208bb78bc3f42cd2ebe89\',\'req_ip\':\'117.136.56.189\',\'open_id\':10009493,\'mobile\':\'15858560661\'};\n\n\nreturn water.raas(\'/m/angel/num_risk_model\',{args: args});', '', 0, NULL, NULL, 0, '', 0, 0, '2020-03-12 13:33:53', '2020-03-12 13:53:24', NULL);
INSERT INTO `paas_file` VALUES (42, 0, '_demo', '', '/_demo/ali_oss_cfg_water', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'return water.cfg(\'_demo/aliyun_oss\').getProp();', '测试', 0, NULL, NULL, 0, '', 0, 0, '2020-03-17 10:27:59', '2021-04-07 11:41:50', '');
INSERT INTO `paas_file` VALUES (69, 0, '_funs', '', '/_funs/_api.clz', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'this.checkParamsIsNot0 = function(c,keys){\n    for(var i in keys){\n      if(c.paramAsInt(keys[i]) == 0){\n       c.attrMap().code = 19;\n        c.attrMap().msg = \'参数不能为0(\'+keys[i]+\')\';\n          return false;\n      }\n    }\n    \n    return true;    \n}\n\nthis.checkParamsIsOk = function(c,keys){\n    for(var i in keys){\n      if(c.param(keys[i]) == null){\n      c.attrMap().code = 19;\n      c.attrMap().msg = \'参数缺少或有错误(\'+keys[i]+\')\';\n        return false;\n      }\n    }\n    \n    return true;    \n}\n\nthis.host_isWhitelist = function(c,g){\n    var rUri = c.header(\'Referer\');\n    \n    if(!rUri){\n      c.attrMap().code = 0;\n      c.attrMap().msg  = \'ip is not web\';\n      return false;\n    }\n    \n    if(!g){\n      g = \'server\';\n    }\n    \n    var rUri2 = java.net.URI.create(rUri);\n    var host2 = rUri2.getHost();\n    \n    if(WaterClient.Whitelist.existsOfDomain(g, host2)){\n       return true;\n    }else{\n       c.attrMap().code = 0;\n       c.attrMap().msg  = \'ip is not whitelist\';\n       return false;\n    }\n}\n\nthis.ip_isWhitelist = function(c,g){\n    if(!g){\n      g = \'server\';\n    }\n    \n    var ip = XUtil.ip();\n    \n    if(WaterClient.Whitelist.existsOfIp(g,ip)){\n       return true;\n    }else{\n       c.attrMap().code = 0;\n       c.attrMap().msg  = \'ip is not whitelist\';\n       return false;\n    }    \n}\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-05-06 11:30:08', '2020-06-19 15:27:30', NULL);
INSERT INTO `paas_file` VALUES (70, 0, '_funs', '', '/_funs/_cmd.clz', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'this.checkParamsIsNot0 = function(c,keys) {\n    for(var i in keys){\n      if(c.paramAsInt(keys[i])==0){\n        c.attrMap().code = 19;\n        c.attrMap().msg = \'参数不能为0(\'+keys[i]+\')\';\n          return false;\n      }\n    }\n    \n    return true;\n}\n\nthis.checkParamsIsOk = function(c,keys){\n    for(var i in keys){\n      if(c.param(keys[i])==null){\n      c.attrMap().code = 19;\n      c.attrMap().msg = \'参数缺少或有错误(\'+keys[i]+\')\';\n        return false;\n      }\n    }\n    \n    return true;    \n}', '', 0, NULL, NULL, 0, '', 0, 0, '2020-05-06 11:33:56', '2020-06-19 15:23:24', NULL);
INSERT INTO `paas_file` VALUES (83, 0, 'sdk_water', '', '/sdk_water/_test_time.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'var vm = {};\n\nvm.LocalTime = LocalTime.now().toString();\nvm.LocalDate= LocalDate.now().toString();\nvm.LocalDateTime = LocalDateTime.now().toString();\nvm.test = \'1\';\n\nreturn vm;', '', 0, NULL, NULL, 0, '', 0, 0, '2020-05-29 21:24:00', '2020-08-05 10:46:49', NULL);
INSERT INTO `paas_file` VALUES (119, 0, 'sponge_track', '', '/sponge_track/get.h5.card.uv', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', 'var row_id= ctx.paramAsInt(\"row_id\",0);\n\n/**\n1004412：h5首页卡片\n1004382：原生首页卡片\n*/\n\nvar value =water.db(\"sponge/sponge_track\")\n                .table(\"short_url_ex_track_stat\")\n         .where(\" vi= 3\")\n                .and(\"url_id = ?\", 1004412)\n                .and(\"row_id >=?\",row_id)\n                .limit(100)\n                .select(\"row_id,uv_today,vd,vi\")\n                .getMapList();\nreturn value;', '获取h5首页卡片uv', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 12:58:57', '2020-06-15 13:00:08', NULL);
INSERT INTO `paas_file` VALUES (120, 0, 'sponge_track', '', '/sponge_track/log.day', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,date\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\",\"date\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id = ctx.pramAsInt(\"tag_id\");\nvar date   = ctx.pramAsInt(\"date\");\nvar page   = ctx.pramAsInt(\"page\");\nvar size   = ctx.pramAsInt(\"size\");\n\nif(!size){\n  size=50;\n}\n\nvar list = water.db(\"sponge/sponge_track\")\n                .table(\"short_redirect_log_30d\")\n         .where(\"log_date = ?\",date)\n                         .and(\"tag_id = ?\", tag_id)\n                         .groupBy(\"user_key\")\n                         .limit(page*size, size)\n                  .select(\"user_key AS ukey, log_date\")\n                         .getMapList();\n\nif (list && list.length > 0) {\n  return {code:1,msg:\'success\',list:list};\n} else {\n  return {code:2,msg:\'没有相关数据\',list:[]};\n}', '参数：tag_id,date', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:00:56', '2020-06-15 13:12:42', NULL);
INSERT INTO `paas_file` VALUES (121, 0, 'sponge_track', '', '/sponge_track/log.day.no.duplicate', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：log_date,tag_id\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\nif (!_api.checkParamsIsOk(ctx,[\"log_date\", \"tag_id\"])) {\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"size\"])){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar page     = ctx.paramAsInt(\"page\");\nvar size     = ctx.paramAsInt(\"size\");\nvar tag_id   = ctx.paramAsInt(\'tag_id\');\nvar log_date = ctx.paramAsInt(\'log_date\');\n\nvar click_list = water.db(\"sponge/sponge_track\")\n                      .table(\"short_redirect_log_30d s\")\n                      .innerJoin(\"short_url s1\").on(\"s.url_id = s1.url_id\")\n                      .where(\"s.tag_id = ?\", tag_id).and(\"s.log_date = ?\", log_date)\n                      .groupBy(\"s.user_key,s1.url_partner_key\")\n                      .limit(page*size, size)\n                      .select(\"s.url_id,s.tag_id,s.user_id,s.user_key,s1.url_partner_key,s1.url_name,s.v5 udid\")\n                      .getMapList();\n\nif (click_list && click_list.length > 0) {\n    return {code:1, msg:\'success\', list:click_list};\n} else {\n    return {code:2,msg:\'没有相关数据\',list:[]};\n}\n', '参数：log_date,tag_id', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:06:16', '2020-10-14 16:32:56', NULL);
INSERT INTO `paas_file` VALUES (122, 0, 'sponge_track', '', '/sponge_track/log.ukey.time', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,page,size,log_date\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"size\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\n\nvar tag_id   = ctx.pramAsInt(\"tag_id\");\nvar page     = ctx.pramAsInt(\"page\");\nvar size     = ctx.pramAsInt(\"size\");\nvar log_date = ctx.pramAsInt(\"log_date\");\n\n\nvar list = water.db(\"sponge/sponge_track\")\n                .table(\"short_redirect_log_30d\")\n          .where(\"log_date = ?\",log_date).and(\"tag_id = ?\", tag_id)\n                .groupBy(\"user_key\")\n                .orderBy(\"log_id\")\n                .limit(page*size, size)\n              .select(\"user_key AS ukey, MIN(log_date) AS first_date\")\n                .getMapList();\n\nif (list && list.length > 0) {\n  return {code:1,msg:\'success\',list:list};\n} else {\n  return {code:2,msg:\'没有相关数据\',list:[]};\n}\n', '参数：tag_id,page,size,log_date', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:08:30', '2020-06-15 13:13:06', NULL);
INSERT INTO `paas_file` VALUES (123, 0, 'sponge_track', '', '/sponge_track/log.ukey.time.new', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,size,page,log_date\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"size\"])){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\n\nvar tag_id   = ctx.pramAsInt(\"tag_id\");\nvar page     = ctx.pramAsInt(\"page\");\nvar size     = ctx.pramAsInt(\"size\");\nvar log_date = ctx.pramAsInt(\"log_date\");\n\n\nvar list = water.db(\"sponge/sponge_track\")\n                .table(\"short_redirect_log_30d\")\n                .where(\"log_date = ?\",log_date).and(\"tag_id = ?\", tag_id)\n                .groupBy(\"user_key\")\n                .orderBy(\"log_id\")\n                .limit(page*size, size)\n                .select(\"user_key AS ukey, MIN(log_date) AS first_loan_date, \" +\n                    \"MIN(log_fulltime) AS first_loan_time, MAX(log_date) AS last_loan_date, \" +\n                    \"MAX(log_fulltime) AS last_loan_time\")\n                .getMapList();\n\nif (list && list.length > 0) {\n    return {code:1,msg:\'success\',list:list};\n} else {\n    return {code:2,msg:\'没有相关数据\',list:[]};\n}', '用户首次与最近登录贷超', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:11:49', '2020-06-15 13:15:30', NULL);
INSERT INTO `paas_file` VALUES (124, 0, 'sponge_track', '', '/sponge_track/log.urls', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：user_key,tag_id?,date?\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\nif(!_api.checkParamsIsOk(ctx,[\"udid\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar udid = ctx.param(\"udid\");\nvar tag_id   = ctx.paramAsInt(\"tag_id\",0);\nvar date     = ctx.paramAsInt(\"date\",0);\n\n\nvar tb = water.db(\"sponge/sponge_track\").table(\"short_redirect_log_30d s\")\n   .innerJoin(\"short_url u\")\n   .innerJoin(\"track_tag t\")\n   .on(\"s.url_id = u.url_id\")\n   .and(\"s.tag_id = t.tag_id\")\n   .where(\"s.v5 = ?\",udid);\n\nif(tag_id>0){\n  tb.and(\"s.tag_id = ?\", tag_id);\n}\n\nif (date > 0) {\n  tb.and(\"s.log_date = ?\",date);\n}\n\nvar list = tb.orderBy(\"s.log_fulltime desc\")\n              .limit(50)\n              .select(\"u.url_name,u.url_partner_key,t.tag_name,s.url_id,s.tag_id,s.log_date,DATE_FORMAT(s.log_fulltime,\'%Y-%m-%d %H:%i:%s\') log_fulltime\")\n              .getMapList();\n\n\nlet code = 1;\nlet msg = \'success\';\n\nreturn {code:code, msg:msg, data:list};\n', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:49:21', '2020-09-18 15:45:32', NULL);
INSERT INTO `paas_file` VALUES (125, 0, 'sponge_track', '', '/sponge_track/pui.tag.urls', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,date\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\",\"date\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id = ctx.pramAsInt(\"tag_id\");\nvar date   = ctx.pramAsInt(\"date\");\n\nvar list = water.db(\'sponge/sponge_track\')\n                .exe(`SELECT s.url_id,s.url_name,s.url_partner_key,t.pv,t.uv,t.ip FROM stat_date_hour_pv_uv_ip t INNER JOIN short_url s ON t.url_id = s.url_id WHERE t.tag_id = ${tag_id} AND t.log_date = ${date} AND t.log_hour = -1`);\n\n\nreturn {code:1,msg:\'success\',data:list};', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:49:57', '2020-06-15 13:58:35', NULL);
INSERT INTO `paas_file` VALUES (126, 0, 'sponge_track', '', '/sponge_track/pui.track.get', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：vi,vd,date_start,date_end,url_id,log_hour\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\n\nif(!_api.checkParamsIsNot0(ctx,[\"date_start\",\"date_end\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\n\nvar vi          = ctx.pramAsInt(\"vi\");\nvar vd          = ctx.param(\"vd\");\nvar notvd       = ctx.param(\"notvd\");\nvar date_start  = ctx.pramAsInt(\"date_start\");\nvar date_end    = ctx.pramAsInt(\"date_end\");\nvar url_id      = ctx.pramAsInt(\"url_id\");\nvar log_hour    = ctx.pramAsInt(\"log_hour\");\nvar inlist      = ctx.param(\"inlist\");\n\nvar selectDb = water.db(\"sponge/sponge_track\")\n                .table(\"stat_track_date_hour_pv_uv_ip\")\n         .where(\"1 = 1\")\n                .and(\"log_date >= ?\", date_start)\n                .and(\"log_date <= ?\", date_end);\nif(vd){\n   selectDb.and(\"vd = ?\", vd);\n}\nif(vi>0){\n   selectDb.and(\"vi = ?\", vi);\n}\nif(url_id==-1||url_id>0){\n   selectDb.and(\"url_id = ?\", url_id);\n}\nif (log_hour<25) {\n   selectDb.and(\"log_hour = ?\", log_hour);\n}\nif(notvd){\n   var arr = notvd.split(\',\');\n   for(var i in arr){\n     selectDb.and(\"vd != ?\", arr[i]);\n   }\n}\nif(inlist){\n   var sql = \'(\';\n   var array = inlist.split(\',\');\n   for(i in array){\n     sql = sql + \' vd = \'+array[i]+\' or\';\n   }\n   sql = sql.substring(0,sql.length-2) +\')\';\n   selectDb.and(sql);\n}\n\nvar list = selectDb.orderBy(\"log_date asc\")\n          .select(\"*\")\n                .getMapList();\n                \n\nif (list && list.length > 0) {\n  return {code:1,msg:\'success\',list:list};\n} else {\n  return {code:2,msg:\'没有数据\',list:[]};\n}', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:50:09', '2020-06-15 14:02:31', NULL);
INSERT INTO `paas_file` VALUES (127, 0, 'sponge_track', '', '/sponge_track/pui.url', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：url_partner_key,tag_id,date?\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\nif(!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar upkey  = ctx.pram(\"url_partner_key\");\nvar tag_id = ctx.pramAsInt(\"tag_id\");\nvar date   = ctx.pramAsInt(\"date\");\n\n\nvar db_cfg = \"sponge/sponge_track\";\n\nvar surl = water.db(db_cfg).exe(`map::SELECT * FROM short_url WHERE tag_id = ${tag_id} AND url_partner_key = \'${upkey}\'`);\n\n\nvar tb = water.db(db_cfg).table(\'stat_date_hour_pv_uv_ip\')\n                   .where(\'url_id=? AND tag_id=? AND log_hour=-1\',surl.url_id,tag_id);\n\nif(date>0){ \n    tb.and(\'log_date=?\',date);\n}\n\nvar list = tb.select(\'url_id,pv,uv,ip,log_date\').getMapList();\n\nlist.forEach(m=>{\n  m.url_name = surl.url_name;\n  m.url_partner_key = surl.url_partner_key;\n});\n\nreturn {code:1,msg:\'success\',data:list};', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:50:25', '2020-06-15 14:05:58', NULL);
INSERT INTO `paas_file` VALUES (128, 0, 'sponge_track', '', '/sponge_track/short.url.partner.key.get', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\n\nif(!_api.checkParamsIsOk(ctx,[\"url_key\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar url_key = ctx.param(\"url_key\");\n\n\nvar surl = water.db(\"sponge/sponge_track\").table(\"short_url\")\n                .where(\"url_key = ?\", url_key)\n                .select(\"url_partner_key\")\n                .getValue();\n\nreturn {code:1, msg:\'success\', data:surl};', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:50:36', '2020-06-15 14:07:07', NULL);
INSERT INTO `paas_file` VALUES (129, 0, 'sponge_track', '', '/sponge_track/url.add', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：url_partner_key,url_name,tag_id,tag_access_key\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\nlet _tool = requireX(\'/sponge_track/_tool.lib\');\n\n\nif (!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"url_name\",\"tag_id\",\"tag_access_key\"])) {\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_access_key  = ctx.param(\"tag_access_key\");\nvar tag_id          = ctx.paramAsInt(\"tag_id\",0);\nvar build_link      = ctx.param(\"build_link\");\n\nif (build_link) {\n  if (_tool.checkBuildLink(build_link) === false) {\n    return {code:6,msg:\"构建链接格式不正确\"};\n  }\n}\n\nvar tag = water.db(\"sponge/sponge_track\").table(\"track_tag\")\n      .where(\"tag_id = ?\",tag_id).and(\"tag_access_key = ?\",tag_access_key)\n      .select(\"*\")\n      .getMap();\n\n\nif (tag.tag_id === 0) {\n  return {code:5,msg:\"tag_access_key错误\"};\n}else {\n  var oNode = _tool.addShortUrlApi(ctx); \n\n  if (oNode.url) {\n    return {code:1,msg:\"success\",data:oNode};\n  }else{\n    return {code:4,msg:\"源网址已是短地址格式\"};\n  }\n}\n\n', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:50:47', '2020-09-09 18:35:38', NULL);
INSERT INTO `paas_file` VALUES (130, 0, 'sponge_track', '', '/sponge_track/url.get.by.tag.pk', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,url_partner_key\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\nif (!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"tag_id\"])) {\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id          = ctx.paramAsInt(\"tag_id\");\nvar url_partner_key = ctx.paramAsInt(\"url_partner_key\");\n\nvar obj = water.db(\"sponge/sponge_track\").table(\"short_url\")\n            .where(\"tag_id = ?\",tag_id).and(\"url_partner_key = ?\",url_partner_key)\n            .select(\"*\")\n            .getMap();\n\nreturn {code:1,msg:\"success\",data:obj};', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:50:58', '2020-06-15 14:27:27', NULL);
INSERT INTO `paas_file` VALUES (131, 0, 'sponge_track', '', '/sponge_track/url.pui.get', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,url_ids,date\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\",\"date_start\",\"date_end\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nlet tag_id      = ctx.pramAsInt(\"tag_id\");\nlet date_start  = ctx.pram(\"date_start\");\nlet date_end    = ctx.pram(\"date_end\");\nlet url_ids     = ctx.pram(\"url_ids\")+\"\";\n\nlet selectDb = water.db(\"sponge/sponge_track\")\n                .table(\"stat_date_hour_pv_uv_ip\")\n          .where(\"log_hour = -1\")\n                .and(\"tag_id = ?\", tag_id)\n                .and(\"log_date >= ?\", date_start)\n                .and(\"log_date <= ?\", date_end);\n\nif(url_ids){\n   let sql = \'(\';\n   let array = url_ids.split(\',\');\n   \n   for(let i in array){\n     sql = sql + \' url_id = \'+array[i]+\' or\';\n   }\n   \n   sql = sql.substring(0,sql.length-2) +\')\';\n   selectDb.and(sql);\n}\n\nlet list = selectDb.select(\"*\")\n                .getMapList();              \n                \nif (list && list.length > 0) {\n  return {code:1,msg:\'success\',list:list};\n} else {\n  return {code:2,msg:\'没有数据\',list:[]};\n}', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:51:09', '2020-06-15 14:30:35', NULL);
INSERT INTO `paas_file` VALUES (132, 0, 'sponge_track', '', '/sponge_track/url.update.by.tag.pk', 0, 0, 1, 1, 0, NULL, 'javascript', 'application/json', '//\n// 参数：tag_id,url_partner_key,url_val\n//\n\nlet _api = requireX(\'/_funs/_api.clz\');\n\n\nif (!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"url_val\",\"tag_id\"])) {\n return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id          = ctx.pram(\"tag_id\");\nvar url_partner_key = ctx.pramAsInt(\"url_partner_key\");\nvar url_val         = ctx.pram(\"url_val\");\n\nvar url_val_md5 = XUtil.md5(url_val);\n\nwater.db(\"sponge/sponge_track\").table(\"short_url\")\n            .where(\"tag_id = ?\",tag_id)\n            .and(\"url_partner_key = ?\",url_partner_key)\n     .set(\"url_val_md5\", url_val_md5)\n      .set(\"url_val\", url_val)\n            .set(\"update_time\", \"$NOW()\")\n            .update();\n\nreturn {code:1,msg:\"success\"};', 'ok', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 13:51:19', '2020-06-15 14:32:05', NULL);
INSERT INTO `paas_file` VALUES (133, 0, 'sponge_track', '', '/sponge_track/_tool.lib', 0, 0, 1, 1, 0, NULL, 'javascript', 'code/internal', 'this.addShortUrlApi = function(ctx){\n    var prefix = water.cfg(\'sponge/track_uri\').value;\n    \n    var tag_id          = ctx.paramAsInt(\"tag_id\",0);\n    var tag_access_key  = ctx.param(\"tag_access_key\");\n    var url_partner_key = ctx.param(\"url_partner_key\");\n    var url_name        = ctx.param(\"url_name\");\n    var url_val         = ctx.param(\"url_val\");\n    var track_params    = ctx.param(\"track_params\");\n    var trans_params    = ctx.param(\"trans_params\");\n    var user_field      = ctx.param(\"user_field\");\n    var build_link      = ctx.param(\"build_link\");\n    var note            = ctx.param(\"note\");\n    \n    if (url_val && url_val.indexOf(prefix) >= 0) { \n      return {};\n    } \n    \n    var dbx = water.db(\"sponge/sponge_track\");\n    \n    \n    var shortUrl = dbx.table(\"short_url\")\n                .where(\"tag_id = ?\",tag_id).and(\"url_partner_key = ?\",url_partner_key)\n                .select(\"*\")\n                .getMap();\n    \n    var url_id = shortUrl.url_id;\n    var trackParamsNum = 0;\n    var tag = dbx.table(\"track_tag\")\n          .where(\"tag_id = ?\",tag_id)\n         .select(\"*\")\n          .getMap();\n    \n    var tag_host = tag.tag_host;\n    if(tag_host){\n       if(tag_host.substr(-1)!=\'/\'){\n       tag_host = tag_host + \'/\';\n       }\n       prefix = tag_host;\n    }\n    var dbQueryUpdate = dbx.table(\"short_url\")\n          .set(\"tag_id\", tag_id)\n          .set(\"url_partner_key\", url_partner_key)\n          .set(\"url_name\",url_name)\n                .set(\"update_time\", \"$NOW()\");\n\n    if(track_params) {\n        trackParamsNum = track_params.split(\',\').length;\n        dbQueryUpdate.set(\"track_params\", track_params)\n          .set(\"track_params_num\", trackParamsNum);\n    } else{\n      track_params = tag.t_track_params;\n\n       if(track_params){\n        trackParamsNum = track_params.split(\',\').length;\n       }\n    }\n    \n    if(!trans_params) { \n        trans_params = tag.t_trans_params;\n    } else {\n        dbQueryUpdate.set(\"trans_params\", trans_params);\n    }\n    \n    if(!user_field) { \n        user_field = tag.t_user_field;\n    } else {\n       dbQueryUpdate.set(\"user_field\",user_field);\n    }\n    \n    if(!build_link) { \n        build_link = tag.t_build_link;\n    } else {\n        dbQueryUpdate.set(\"build_link\",build_link);\n    }\n    \n    var url_md5 = \'\';\n    if(url_val) { \n        url_md5 = XUtil.md5(url_val);\n        dbQueryUpdate.set(\"url_val\", url_val)\n                     .set(\"url_val_md5\", url_md5);\n    }\n    XUtil.log(track_params+\"a1,\"+trackParamsNum+\"a2,\"+trans_params+\"a3\");\n    var dbQuery = dbx.table(\"short_url\")\n          .set(\"tag_id\", tag_id)\n          .set(\"url_partner_key\", url_partner_key)\n          .set(\"url_name\",url_name)\n         .set(\"url_val_md5\", url_md5)\n          .set(\"url_val\", url_val)\n          .set(\"track_params\", track_params)\n          .set(\"track_params_num\", trackParamsNum)\n          .set(\"trans_params\", trans_params)\n          .set(\"user_field\",user_field)\n         .set(\"build_link\",build_link)\n                .set(\"update_time\", \"$NOW()\");\n    \n    if(!url_id){ \n       /*公共函数调用  tag名_函数名*/\n       url_id = this.getUrlID();\n       var url_key = this.getCodeByID(url_id);\n       \n      dbQuery.set(\"url_id\", url_id)\n           .set(\"create_fulltime\", \"$NOW()\")\n           .set(\"url_key\", url_key)\n             .set(\"note\",note)\n            .insert();\n      \n      dbx.table(\"short_url_ex_stat\")\n          .set(\"url_id\", url_id)\n          .set(\"tag_id\", tag_id)\n          .insert();\n          \n       return {\'url\':prefix+url_key,\'url_id\':url_id};\n    }else{\n     dbQueryUpdate.where(\"url_id = ?\", url_id).update();\n     return {\'url\':prefix+shortUrl.url_key,\'url_id\':url_id};\n    }\n}\n\n\nthis.checkBuildLink = function(build_link){\n    if(!build_link || build_link.indexOf(\'::\')<0){\n      return false;\n    }\n    \n    return true;\n}\n\nthis.getCodeByID = function(id){\n    var key = 999999999;\n    id = id + key;\n    id = id - (key / 100);\n    id = id + (key / 10000);\n    id = id - (key / 1000000);\n    id = parseInt(id + 2);\n    \n    return id.toString(36);\n}\n\nthis.getShortUrlByPartnerKey = function(url_partner_key,tag_id){\n    return water.db(\'sponge/sponge_track\')\n                .exe(`map::SELECT * FROM short_url WHERE url_partner_key=${url_partner_key} AND tag_id=${tag_id}`);\n}\n\nthis.getTag = function(tag_id){\n    return water.db(\'sponge/sponge_track\')\n                .exe(`map::SELECT * FROM track_tag WHERE tag_id=${tag_id}`);\n}\n\nthis.getUrlID = function(){\n    return rock.client.newID(\'SPONGE_ID\',\'url_id\',60 * 60 * 24 * 365) + 1000000;\n}\n\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-06-15 14:09:17', '2021-04-05 16:13:01', NULL);
INSERT INTO `paas_file` VALUES (164, 1, 'sponge_track', '', '/sponge_track/del_stat_360d', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nvar date = Datetime.Now().addDay(-360).getDate();  //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -360 DAY),\'%Y%m%d\')\nvar date2 = Datetime.Now().addDay(-90).getDate(); //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -90 DAY),\'%Y%m%d\')\n\ndb2.exe(`DELETE FROM stat_city_date_pv_uv_ip WHERE log_date <?`, date);\ndb2.exe(`DELETE FROM stat_ua_client_date_pv_uv_ip WHERE log_date <?`, date);\ndb2.exe(`DELETE FROM stat_ua_platform_date_pv_uv_ip WHERE log_date <?`, date);\n\n\ndb2.exe(`DELETE FROM stat_date_hour_pv_uv_ip WHERE log_date <?  AND log_hour>=0`, date2);\n\ndb2.exe(`DELETE FROM stat_track_date_hour_pv_uv_ip WHERE log_date <?`, date2);\n\nreturn \"OK\";\n', '删除超360天的统计数据', 8, '2020-06-14 00:00:00', '2021-04-05 13:38:30', 107, '1d', 0, 268, '2020-06-15 11:39:28', '2020-08-19 11:54:31', NULL);
INSERT INTO `paas_file` VALUES (165, 1, 'sponge_track', '', '/sponge_track/del_track_log_30d', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nvar date = Datetime.Now().addDay(-30).getDate(); //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -30 DAY),\'%Y%m%d\')\n\ndb2.exe(`DELETE FROM short_redirect_log_30d WHERE log_date <= ?`, date);\n\nreturn \'OK\';', '删除超30天的日志数据', 8, '2020-06-14 00:00:00', '2021-04-05 13:38:30', 22, '1d', 0, 266, '2020-06-15 11:42:45', '2020-08-19 11:54:56', NULL);
INSERT INTO `paas_file` VALUES (166, 1, 'sponge_track', '', '/sponge_track/ip_city_code0', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\n//\n// old::APPCODE 42a57d3dd8c543a291ff9d5a06a4fb77\n//\n// new::APPCODE ae5df0d8a5ed4b81bf8b3fe50e292055\n//\nfunction doItem(item){\n var txt  = XUtil.http(\"http://iploc.market.alicloudapi.com/v3/ip?ip=\"+item.ip_val).header(\"Authorization\",\"APPCODE ae5df0d8a5ed4b81bf8b3fe50e292055\").get();\n  var ipx = JSON.parse(txt);\n  \n  if(typeof(ipx.adcode) == \'string\'){\n   db2.exe(`UPDATE code_ip SET city_name=?,city_code=?,is_checked=1 WHERE ip_id =?`, ipx.city, ipx.adcode, item.ip_id);\n  }else{\n    db2.exe(`UPDATE code_ip SET is_checked = 1 WHERE ip_id = ?`, item.ip_id);\n }\n}\n\n\nlet list = db2.exe(`list::SELECT * FROM code_ip WHERE city_code=0 AND is_checked=0 AND MOD(ip_id,5)=0 LIMIT 1000`);\n\nif(list && list.length){\n for(var i in list){\n   var item = list[i];\n   doItem(item);\n }\n}\n\nreturn \'OK\';', '根据IP获取城市码-任务0', 8, '2020-06-15 11:53:27', '2021-04-05 13:48:28', 3268, '10m', 0, 33453, '2020-06-15 11:46:52', '2020-08-19 11:56:12', NULL);
INSERT INTO `paas_file` VALUES (167, 1, 'sponge_track', '', '/sponge_track/ip_city_code1', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nfunction doItem(item){\n var txt  = XUtil.http(\"http://iploc.market.alicloudapi.com/v3/ip?ip=\"+item.ip_val).header(\"Authorization\",\"APPCODE 42a57d3dd8c543a291ff9d5a06a4fb77\").get();\n  var ipx = JSON.parse(txt);\n  \n  if(typeof(ipx.adcode) == \'string\'){\n   db2.exe(`UPDATE code_ip SET city_name=?,city_code=?,is_checked=1 WHERE ip_id =?`, ipx.city, ipx.adcode, item.ip_id);\n  }else{\n    db2.exe(`UPDATE code_ip SET is_checked = 1 WHERE ip_id = ?`, item.ip_id);\n }\n}\n\n\nlet list = db2.exe(`list::SELECT * FROM code_ip WHERE city_code=0 AND is_checked=0 AND MOD(ip_id,5)=1 LIMIT 1000`);\n\nif(list && list.length){\n for(var i in list){\n   var item = list[i];\n   doItem(item);\n }\n}\n\nreturn \'OK\';', '根据IP获取城市码-任务1', 8, '2020-06-15 11:53:37', '2021-04-05 13:48:37', 10, '10m', 0, 33419, '2020-06-15 11:47:16', '2020-08-19 11:57:00', NULL);
INSERT INTO `paas_file` VALUES (168, 1, 'sponge_track', '', '/sponge_track/ip_city_code2', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nfunction doItem(item){\n var txt  = XUtil.http(\"http://iploc.market.alicloudapi.com/v3/ip?ip=\"+item.ip_val).header(\"Authorization\",\"APPCODE 42a57d3dd8c543a291ff9d5a06a4fb77\").get();\n  var ipx = JSON.parse(txt);\n  \n  if(typeof(ipx.adcode) == \'string\'){\n   db2.exe(`UPDATE code_ip SET city_name=?,city_code=?,is_checked=1 WHERE ip_id =?`, ipx.city, ipx.adcode, item.ip_id);\n  }else{\n    db2.exe(`UPDATE code_ip SET is_checked = 1 WHERE ip_id = ?`, item.ip_id);\n }\n}\n\n\nlet list = db2.exe(`list::SELECT * FROM code_ip WHERE city_code=0 AND is_checked=0 AND MOD(ip_id,2)=0 LIMIT 1000`);\n\nif(list && list.length){\n for(var i in list){\n   var item = list[i];\n   doItem(item);\n }\n}\n\nreturn \'OK\';', '根据IP获取城市码-任务2', 8, '2020-06-15 11:53:44', '2021-04-05 13:48:44', 2863, '10m', 0, 33340, '2020-06-15 11:47:26', '2020-08-19 11:57:07', NULL);
INSERT INTO `paas_file` VALUES (169, 1, 'sponge_track', '', '/sponge_track/ip_city_code3', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nfunction doItem(item){\n var txt  = XUtil.http(\"http://iploc.market.alicloudapi.com/v3/ip?ip=\"+item.ip_val).header(\"Authorization\",\"APPCODE 42a57d3dd8c543a291ff9d5a06a4fb77\").get();\n  var ipx = JSON.parse(txt);\n  \n  if(typeof(ipx.adcode) == \'string\'){\n   db2.exe(`UPDATE code_ip SET city_name=?,city_code=?,is_checked=1 WHERE ip_id =?`, ipx.city, ipx.adcode, item.ip_id);\n  }else{\n    db2.exe(`UPDATE code_ip SET is_checked = 1 WHERE ip_id = ?`, item.ip_id);\n }\n}\n\n\nlet list = db2.exe(`list::SELECT * FROM code_ip WHERE city_code=0 AND is_checked=0 AND MOD(ip_id,5)=3 LIMIT 1000`);\n\nif(list && list.length){\n for(var i in list){\n   var item = list[i];\n   doItem(item);\n }\n}\n\nreturn \'OK\';', '根据IP获取城市码-任务3', 8, '2020-06-15 11:53:51', '2021-04-05 13:48:53', 9, '10m', 0, 33261, '2020-06-15 11:47:34', '2020-08-19 11:57:12', NULL);
INSERT INTO `paas_file` VALUES (170, 1, 'sponge_track', '', '/sponge_track/ip_city_code4', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nfunction doItem(item){\n var txt  = XUtil.http(\"http://iploc.market.alicloudapi.com/v3/ip?ip=\"+item.ip_val).header(\"Authorization\",\"APPCODE 42a57d3dd8c543a291ff9d5a06a4fb77\").get();\n  var ipx = JSON.parse(txt);\n  \n  if(typeof(ipx.adcode) == \'string\'){\n   db2.exe(`UPDATE code_ip SET city_name=?,city_code=?,is_checked=1 WHERE ip_id =?`, ipx.city, ipx.adcode, item.ip_id);\n  }else{\n    db2.exe(`UPDATE code_ip SET is_checked = 1 WHERE ip_id = ?`, item.ip_id);\n }\n}\n\n\nlet list = db2.exe(`list::SELECT * FROM code_ip WHERE city_code=0 AND is_checked=0 AND MOD(ip_id,5)=4 LIMIT 1000`);\n\nif(list && list.length){\n for(var i in list){\n   var item = list[i];\n   doItem(item);\n }\n}\n\nreturn \'OK\';', '根据IP获取城市码-任务4', 8, '2020-06-15 11:53:57', '2021-04-05 13:48:59', 13, '10m', 0, 32074, '2020-06-15 11:47:47', '2020-08-19 11:57:22', NULL);
INSERT INTO `paas_file` VALUES (171, 1, 'sponge_track', '', '/sponge_track/notice_stat', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'var date1  = Datetime.Now().addDay(-1).getDate(); //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY),\'%Y%m%d\')\n\n// XUtil.http(\"http://water.zmapi.cn/msg/send/\")\n//      .data(\"key\",XUtil.guid())\n//      .data(\"topic\",\"sponge.stat.notice\")\n//      .data(\"message\",date1)\n//      .post();\n\n\nwater.sendMessage(\"sponge.stat.notice\", date1+\'\');\n\nreturn \'OK\';', '定时发现统计通知（由别人去统计）', 9, '2020-06-15 12:43:03', '2021-01-22 23:16:04', 8, '10m', 0, 26349, '2020-06-15 11:54:38', '2020-06-15 12:00:44', NULL);
INSERT INTO `paas_file` VALUES (172, 1, 'sponge_track', '', '/sponge_track/stat_city', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nlet date1  = new Datetime().getDate();\n\n\ndb2.exe(`UPDATE short_redirect_log_30d l, code_ip u\nSET l.log_city_code = (u.city_code/10000)*10000\nWHERE l.log_city_code=0 AND l.log_ip_id = u.ip_id AND u.city_code>0`);\n\n\ndb2.exe(`DELETE FROM stat_city_date_pv_uv_ip WHERE log_date = ?`, date1);\n\n\ndb2.exe(`INSERT INTO stat_city_date_pv_uv_ip(url_id,tag_id,province_code,log_date,pv,uv,ip)\nSELECT -1,tag_id,log_city_code,log_date,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\nFROM short_redirect_log_30d \nWHERE log_date = ?\nGROUP BY tag_id,log_city_code`, date1);\n\n\ndb2.exe(`INSERT INTO stat_city_date_pv_uv_ip(url_id,tag_id,province_code,log_date,pv,uv,ip)\nSELECT url_id,tag_id,log_city_code,log_date,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\nFROM short_redirect_log_30d \nWHERE log_date = ?\nGROUP BY url_id,log_city_code`, date1);\n\n\n/* update uv2 */\ndb2.exe(`UPDATE stat_city_date_pv_uv_ip t,(\n   SELECT tag_id,province_code,log_date,SUM(uv) uv2 \n   FROM stat_city_date_pv_uv_ip \n   WHERE log_date= ? AND url_id<>-1\n    GROUP BY tag_id,province_code,log_date\n) t2\nSET t.uv2 = t2.uv2\nWHERE t.tag_id = t2.tag_id AND t.province_code = t2.province_code AND t.log_date = t2.log_date AND t.url_id=-1`, date1);\n\nreturn \'OK\';\n', '统计城市数据', 8, '2020-06-15 12:43:09', '2021-04-05 13:53:10', 5907, '5m', 0, 66714, '2020-06-15 12:10:43', '2020-08-19 11:58:51', NULL);
INSERT INTO `paas_file` VALUES (173, 1, 'sponge_track', '', '/sponge_track/stat_ua_client', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\n\nvar date1  = new Datetime().getDate();\n\n\ndb2.exe(`DELETE FROM stat_ua_client_date_pv_uv_ip WHERE log_date = ?`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_client_date_pv_uv_ip(url_id,tag_id,ua_client,log_date,pv,uv,ip)\nSELECT -1,s.tag_id,u.client,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.tag_id,u.client`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_client_date_pv_uv_ip(url_id,tag_id,ua_client,log_date,pv,uv,ip)\nSELECT s.url_id,s.tag_id,u.client,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.url_id,u.client`, date1);\n\n/* update uv2 */\ndb2.exe(`UPDATE stat_ua_client_date_pv_uv_ip t,(\n    SELECT tag_id,ua_client,log_date,SUM(uv) uv2 \n   FROM stat_ua_client_date_pv_uv_ip \n    WHERE log_date= ? AND url_id<>-1\n    GROUP BY tag_id,ua_client,log_date\n) t2\nSET t.uv2 = t2.uv2\nWHERE t.tag_id = t2.tag_id AND t.ua_client = t2.ua_client AND t.log_date = t2.log_date AND t.url_id=-1`, date1);\n\nreturn \'OK\';\n', '统计客户端UA数据', 8, '2020-06-15 12:43:14', '2021-04-05 13:53:13', 8925, '5m', 0, 66706, '2020-06-15 12:10:57', '2020-08-19 11:59:56', NULL);
INSERT INTO `paas_file` VALUES (174, 1, 'sponge_track', '', '/sponge_track/stat_ua_platform', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nvar date1  = new Datetime().getDate();\n\n\ndb2.exe(`DELETE FROM stat_ua_platform_date_pv_uv_ip WHERE log_date = ?`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_platform_date_pv_uv_ip(url_id,tag_id,ua_platform,log_date,pv,uv,ip)\nSELECT -1,s.tag_id,u.platform,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.tag_id,u.platform`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_platform_date_pv_uv_ip(url_id,tag_id,ua_platform,log_date,pv,uv,ip)\nSELECT s.url_id,s.tag_id,u.platform,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.url_id,u.platform`, date1);\n\n\n/* update uv2 */\ndb2.exe(`UPDATE stat_ua_platform_date_pv_uv_ip t,(\n    SELECT tag_id,ua_platform,log_date,SUM(uv) uv2 \n   FROM stat_ua_platform_date_pv_uv_ip \n    WHERE log_date= ? AND url_id<>-1\n    GROUP BY tag_id,ua_platform,log_date\n) t2\nSET t.uv2 = t2.uv2\nWHERE t.tag_id = t2.tag_id AND t.ua_platform = t2.ua_platform AND t.log_date = t2.log_date AND t.url_id=-1`, date1);\n\nreturn \'OK\';\n', '统计平台UA数据', 8, '2020-06-15 12:43:19', '2021-04-05 13:53:20', 2822, '5m', 0, 66712, '2020-06-15 12:11:08', '2020-08-19 12:09:11', NULL);
INSERT INTO `paas_file` VALUES (175, 1, 'sponge_track', '', '/sponge_track/stat_url', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\n\nlet date1  = Datetime.Now().addDay(-1).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY),\'%Y%m%d\')\nlet date30 = Datetime.Now().addDay(-30).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -30 DAY),\'%Y%m%d\')\nlet date0  = Datetime.Now().getDate(); //$<SELECT DATE_FORMAT(NOW(),\'%Y%m%d\')\nlet dateX  = 0;\nlet hour0  = Datetime.Now().getHours();\n\n\nif(hour0>=4){\n  dateX = date0;\n}else{\n  dateX = date1;\n}\n\ndb2.exe(`DELETE FROM stat_date_hour_pv_uv_ip WHERE log_date>=?`, dateX);\n\nfunction stat_url() {\n\n  /*统计典线图：日数据*/\n db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n    SELECT url_id,tag_id,log_date,-1, COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY url_id,log_date`, dateX);\n\n    db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n    SELECT -1,tag_id,log_date,-1, COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY tag_id,log_date`, dateX);\n    \n  /*update date uv2*/\n db2.exe(`UPDATE stat_date_hour_pv_uv_ip t,(\n   SELECT tag_id,log_date,SUM(uv) uv2 \n   FROM stat_date_hour_pv_uv_ip \n   WHERE log_date>= ? AND log_hour=-1 AND url_id<>-1\n   GROUP BY tag_id,log_date\n        ) t2\n      SET t.uv2 = t2.uv2\n      WHERE t.tag_id = t2.tag_id AND t.log_date = t2.log_date AND t.log_hour=-1 AND t.url_id=-1`, dateX);\n   \n\n  /*统计典线图：小时数据*/\n    db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n    SELECT url_id,tag_id,log_date, log_hour,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY url_id,log_date,log_hour`, dateX);\n\n    db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n   SELECT -1,tag_id,log_date, log_hour,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY tag_id,log_date,log_hour`, dateX);\n   \n  /*update hour uv2*/\n db2.exe(`UPDATE stat_date_hour_pv_uv_ip t,(\n   SELECT tag_id,log_date,log_hour,SUM(uv) uv2 \n    FROM stat_date_hour_pv_uv_ip \n   WHERE log_date>= ? AND log_hour<>-1 AND url_id<>-1\n    GROUP BY tag_id,log_date,log_hour\n        ) t2\n      SET t.uv2 = t2.uv2\n      WHERE t.tag_id = t2.tag_id AND t.log_date = t2.log_date AND t.log_hour=t2.log_hour AND t.url_id=-1`, dateX);\n}\n\nfunction stat_url_sum(){\n  /*总量统计：url记录昨日数据*/\n  db2.exe(`UPDATE short_url_ex_stat SET uv_yesterday=0,pv_yesterday=0,ip_yesterday=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE short_url_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_yesterday = ss.uv, se.pv_yesterday = ss.pv, se.ip_yesterday = ss.ip\n WHERE se.url_id = ss.url_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id>0`, date1);\n  \n  /*总量统计：url记录今日数据*/\n  db2.exe(`UPDATE short_url_ex_stat SET uv_today=0,pv_today=0,ip_today=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE short_url_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_today = ss.uv, se.pv_today = ss.pv, se.ip_today = ss.ip\n WHERE se.url_id = ss.url_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id>0`, date0);\n\n  /*总量统计：url合计总数*/\n  db2.exe(`TRUNCATE TABLE _tmp_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_total_pv_uv_ip(obj_id,pv,uv,ip)\n SELECT url_id,SUM(pv) pv, SUM(uv) uv,SUM(ip) ip\n FROM stat_date_hour_pv_uv_ip WHERE log_date>=? AND log_hour=-1 AND url_id>0 GROUP BY url_id`, date30);\n\n    db2.exe(`UPDATE short_url_ex_stat SET uv_total=0,pv_total=0,ip_total=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE short_url_ex_stat u, _tmp_total_pv_uv_ip s\n  SET u.pv_total = s.pv, u.uv_total = s.uv, u.ip_total = s.ip\n WHERE u.url_id = s.obj_id`);\n\n\n\n  /*总量统计：tag记录昨日数据*/\n  db2.exe(`UPDATE track_tag_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_yesterday = ss.uv, se.pv_yesterday = ss.pv, se.ip_yesterday = ss.ip\n WHERE se.tag_id = ss.tag_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id=-1`, date1);\n \n  /*总量统计：tag记录今日数据*/\n  db2.exe(`UPDATE track_tag_ex_stat SET uv_today=0,pv_today=0,ip_today=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE track_tag_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_today = ss.uv, se.pv_today = ss.pv, se.ip_today = ss.ip\n WHERE se.tag_id = ss.tag_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id=-1`, date0);\n \n  /*总量统计：tag合计总数*/\n  db2.exe(`TRUNCATE TABLE _tmp_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_total_pv_uv_ip(obj_id,pv,uv,ip)\n SELECT tag_id,SUM(pv) pv, SUM(uv) uv,SUM(ip) ip\n FROM stat_date_hour_pv_uv_ip WHERE log_date>=? AND log_hour=-1 AND url_id=-1 GROUP BY tag_id`,date30);\n  \n  db2.exe(`UPDATE track_tag_ex_stat u, _tmp_total_pv_uv_ip s\n  SET u.pv_total = s.pv, u.uv_total = s.uv, u.ip_total = s.ip\n WHERE u.tag_id = s.obj_id`);\n}\n\nstat_url();\nstat_url_sum();\n\nreturn \'OK\';\n', '统计URL数据', 8, '2020-06-15 12:43:25', '2021-04-05 13:56:24', 191, '2m', 0, 166772, '2020-06-15 12:11:24', '2020-08-19 12:03:10', NULL);
INSERT INTO `paas_file` VALUES (176, 1, 'sponge_track', '', '/sponge_track/stat_url_track', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nlet date1  = Datetime.Now().addDay(-1).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY),\'%Y%m%d\')\nlet date30 = Datetime.Now().addDay(-30).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -30 DAY),\'%Y%m%d\')\nlet date0  = Datetime.Now().getDate(); //$<SELECT DATE_FORMAT(NOW(),\'%Y%m%d\')\nlet dateX  = 0;\nlet hour0  = Datetime.Now().getHours();\n\n\nif(hour0>=4){\n  dateX = date0;\n}else{\n  dateX = date1;\n}\n\n\ndb2.exe(`DELETE FROM stat_track_date_hour_pv_uv_ip WHERE log_date>=?`, dateX);\n\nfunction stat_track(i) {\n /*url*/\n let url_ids = db2.exe(`list::SELECT url_id FROM short_url WHERE track_params_num>=?`, i).stream().map(m1 => m1.url_id).toArray();\n \n  if(url_ids){\n    for(let j in url_ids){\n        db2.exe(`INSERT INTO stat_track_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,vi,vd,uv,pv,ip)\n      SELECT url_id,tag_id,log_date,-1,${i},v${i},COUNT(DISTINCT user_key) uv,COUNT(*) pv,COUNT(DISTINCT log_ip_id) ip\n      FROM short_redirect_log_30d \n      WHERE log_date>=? AND url_id =?\n     GROUP BY url_id,log_date,v${i}`, dateX, url_ids[j]);\n      \n      \n      db2.exe(`INSERT INTO stat_track_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,vi,vd,uv,pv,ip)\n      SELECT url_id,tag_id,log_date,log_hour,${i},v${i},COUNT(DISTINCT user_key) uv,COUNT(*) pv,COUNT(DISTINCT log_ip_id) ip\n      FROM short_redirect_log_30d \n      WHERE log_date>=? AND url_id =?\n     GROUP BY url_id,log_date,log_hour,v${i}`, dateX, url_ids[j]);\n   }\n }\n\n /*tag*/\n let tag_ids = db2.exe(`list::SELECT tag_id FROM track_tag WHERE t_track_params_num>=${i}`).stream().map(m1 => m1.tag_id).toArray();\n if(tag_ids){\n    for(let j in tag_ids){\n        db2.exe(`INSERT INTO stat_track_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,vi,vd,uv,pv,ip)\n      SELECT -1,tag_id,log_date,-1,${i},v${i},COUNT(DISTINCT user_key) uv,COUNT(*) pv,COUNT(DISTINCT log_ip_id) ip\n      FROM short_redirect_log_30d \n      WHERE log_date>=? AND tag_id = ?\n      GROUP BY tag_id,log_date,v${i}`, dateX, tag_ids[j]);\n    }\n }\n}\n\nfunction stat_track_sum(){\n\n  /*url total*/\n db2.exe(`TRUNCATE short_url_ex_track_stat`);\n  \n  db2.exe(`INSERT INTO short_url_ex_track_stat(url_id,tag_id,vi,vd,uv_total,pv_total,ip_total)\n  SELECT url_id,tag_id,vi,vd,SUM(uv) uv,SUM(pv) pv,SUM(ip) ip \n  FROM stat_track_date_hour_pv_uv_ip \n WHERE log_date>=? AND log_hour=-1 AND url_id>0\n  GROUP BY url_id,vi,vd`, date30);\n  \n  \n  /*url yesday*/\n  db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT url_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id>0`, date1);\n \n  db2.exe(`UPDATE short_url_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_yesterday = t.uv, s.pv_yesterday = t.pv, s.ip_yesterday = t.ip\n WHERE s.url_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n  \n  /*url today*/\n db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT url_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id>0`, date0);\n \n  db2.exe(`UPDATE short_url_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_today = t.uv, s.pv_today = t.pv, s.ip_today = t.ip\n WHERE s.url_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n  \n  \n  /*tag total*/\n db2.exe(`TRUNCATE track_tag_ex_track_stat`);\n  \n  db2.exe(`INSERT INTO track_tag_ex_track_stat(tag_id,vi,vd,uv_total,pv_total,ip_total)\n SELECT tag_id,vi,vd,SUM(uv) uv,SUM(pv) pv,SUM(ip) ip \n FROM stat_track_date_hour_pv_uv_ip \n WHERE log_date>=? AND log_hour=-1 AND url_id=-1\n GROUP BY tag_id,vi,vd`, date30);\n  \n  \n  /*tag yesday*/\n  db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT tag_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id=-1`, date1);\n  \n  db2.exe(`UPDATE track_tag_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_yesterday = t.uv, s.pv_yesterday = t.pv, s.ip_yesterday = t.ip\n WHERE s.tag_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n  \n  /*tag today*/\n db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT tag_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id=-1`, date0);\n  \n  db2.exe(`UPDATE track_tag_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_today = t.uv, s.pv_today = t.pv, s.ip_today = t.ip\n WHERE s.tag_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n}\n\nstat_track(1);\nstat_track(2);\nstat_track(3);\nstat_track(4);\nstat_track(5);\n\nstat_track_sum();\n\nreturn \'OK\';\n\n', '统计URL跟踪数据', 8, '2020-06-15 12:43:31', '2021-04-05 13:38:30', 529, '30m', 0, 11126, '2020-06-15 12:11:41', '2020-08-19 12:13:02', NULL);
INSERT INTO `paas_file` VALUES (177, 1, 'sponge_track', '', '/sponge_track/udp_user_agen_p_c', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let db2 = water.db(\'sponge/sponge_track\');\n\nvar begin_id = 0;\n\nvar list1 = db2.exe(`list::SELECT * FROM code_enum WHERE type=1 AND keyword<>\'\' ORDER BY row_id ASC`);\nvar list2 = db2.exe(`list::SELECT * FROM code_enum WHERE type=2 AND keyword<>\'\' ORDER BY row_id ASC`);\n\n/*生成平台码*/\nfor(var idx in list1){\n  var m = list1[idx];\n  \n}\n\nfor(var idx in list1){\n  var m = list1[idx];\n  var kl = m.keyword.split(\'#\');\n  for(var jdx in kl){\n var k2 = kl[jdx];\n db2.exe(`UPDATE code_ua SET platform=? WHERE ua_id>? AND platform=0 AND ua_val LIKE ?`, m.value, begin_id, k2);\n  }\n}\n\n\n\n/*生成客户端码（部份）*/\nfor(var idx in list2){\n  var m = list2[idx];\n  var kl = m.keyword.split(\'#\');\n  for(var jdx in kl){\n var k2 = kl[jdx];\n    db2.exe(`UPDATE code_ua SET client=? WHERE ua_id>? AND client=0 AND ua_val LIKE ?`, m.value, begin_id, k2);\n  }\n}\n\n\nreturn \'OK\';\n', '生成UDP数据', 8, '2020-06-15 12:43:37', '2021-04-05 13:48:37', 16, '10m', 0, 33420, '2020-06-15 12:11:59', '2021-05-08 18:04:04', NULL);
INSERT INTO `paas_file` VALUES (178, 0, 'sdk_water', '', '/sdk_water/_test_ip.jsx', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'return ctx.ip();', '', 0, NULL, NULL, 0, '', 0, 0, '2020-06-19 15:12:06', '2020-06-19 15:12:15', NULL);
INSERT INTO `paas_file` VALUES (187, 2, 'water', '', '/water/jenkins_config', 0, 0, 1, 0, 0, NULL, 'freemarker', '', '<?xml version=\'1.0\' encoding=\'UTF-8\'?>\n<project>\n    <actions/>\n    <description></description>\n    <keepDependencies>false</keepDependencies>\n    <properties>\n        <hudson.model.ParametersDefinitionProperty>\n            <parameterDefinitions>\n                <hudson.model.StringParameterDefinition>\n                    <name>qq</name>\n                    <description>qqq</description>\n                    <defaultValue>qqq</defaultValue>\n                </hudson.model.StringParameterDefinition>\n            </parameterDefinitions>\n        </hudson.model.ParametersDefinitionProperty>\n    </properties>\n    <scm class=\"hudson.plugins.git.GitSCM\" plugin=\"git@3.3.0\">\n        <configVersion>2</configVersion>\n        <userRemoteConfigs>\n            <hudson.plugins.git.UserRemoteConfig>\n                <url>https://github.com/bingyue/easy-springmvc-maven.git</url>\n            </hudson.plugins.git.UserRemoteConfig>\n        </userRemoteConfigs>\n        <branches>\n            <hudson.plugins.git.BranchSpec>\n                <name>*/master</name>\n            </hudson.plugins.git.BranchSpec>\n        </branches>\n        <doGenerateSubmoduleConfigurations>false</doGenerateSubmoduleConfigurations>\n        <submoduleCfg class=\"list\"/>\n        <extensions/>\n    </scm>\n    <canRoam>true</canRoam>\n    <disabled>false</disabled>\n    <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>\n    <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>\n    <triggers/>\n    <concurrentBuild>false</concurrentBuild>\n    <builders>\n        <hudson.tasks.Shell>\n            <command>\n                echo &quot;hello world!&quot;;\n                M3_HOME=/Users/admin/Documents/tool/maven\n                PATH=$PATH:$M3_HOME/bin\n                JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_25.jdk/Contents/Home\n                export M3_HOME;\n                export PATH;\n                export JAVA_HOME;\n                echo ${qq};\n                mvn clean install -U;\n            </command>\n        </hudson.tasks.Shell>\n    </builders>\n    <publishers/>\n    <buildWrappers/>\n</project>', '', 0, NULL, NULL, 0, '', 0, 0, '2020-07-03 14:21:11', '2020-07-03 14:25:46', NULL);
INSERT INTO `paas_file` VALUES (188, 2, '_code', '', '/_code/java_crud_xml_template', 0, 1, 1, 0, 0, NULL, 'freemarker', '', 'INSERT INTO `group_buying` (\n<#list fields!! as f>\n`${(f.field)!}`,\n</#list>\n) VALUES(\n<#list fields!! as f>\n@{${(f.field)!}:${(f.type)!}} ,\n</#list>\n)', '', 0, NULL, NULL, 0, '', 0, 0, '2020-07-08 10:43:15', '2020-07-08 10:53:54', NULL);
INSERT INTO `paas_file` VALUES (202, 0, '_demo', '', '/_demo/message_sub', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let act = ctx.param(\'act\');\n\nlet service = \'\';           //服务名\nlet service_secretKey=\'\';   //服务签名密钥\n\nlet receiver_url =  water.cfg(\'water/paas_uri\').value + ctx.path(); //接收地址，根据情况调整\nlet alarm_mobile=\'\';\nlet receive_way = 0;\nlet topics = [\'\'];\n\nif(act === \'sub\'){\n    //订阅消息 //String subscriber_key, String receiver_url, String access_key, String alarm_mobile, int receive_way, boolean is_unstable, String... topics\n    WaterClient.Message.subscribeTopic(service,receiver_url,service_secretKey,alarm_mobile,false,0,topics);\n    return \'OK\';\n}\n\nif(act === \'unsub\'){\n    //取消订阅 //String subscriber_key, String... topics\n    WaterClient.Message.unSubscribeTopic(service,topics);\n    return \'OK\';\n}\n\n\n//接收并处理消息 //msg:{id,times,key,topic,message,sgin}\nlet result = WaterClient.Message.receiveMessage(k => ctx.param(k), service_secretKey, msg => {\n    //msg.message;\n    return false; \n});\n\n\nreturn result;\n\n//return receiver_url;', '示例', 0, NULL, NULL, 0, '', 0, 0, '2020-08-04 14:53:38', '2020-08-12 15:28:16', NULL);
INSERT INTO `paas_file` VALUES (267, 2, '_ops', '', '/_ops/peapi.sh', 0, 1, 1, 0, 0, NULL, 'sh', 'text/plain', '#!/usr/bin/bash\n\nname=\"pepperapi\"\ndpdir=/data/sss/pepper.zmapi.cn\n\nbackup(){\nbackuptime=$(date \'+%Y%m%d_%H:%M:%S\')\nbackupdir=\"/data/backup/$name/$backuptime\"\nmkdir -p \"${backupdir}\"\nscp $host:${dpdir}/pepperapi.jar ${backupdir}\n}\n\ndeploy(){\nrsync -avz --delete pepperapi.jar ${host}:${dpdir}\nssh -t root@${host} <<EOF\nsed -i \'/127.0.0.1:8081/s/^.*$/    server 127.0.0.1:8081 down;/g\'  /data/_nginx.conf/pepper.zmapi.cn \nnginx -s reload\nsleep 7\nsystemctl restart pepperapi1\nwhile :\n    do\n        curl -m 3 -sI  \"http://127.0.0.1:8081/run/check/\" | grep 200\n        if [[ $? -eq 0 ]]\n            then\n            echo \"service1 is ok\"\n            break\n        fi\n        sleep 3\n    done\nsleep 3\nsed -i \'/127.0.0.1:8081/s/^.*$/    server 127.0.0.1:8081 weight=10;/g\'  /data/_nginx.conf/pepper.zmapi.cn\nsed -i \'/127.0.0.1:8082/s/^.*$/    server 127.0.0.1:8082 down;/g\'  /data/_nginx.conf/pepper.zmapi.cn\nnginx -s reload\nsleep 7\nsystemctl restart pepperapi2\nwhile :\n    do\n        curl -m 3 -sI  \"http://127.0.0.1:8082/run/check/\" | grep 200\n        if [[ $? -eq 0 ]]\n            then\n            echo \"service2 is ok\"\n            break\n        fi\n        sleep 3\n    done\nsleep 3\nsed -i \'/127.0.0.1:8082/s/^.*$/    server 127.0.0.1:8082 weight=10;/g\'  /data/_nginx.conf/pepper.zmapi.cn\nnginx -s reload\nEOF\n}\n\nhost=api\nbackup\n\nfor host in  {api,api2}\ndo\ndeploy\ndone\nif [[ $? -eq 0 ]]\n    then\n    curl \"http://water2/run/push/?target=@alarm&msg=pepperapi发布成功\"\n    else\n    curl \"http://water2/run/push/?target=@alarm&msg=pepperapi发布失败\"\n    break\nfi\n\nrm -rf ${name}.jar\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-09-01 15:27:15', '2020-09-01 15:29:56', NULL);
INSERT INTO `paas_file` VALUES (268, 2, '_ops', '', '/_ops/rockrpc.sh', 0, 1, 1, 0, 0, NULL, 'sh', 'text/plain', '#!/usr/bin/bash\n\nname=\"rockrpc\"\ndpdir=/data/sss/water.zmapi.cn\n\nbackup(){\nbackuptime=$(date \'+%Y%m%d_%H:%M:%S\')\nbackupdir=\"/data/backup/$name/$backuptime\"\nmkdir -p \"${backupdir}\"\nscp $host1:${dpdir}/rockrpc.jar ${backupdir}\n}\n\ndeploy(){\nrsync -avz --delete rockrpc.jar ${host}:${dpdir}\nssh -t root@${host} <<EOF\nip=$(ip addr |grep inet |grep -v inet6 |grep eth0 | awk \'{print $2}\' | awk -F \"/\" \'{print $1}\')\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8085,0\nsleep 2\nsystemctl restart rockrpc1\nsleep 2\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8085,1\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8086,0\nsleep 2\nsystemctl restart rockrpc2\nsleep 2\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8086,1\nEOF\n}\n\nhost=water\nbackup\n\nfor host in  {waterapi,waterapi2}\ndo\ndeploy\ndone\nif [[ $? -eq 0 ]]\n    then\n    curl \"http://water2/run/push/?target=@alarm&msg=rockrpc发布成功\"\n    else\n    curl \"http://water2/run/push/?target=@alarm&msg=rockrpc发布失败\"\n    break\nfi\n\nrm -rf ${name}.jar\n', '', 0, NULL, NULL, 0, '', 0, 0, '2020-09-01 15:28:15', '2021-05-17 17:03:18', NULL);
INSERT INTO `paas_file` VALUES (281, 0, 'sponge_track', '', '/sponge_track/get.original.url', 0, 0, 1, 1, 0, NULL, 'javascript', '', 'let tag_id= ctx.paramAsInt(\"tag_id\",0);\nlet url_partner_key=ctx.param(\"url_partner_key\");\n\n\nvar value =water.db(\"sponge/sponge_track\")\n                .table(\"short_url\")\n         .where(\" tag_id= ?\",tag_id)\n                .and(\"url_partner_key = ?\", url_partner_key)\n                .limit(1)\n                .select(\"url_val\")\n                .getValue();\nreturn {code:1,msg:\"success\",url:value};', '获取短地址的原始连接', 0, NULL, NULL, 0, '', 0, 0, '2020-10-10 10:58:41', '2020-10-10 11:28:52', NULL);
INSERT INTO `paas_file` VALUES (321, 1, 'water', '', '/water/log_del_15d_bef', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let list = water.db(\"water/water\")\n                .sql(\"SELECT logger_id,tag,logger,keep_days,DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -keep_days DAY),\'%Y%m%d\') date FROM water_cfg_logger\")\n                .getMapList();\n\nlet hub = Java.type(\'org.noear.water.protocol.ProtocolHub\');\nlet map = {};\n\nfor(let i in list){\n    let m = list[i];\n    \n    try{\n        let timecount = new Timecount().start();\n        let num = hub.logQuerier.clear(m.logger, m.keep_days, 100000);\n        map[m.logger] = num;\n        \n        XUtil.log(`${m.logger} deleted : ${num} - ${timecount.stop().milliseconds()}ms`);\n    }catch(err){\n      XUtil.log(err);\n    }\n}\n\nreturn map;', '日志-删除过期的数据', 9, '2020-01-17 12:54:28', '2021-05-28 16:54:27', 70, '1h', 0, 784, '2020-01-17 12:54:41', '2021-05-07 17:57:22', NULL);
INSERT INTO `paas_file` VALUES (322, 1, 'water', '', '/water/msg_del_3d', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'var date3 = Datetime.Now().addDay(-3).getDate();\n\nvar hub = Java.type(\'org.noear.water.protocol.ProtocolHub\');\n\n//删除\n//\nhub.messageSource().clear(date3);\n\nreturn \"ok\";', '消息清理和统计', 9, '2020-01-17 13:12:59', '2021-05-28 17:13:00', 36, '1h', 0, 818, '2020-01-17 13:13:00', '2021-04-24 00:16:01', NULL);
INSERT INTO `paas_file` VALUES (323, 1, 'water', '', '/water/msg_reset', 0, 0, 1, 0, 0, NULL, 'javascript', '', '// var currTime = new Datetime().getTicks();\n// var timeOuts = 1000 * 30; //30s\n// var refTime  = currTime - timeOuts;\n\n// var db2 = water.db(\"water/water_msg\");\n// var rst = 0;\n\n// if(db2.table(\'water_msg_message\').whereEq(\"state\",1).andLt(\"dist_nexttime\",refTime).exists()){\n//     rst = db2.table(\'water_msg_message\')\n//        .set(\'state\',0)\n//        .whereEq(\"state\",1).andLt(\"dist_nexttime\",refTime)\n//        .update();\n       \n//     XUtil.log(\"reset-\"+rst);\n// }\n\nlet hub = Java.type(\'org.noear.water.protocol.ProtocolHub\');\n\nlet rst = hub.messageSource().reset(30);\n\nXUtil.log(\"reset-\"+rst);\n\n//db2.exe(`UPDATE water_msg_message SET state=0  WHERE state=1 AND (dist_nexttime -${currTime})<-${timeOuts}`);\n\nreturn \"ok\" + rst;', '消息异常重置', 9, '2020-01-17 13:39:05', '2021-05-28 17:48:07', 5, '1m', 0, 8810, '2020-01-17 13:23:52', '2021-03-09 17:26:49', NULL);
INSERT INTO `paas_file` VALUES (324, 1, 'water', '', '/water/speed_del_30', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let d1 = new Datetime().addDay(-3).getDate();\nlet d2 = new Datetime().addDay(-3).getDate();\nlet d3 = new Datetime().addDay(-30).getDate();\n\nlet db1= water.db(\'water/water\');\n\ndb1.exe(`DELETE FROM water_reg_service_speed WHERE DATE(last_updatetime)<?`, d1);\ndb1.exe(`DELETE FROM water_reg_service_speed_date WHERE log_date <?`, d2);\ndb1.exe(`DELETE FROM water_reg_service_speed_hour WHERE log_date <?`, d3);\n\nreturn \'OK\';\n', '接口性能-删除超时的记录', 9, '2020-05-06 00:00:00', '2021-05-28 17:00:00', 95, '1h', 0, 918, '2020-05-06 09:35:44', '2021-04-24 21:17:49', NULL);
INSERT INTO `paas_file` VALUES (328, 1, 'water', '', '/water/speed_sync_ref', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'var date = new Datetime().getDate();\n\nvar db2 = water.db(`water/water`);\n\ndb2.exe(`UPDATE water_reg_service_speed s,water_reg_service_speed_date d\n            SET s.average_ref = d.average\n            WHERE d.log_date=? AND s.service = d.service AND s.tag = d.tag AND s.name_md5 = d.name_md5`, date);\n\n\nreturn \'OK\';', '接口性能-数据引用同步', 9, '2020-05-06 00:00:00', '2021-05-28 17:47:00', 9, '5m', 0, 9778, '2020-05-06 09:39:17', '2021-03-26 15:38:05', NULL);
INSERT INTO `paas_file` VALUES (330, 1, 'water', '', '/water/server_bls_track_pull', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'water.call(\"wateradmin\",\"mot/bls/track/ajax/pull\");\n\nreturn \'OK\';', '拉取bls的指标数据', 9, '2020-05-06 00:00:00', '2021-05-28 17:40:00', 2135, '10m', 0, 4644, '2020-05-06 10:19:27', '2020-05-06 10:33:53', NULL);
INSERT INTO `paas_file` VALUES (331, 1, 'water', '', '/water/server_dbs_track_pull', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'water.call(\"wateradmin\",\"mot/dbs/track/ajax/pull\");\nwater.call(\"wateradmin\",\"mot/dbs/mencache/track/ajax/pull\");\nwater.call(\"wateradmin\",\"mot/dbs/redis/track/ajax/pull\");\n\nreturn \'OK\';', '拉取dbs的指标数据', 9, '2020-05-06 00:00:00', '2021-05-28 17:40:00', 2905, '10m', 0, 4644, '2020-05-06 10:20:18', '2020-05-06 10:34:44', NULL);
INSERT INTO `paas_file` VALUES (332, 1, 'water', '', '/water/server_ecs_sev_num_stat', 0, 0, 1, 0, 0, NULL, 'javascript', '', ' let db1 = water.db(\'water/water\');\n \n var list = db1.sql(\"SELECT server_id,address_local ip FROM water_ops_server WHERE iaas_type=0 AND address_local!=\'\'\").getMapList();\n \n for(let i in list){\n   let m = list[i];\n   let num = db1.sql(`SELECT COUNT(*) num FROM water_reg_service WHERE address LIKE ?`, `${m.ip}:%`).getValue(); \n   db1.exe(`UPDATE water_ops_server SET sev_num =? WHERE server_id=?`, num, m.server_id);       \n }\n \n \n return \'OK\';', '统计服务器的服务数量', 9, '2020-05-06 00:00:00', '2021-05-28 17:00:00', 61, '1h', 0, 918, '2020-05-06 10:21:19', '2021-04-22 23:45:55', NULL);
INSERT INTO `paas_file` VALUES (333, 1, 'water', '', '/water/server_ecs_track_pull', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'water.call(\'wateradmin\',\'mot/ecs/track/ajax/pull\');\n\nreturn \'OK\';', '拉取ecs的指标数据', 9, '2020-05-06 00:00:00', '2021-05-28 17:00:00', 614, '1h', 0, 887, '2020-05-06 10:21:28', '2020-05-06 10:35:23', NULL);
INSERT INTO `paas_file` VALUES (334, 1, 'water', '', '/water/_service_disable_auto', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2 = water.db(\'water/water\');\n\n//\n//分开执行，可以用到索引，进而不用锁全表\n//\ndb2.exe(`\nUPDATE water_reg_service SET is_enabled=0 \nWHERE (address LIKE ?) AND check_last_state=1`, \'192.%\');\n\n\ndb2.exe(`\nUPDATE water_reg_service SET is_enabled=0 \nWHERE (address LIKE ?) AND check_last_state=1`, \'169.%\');\n\n\ndb2.exe(`\nUPDATE water_reg_service SET is_enabled=0 \nWHERE (address LIKE ?) AND check_last_state=1`, \'10.37.%\');\n\n\nreturn \'OK\';', '', 9, '2020-05-17 00:00:00', '2021-05-28 17:48:01', 12, '2m', 0, 5814, '2020-05-17 07:35:34', '2020-08-19 11:49:27', NULL);
INSERT INTO `paas_file` VALUES (335, 1, 'water', '', '/water/_msg_subscriber_disable_auto', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2 = water.db(\'water/water_msg\');\n\n//禁用操作\n\n//内网IP\n//\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,\'%//192.%\');\n\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,\'%//169.%\');\n\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,\'%//10.37.%\');\n\n//本机IP\n//\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,\'%//0:0:%\');\n\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,\'%//127.0%\');\n\n\n//删除操作（放在禁用之后）\n\n//IP注册的，坏了的（一般是water内部消息）\n//\ndb2.exe(`DELETE FROM water_msg_subscriber \nWHERE is_enabled=1 AND check_last_state=1 AND check_error_num > 4 AND LENGTH(subscriber_note) > 0`);\n\nreturn \"OK\";', '消息-删除无意义的内网订阅者', 9, '2020-05-17 00:00:00', '2021-05-28 17:48:01', 18, '2m', 0, 5814, '2020-05-17 07:38:35', '2020-08-19 11:48:31', NULL);
INSERT INTO `paas_file` VALUES (336, 1, 'water', '', '/water/raas_sync_log2all', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2 = water.db(\'water/water_log\');\n\nvar date = Datetime.Now().addDay(-2).getDate(); // SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -2 DAY),\'%Y%m%d\')\n\ndb2.exe(`INSERT INTO rubber_log_request_all\nSELECT * FROM rubber_log_request WHERE log_date=?`, date);\n\n\nreturn \'OK\';', '将处理日志同步到总表（处理表只保持30天）', 9, '2020-06-15 00:00:00', '2021-05-28 00:00:00', 304, '1d', 0, 42, '2020-06-15 12:54:13', '2020-08-19 12:15:35', NULL);
INSERT INTO `paas_file` VALUES (337, 1, 'water', '', '/water/_service_consumer_del_7d', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let date = Datetime.Now().addDay(-7).getFulltime();\n\nlet db2 = water.db(\'water/water\');\n\ndb2.table(\'water_reg_consumer\')\n   .where(\'chk_fulltime < ?\',date)\n   .delete();\n     \n     \nreturn \'OK\';', '网关-删除7天没活跃的消息者记录', 9, '2020-06-15 00:00:00', '2021-05-28 17:00:00', 46, '1h', 0, 917, '2020-06-15 16:10:06', '2020-07-03 11:23:41', NULL);
INSERT INTO `paas_file` VALUES (338, 1, 'water', '', '/water/msg_persistence', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'var db = water.db(\"water/water_msg\");\n\nvar date90 = Datetime.Now().addDay(-90).getDate();\nvar date2 = Datetime.Now().addDay(-2).getDate();\n\nvar hub = Java.type(\'org.noear.water.protocol.ProtocolHub\');\n\nhub.messageSource().persistence(date2,date90);\n\nreturn \"ok\";', '消息持久化处理', 9, '2020-06-29 03:00:00', '2021-05-28 02:59:59', 216, '1d', 0, 37, '2020-06-30 11:12:48', '2021-04-24 18:23:23', NULL);
INSERT INTO `paas_file` VALUES (339, 1, 'water', '', '/water/_service_consumer_sync', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2 = water.db(\'water/water\');\n\ndb2.exe(`UPDATE water_reg_consumer c, water_reg_service s \n            SET c.chk_fulltime = s.check_last_time,\n                c.chk_last_state = s.check_last_state,\n                c.is_enabled = s.is_enabled\n          WHERE c.consumer_address = s.address`);\n          \n          \nreturn \'OK\';', '网关-同步消费者记录', 9, '2020-07-03 00:00:00', '2021-05-28 17:48:01', 7, '1m', 0, 4683, '2020-07-03 10:16:56', '2020-07-06 10:09:40', NULL);
INSERT INTO `paas_file` VALUES (340, 1, 'water', '', '/water/log_alarm', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let list = water.db(\"water/water\")\n                .sql(\"SELECT logger_id,tag,logger,source FROM water_cfg_logger WHERE is_alarm=1\")\n                .getMapList();\n                \n\nlet alarm_sign = XUtil.cfgGet(\'water/alarm_sign\');\n\nlet date1 = Datetime.Now().getDate();\nlet hub = Java.type(\'org.noear.water.protocol.ProtocolHub\');\n                \nfor(let m of list){\n    \n    try{\n        let key2 = \"log_num__\" + m.logger;\n        let num2_old = XUtil.cfgGet(key2);\n        \n        let num2 = hub.logQuerier.stat(m.logger,5,date1);\n        \n        if(num2){\n            if(!num2_old || (parseInt(num2_old) != num2)){\n                let msg = `预警：错误日志数量::${num2}\\\\n\\\\n[${m.logger}][${alarm_sign}]`;\n                \n                water.heihei(\'@alarm\',msg);\n                \n                XUtil.cfgSet(key2, num2+\'\');\n            }\n        }\n        \n    }catch(err){\n      XUtil.log(err);\n    }\n}\n\nreturn \'OK\';', '日志-检查错误数量并告警', 9, '2020-07-22 00:00:00', '2021-05-28 17:48:01', 8, '1m', 0, 4679, '2020-07-23 14:12:33', '2021-04-22 13:39:00', NULL);
INSERT INTO `paas_file` VALUES (341, 1, 'water', '', '/water/_service_runtime_pull', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2 = water.db(\"water/water\");\n\nlet serivers = db2.table(\"water_reg_service\").whereEq(\"check_type\",0).andEq(\'is_enabled\',1).select(\"key,name,address\").getMapList();\nlet datetime = Datetime.Now();\n\nfor(let s1 of serivers){\n   let rst_str = water.call(\"wateradmin\",\"mot/service/check\",{\"s\":`${s1.name}@${s1.address}`});\n\n   if(rst_str && rst_str.startsWith(\"{\")){\n       let rst = JSON.parse(rst_str);\n\n       if(rst.data){\n          rst = rst.data;\n       }\n       \n       db2.table(\"water_reg_service_runtime\")\n          .set(\"key\",s1.key)\n          .set(\"name\",s1.name)\n          .set(\"address\",s1.address)\n          .set(\"log_date\",datetime.getDate())\n          .set(\"log_hour\",datetime.getHours())\n          .set(\"log_minute\",datetime.getMinutes())\n          .set(\"log_fulltime\",\"$NOW()\")\n          .set(\"memory_max\", rst.memoryMax)\n          .set(\"memory_total\", rst.memoryTotal)\n          .set(\"memory_used\", rst.memoryUsed)\n          .set(\"thread_peak_count\", rst.threadPeakCount)\n          .set(\"thread_count\", rst.threadCount)\n          .set(\"thread_daemon_count\", rst.threadDaemonCount)\n          .insertBy(\"key,log_date,log_hour,log_minute\");\n   }\n}\n\nreturn \"OK\";', '服务-运行时信息拉取', 9, '2020-09-14 09:56:59', '2021-05-28 17:47:00', 104, '5m', 0, 8039, '2020-09-14 09:29:30', '2020-09-26 12:10:17', NULL);
INSERT INTO `paas_file` VALUES (342, 1, 'water', '', '/water/_service_runtime_15d_del', 0, 0, 1, 0, 0, NULL, 'javascript', '', ' var db2 = water.db(\"water/water\");\n var date = Datetime.Now().addDay(-15).getDate();\n \n db2.table(\"water_reg_service_runtime\").where(\'log_date<?\',date).delete();\n\n\n return \'OK\';', '服务-运行时信息超时删除', 9, '2021-01-20 00:00:00', '2021-05-28 17:00:00', 84, '1h', 0, 915, '2021-01-20 14:41:39', '2021-01-20 14:43:40', NULL);
INSERT INTO `paas_file` VALUES (343, 1, 'water', '', '/water/msg_stat_sync', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2= water.db(\'water/water\');\nlet db3= water.db(\'water/water_msg\');\n\nlet date = Datetime.Now();\n\nlet yesterday = date.addDay(-1).getDate();\n\n\nlet list1 = db2.exe(\"list::SELECT name, total_num FROM water_reg_service_speed WHERE service=? AND TAG=?\",\'_watermsg\',\'topic\');\nlet list2 = db2.exe(\"list::SELECT name, total_num FROM water_reg_service_speed_date WHERE service=? AND TAG=? AND log_date=?\",\'_watermsg\',\'topic\',yesterday);\n\nfor(let m of list1){\n    db3.table(\'water_msg_topic\')\n       .set(\'stat_msg_day_num\',m.total_num)\n       .whereEq(\'topic_name\',m.name)\n       .update();\n}\n\nfor(let m of list2){\n    db3.table(\'water_msg_topic\')\n       .set(\'stat_msg_day_num\',\'$stat_msg_day_num+\'+m.total_num)\n       .whereEq(\'topic_name\',m.name)\n       .update();\n}\n\nreturn \'OK\';\n\n', '消息统计同步', 9, '2021-04-24 00:00:00', '2021-05-28 17:40:00', 13, '10m', 0, 4786, '2021-04-24 18:24:43', '2021-05-28 17:45:34', NULL);
INSERT INTO `paas_file` VALUES (344, 1, 'water', '', '/water/log_stat_sync', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let db2= water.db(\'water/water\');\nlet date = Datetime.Now();\n\nlet yesterday = date.addDay(-1).getDate();\nlet beforeday = date.addDay(-1).getDate();\n\nlet list1 = db2.exe(\"list::SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed WHERE service=? AND TAG=?\",\'waterlog\',\'logger\');\nlet list2 = db2.exe(\"list::SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed_date WHERE service=? AND TAG=? AND log_date=?\",\'waterlog\',\'logger\',yesterday);\nlet list3 = db2.exe(\"list::SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed_date WHERE service=? AND TAG=? AND log_date=?\",\'waterlog\',\'logger\',beforeday);\n\n\nfor(let m of list1){\n    db2.table(\'water_cfg_logger\')\n       .set(\'row_num_today\',m.total_num)\n       .set(\'row_num_today_error\',m.total_num_slow5)\n       .whereEq(\'logger\',m.name)\n       .update();\n}\n\nfor(let m of list2){\n    db2.table(\'water_cfg_logger\')\n       .set(\'row_num_yesterday\',m.total_num)\n       .set(\'row_num_yesterday_error\',m.total_num_slow5)\n       .whereEq(\'logger\',m.name)\n       .update();\n}\n\nfor(let m of list3){\n    db2.table(\'water_cfg_logger\')\n       .set(\'row_num_beforeday\',m.total_num)\n       .set(\'row_num_beforeday_error\',m.total_num_slow5)\n       .whereEq(\'logger\',m.name)\n       .update();\n}\n\nreturn \'OK\';\n\n', '日志统计同步', 9, '2021-04-24 00:00:00', '2021-05-28 17:40:00', 13, '10m', 0, 4785, '2021-04-24 19:21:04', '2021-04-27 10:46:59', NULL);
INSERT INTO `paas_file` VALUES (345, 1, 'water', '', '/water/speed_sync', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let util = requireX(\'/water/speed_sync.fun\');\n\nlet rd = water.rd(\'water/water_redis\',5);\n\nlet rlist = rd.open1(function(ru){\n  return ru.key(\'monitor_keys\').hashGetAll();\n});\n\nvar jlist = [];\nrlist.forEach(function(k,v){\n  jlist.push(k);\n});\n\nXUtil.log(\'monitor_keys.size = \' + jlist.length);\n\nlet now = new Datetime();\n\nlet log_date = now.toString(\'yyyyMMdd\');\n\nfor(let i in jlist){\n  let ikey = jlist[i];\n  let dkey = ikey +\'$\'+ log_date;\n  \n  let dd = rd.open1((ru)=>{\n  return ru.key(dkey).hashGetAll();\n  });\n  \n  if(dd && dd.size()>0){\n    let ss = ikey.split(\'$\');\n    let mm = util.map2json(dd);\n    \n    mm.service = ss[0];\n    mm.tag = ss[1];\n    mm.name_md5 = ss[2];\n    mm.name = WaterClient.Track.getName(mm.name_md5);\n    mm.name_md5 = WaterClient.Track.getNameMd5(mm.name_md5);//兼容旧的数据\n    mm.log_fulltime = rlist.get(ikey);\n\n    if(mm.name && mm.name.length > 900){\n      mm.name = mm.name.substr(0,900);\n    }\n\n  \n    if(mm.service && mm.service != \'null\'){\n        util.speed_log(mm);\n    }\n  }\n}\n\n\nreturn \'OK\';\n\n', '接口性能-从Reids同步概况数据', 9, '2020-05-06 08:00:00', '2021-05-28 17:40:00', 284, '10m', 0, 4323, '2020-05-06 17:38:45', '2021-04-27 22:51:59', NULL);
INSERT INTO `paas_file` VALUES (346, 1, 'water', '', '/water/speed_sync_date', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let util = requireX(\'/water/speed_sync.fun\');\n\nlet rd = water.rd(\'water/water_redis\',5);\n\nlet rlist = rd.open1(function(ru){\n  return ru.key(\'monitor_keys\').hashGetAll();\n});\n\nvar jlist = [];\nrlist.forEach(function(k,v){\n  jlist.push(k);\n});\n\nXUtil.log(\'monitor_keys.size = \' + jlist.length);\n\nlet now = new Datetime();\n\nlet log_date = now.toString(\'yyyyMMdd\');\n\n\nfor(var i in jlist){\n  let ikey = jlist[i];\n  let dkey = ikey +\'$\'+ log_date;\n  \n  let dd = rd.open1((ru)=>{\n return ru.key(dkey).hashGetAll();\n  });\n  \n  if(dd && dd.size()>0){\n    let ss = ikey.split(\'$\');\n    let mm = util.map2json(dd);\n    \n    mm.service = ss[0];\n    mm.tag = ss[1];\n    mm.name_md5 = ss[2];\n    mm.name = WaterClient.Track.getName(mm.name_md5);\n    mm.name_md5 = WaterClient.Track.getNameMd5(mm.name_md5);//兼容旧的数据\n    mm.log_date = log_date;\n\n    if(mm.name && mm.name.length > 900){\n      mm.name = mm.name.substr(0,900);\n    }\n  \n    if(mm.service && mm.service != \'null\'){\n        util.speed_log_date(mm);\n    }\n  }\n}\n\n\n\nreturn \'OK\';\n\n', '接口性能-从Reids同步日纬度数据', 9, '2020-05-06 08:00:00', '2021-05-28 17:40:00', 274, '10m', 0, 4323, '2020-05-06 17:38:56', '2021-04-27 22:52:09', NULL);
INSERT INTO `paas_file` VALUES (347, 1, 'water', '', '/water/speed_sync_hour', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let util = requireX(\'/water/speed_sync.fun\');\n\nlet rd = water.rd(\'water/water_redis\',5);\n\nlet rlist = rd.open1(function(ru){\n  return ru.key(\'monitor_keys\').hashGetAll();\n});\n\nvar jlist = [];\nrlist.forEach(function(k,v){\n  jlist.push(k);\n});\n\nXUtil.log(\'monitor_keys.size = \' + jlist.length);\n\nlet now = new Datetime();\n\nlet log_date = now.toString(\'yyyyMMdd\');\nlet log_hour = now.toString(\'HH\');\n\n\nfor(let i in jlist){\n  let ikey = jlist[i];\n  let dkey = ikey +\'$\'+ log_date + log_hour;\n  \n  let dd = rd.open1((ru)=>{\n  return ru.key(dkey).hashGetAll();\n  });\n  \n  if(dd && dd.size()>0){\n    let ss = ikey.split(\'$\');\n    let mm = util.map2json(dd);\n    \n    mm.service = ss[0];\n    mm.tag = ss[1];\n    mm.name_md5 = ss[2];\n    mm.name = WaterClient.Track.getName(mm.name_md5);\n    mm.name_md5 = WaterClient.Track.getNameMd5(mm.name_md5);//兼容旧的数据\n    mm.log_date = log_date;\n    mm.log_hour = log_hour;\n\n    if(mm.name && mm.name.length > 900){\n      mm.name = mm.name.substr(0,900);\n    }\n  \n    if(mm.service && mm.service != \'null\'){\n        util.speed_log_hour(mm);\n    }\n  }\n}\n\n\nreturn \'OK\';\n', '接口性能-从Reids同步时纬度数据', 9, '2020-05-06 08:00:00', '2021-05-28 17:40:00', 246, '10m', 0, 4323, '2020-05-06 17:39:05', '2021-04-27 22:53:15', NULL);
INSERT INTO `paas_file` VALUES (348, 1, 'water', '', '/water/speed_sync.fun', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'this.map2json = function (map){\n  var obj = {};\n  map.forEach(function(k,v){\n    obj[k] = v;\n  });\n  \n  return obj;\n}\n\n\n\nthis.speed_log = function(m){\n    if(!m.tag || !m.name || !m.average){\n       return \'ERROR\';\n    }\n    \n    if(!m.total_num_slow1){\n      m.total_num_slow1=0;\n    }\n    \n    if(!m.total_num_slow2){\n      m.total_num_slow2=0;\n    }\n    \n    if(!m.total_num_slow5){\n      m.total_num_slow5=0;\n    }\n    \n    if(!m.slowest){\n      m.slowest=0;\n    }\n    \n    if(!m.fastest){\n      m.fastest=0;\n    }\n    \n    water.db(\'water/water\')\n      .table(\'water_reg_service_speed\')\n      .set(\'average\',m.average).set(\'fastest\',m.fastest)\n      .set(\'slowest\',m.slowest).set(\'total_num\',m.total_num)\n      .set(\'service\',m.service)\n      .set(\'tag\',m.tag)\n      .set(\'name_md5\',m.name_md5)\n      .set(\'name\',m.name)\n      .set(\'total_num_slow1\',m.total_num_slow1)\n      .set(\'total_num_slow2\',m.total_num_slow2)\n      .set(\'total_num_slow5\',m.total_num_slow5)\n      .build(function(tb){\n        if(m.log_fulltime && m.log_fulltime.indexOf(\'-\')>0){\n        tb.set(\'last_updatetime\',m.log_fulltime);\n      }\n      })\n      .upsert(\'service,tag,name_md5\');\n    \n    return \'OK\';\n}\n\nthis.speed_log_date = function(m){\n    if(!m.tag || !m.name || !m.average || !m.log_date){\n       return \'ERROR\';\n    }\n    \n    if(!m.slowest){\n      m.slowest=0;\n    }\n    \n    if(!m.fastest){\n      m.fastest=0;\n    }\n    \n    if(m.total_time){\n       m.average = parseInt(m.total_time/m.total_num);\n    }\n    \n    water.db(\'water/water\')\n      .table(\'water_reg_service_speed_date\')\n      .set(\'average\',m.average).set(\'fastest\',m.fastest)\n      .set(\'slowest\',m.slowest).set(\'total_num\',m.total_num)\n      .set(\'service\',m.service)\n      .set(\'tag\',m.tag)\n      .set(\'name\',m.name)\n      .set(\'name_md5\',m.name_md5)\n      .set(\'log_date\',m.log_date)\n      .build(function(tb){\n        if(m.total_num_slow1){\n        tb.set(\'total_num_slow1\',m.total_num_slow1);\n      }\n      \n        if(m.total_num_slow2){\n       tb.set(\'total_num_slow2\',m.total_num_slow2);\n      }\n      \n        if(m.total_num_slow5){\n       tb.set(\'total_num_slow5\',m.total_num_slow5);\n      }\n      })\n      .upsert(\'service,tag,name_md5,log_date\');\n    \n    return \'OK\';    \n}\n\n\nthis.speed_log_hour = function(m){\n    if(!m.tag || !m.name || !m.average || !m.log_date || !m.log_hour){\n       return \'ERROR\';\n    }\n    \n    if(!m.slowest){\n      m.slowest=0;\n    }\n    \n    if(!m.fastest){\n      m.fastest=0;\n    }\n    \n    water.db(\'water/water\')\n      .table(\'water_reg_service_speed_hour\')\n      .set(\'average\',m.average).set(\'fastest\',m.fastest)\n      .set(\'slowest\',m.slowest).set(\'total_num\',m.total_num)\n      .set(\'service\',m.service)\n      .set(\'tag\',m.tag)\n      .set(\'name\',m.name)\n      .set(\'name_md5\',m.name_md5)\n      .set(\'log_date\',m.log_date)\n      .set(\'log_hour\',m.log_hour)\n      .build(function(tb){\n        if(m.total_num_slow1){\n       tb.set(\'total_num_slow1\',m.total_num_slow1);\n      }\n      \n        if(m.total_num_slow2){\n       tb.set(\'total_num_slow2\',m.total_num_slow2);\n      }\n      \n        if(m.total_num_slow5){\n       tb.set(\'total_num_slow5\',m.total_num_slow5);\n      }\n      })\n      .upsert(\'service,tag,name_md5,log_date,log_hour\');\n    \n    \n    return \'OK\';    \n}\n\n\n', '接口性能-公共函数', 0, NULL, NULL, 0, '1h', 0, 0, '2020-05-06 17:40:48', '2021-04-23 23:39:47', NULL);
INSERT INTO `paas_file` VALUES (349, 1, '_ops', '', '/_ops/test', 0, 0, 1, 0, 0, NULL, 'javascript', '', 'let num = Math.ceil(Math.random()*10);\n\nfor(let i=0; i<num; i++){\n    water.sendMessage(\"water.config.update\",\"_demo::test\");\n}\n\nreturn num;\n', '', 9, '2021-05-27 00:00:00', '2021-05-28 17:48:01', 48, '1m', 0, 2093, '2021-05-27 11:49:24', '2021-05-27 11:52:25', NULL);



SET FOREIGN_KEY_CHECKS = 1;
