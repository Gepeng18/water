[{"file_id":12,"file_type":2,"tag":"_code","label":"tml","path":"/_code/java_model","rank":-1,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"import lombok.Data;\nimport java.util.*;\n\n@Data\npublic class ${table_camel!}Do {\n    \n    <#list fields!! as f>\n    /** ${(f.comment)!} */\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n}","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200115182722,"update_fulltime":1647704190020,"use_whitelist":""},{"file_id":24,"file_type":2,"tag":"_code","label":"","path":"/_code/java_model_ibinder","rank":-1,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"import lombok.Getter;\nimport lombok.Setter;\nimport org.noear.wood.GetHandlerEx;\nimport org.noear.wood.IBinder;\nimport java.math.BigDecimal;\nimport java.util.*;\n\n@Getter\n@Setter\npublic class ${table_camel!}Model implements IBinder {\n    \n    <#list fields!! as f>\n /** ${(f.comment)!} */\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n    @Override\n public void bind(GetHandlerEx s) {\n        <#list fields as f>\n        ${(f.field)!} = s.get(\"${(f.field)!}\").value(${(f.def)!});\n        </#list>\n }\n \n  @Override\n public IBinder clone() {\n    return new ${table_camel!}Model();\n  }\n\n}","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144558,"update_fulltime":20200819161506,"use_whitelist":""},{"file_id":25,"file_type":2,"tag":"_code","label":"","path":"/_code/java_edit","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"public static void edit${table_camel!} (<#list fields!! as f>${(f.type)!} ${(f.field)!}<#sep>,\n                             </#sep></#list>) throws SQLException {\n                                 \n    DbTableQuery query = db().table(\"${tb!}\")<#list fields!! as f><#if (f.field)! != pri_key!>.set(\"${(f.field)!}\", ${(f.field)!})</#if><#sep>\n                             </#sep></#list>;\n\n    if (${pri_key!} > 0) {\n        query.where(\"${pri_key!} = ?\", ${pri_key!})\n             .update();\n    } else {\n        query.insert();\n    }\n\n}\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144629,"update_fulltime":20200117144637,"use_whitelist":""},{"file_id":26,"file_type":2,"tag":"_code","label":"","path":"/_code/java_edit2","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"public static void edit${table_camel!} (${table_camel!}Model m) throws SQLException {\n                                 \n    DbTableQuery qr = db().table(\"${tb!}\")\n                          .setEntity(m);\n\n    if (${pri_key!} > 0) {\n        qr.where(\"${pri_key!} = ?\", ${pri_key!})\n          .update();\n    } else {\n        qr.insert();\n    }\n\n}\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144651,"update_fulltime":20200117144702,"use_whitelist":""},{"file_id":27,"file_type":2,"tag":"_code","label":"","path":"/_code/java_crud","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"public static void save${table_camel!} (${table_camel!}Model m) throws Exception {\n                                 \n    DbTableQuery qr = db().table(\"${tb!}\")\n                          .setEntity(m);\n\n    if (m.${pri_key!} > 0) {\n        qr.where(\"${pri_key!} = ?\", m.${pri_key!})\n          .update();\n    } else {\n        qr.set(\"operator\",Session.current().getUserName())\n          .set(\"log_date\",Datetime.Now().getDate())\n          .set(\"log_fulltime\",Datetime.Now().getFullTime())\n          .insert();\n    }\n}\n\npublic static void del${table_camel!} (int ${pri_key!}) throws SQLException {\n                                 \n    db().table(\"${tb!}\")\n        .where(\"${pri_key!} = ?\", ${pri_key!})\n        .delete();\n}\n\npublic static ${table_camel!}Model get${table_camel!} (int ${pri_key!}) throws SQLException {\n                                 \n    return db().table(\"${tb!}\")\n              .where(\"${pri_key!} = ?\", ${pri_key!})\n              .orderBy(\"log_fulltime desc\")\n              .limit(1)\n              .select(\"*\")\n              .getItem(new ${table_camel!}Model());\n}\n\n\npublic static List<${table_camel!}Model> get${table_camel!}List (${table_camel!}Model m) throws SQLException {\n                                 \n    return db().table(\"${tb!}\")\n              .where(\"1=1\")\n              .orderBy(\"log_fulltime desc\")\n              .select(\"*\")\n              .getList(new ${table_camel!}Model());\n}\n\n\npublic static List<${table_camel!}Model> get${table_camel!}ListByPage (${table_camel!}Model m, PageModel pageModel) throws SQLException {\n                                 \n    DbTableQuery query = db().table(\"${tb!}\")\n                        .where(\"1=1\");\n    if (pageModel != null) {\n      int start = (pageModel.page - 1) * pageModel.pageSize;\n      DbTableQuery queryCount = query;\n      pageModel.setRowCount(queryCount.select(\"count(*)\").getCount());\n      return query\n          .orderBy(\"log_fulltime desc\")\n          .limit(start, pageModel.pageSize)\n          .select(\"*\")\n          .getList(new ${table_camel!}Model());\n    } else {\n      return query.orderBy(\"log_fulltime desc\").select(\"*\").getList(new ${table_camel!}Model());\n    }          \n}\n\n\n\nimport lombok.Getter;\nimport lombok.Setter;\n\n@Getter\n@Setter\npublic class PageModel {\n\n    public Integer page;\n    public Integer pageSize;\n    public long    rowCount;\n\n  public PageModel() { }\n\n  public PageModel(Integer page, Integer pageSize) {\n    this.page = (page == null || page == 0)?1:page;\n    this.pageSize = (pageSize == null || pageSize == 0)?10:pageSize;\n  }\n}\n\n\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144715,"update_fulltime":20200117144727,"use_whitelist":""},{"file_id":28,"file_type":2,"tag":"_code","label":"","path":"/_code/java_insert","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"import noear.wood.DbQueryProcedure;\nimport webapp.Config;\n\npublic class ${tb!}_add extends DbQueryProcedure {\n\n    <#list fields!! as f>\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n    public ${tb!}_add() {\n\n        super(Config.${key!});\n\n        sql(\"INSERT INTO `${tb!}` (<#list fields!! as f>`${(f.field)!}`<#sep>, </#sep></#list>)\" +\n            \" VALUES (<#list fields!! as f>@${(f.field)!}<#sep>,  </#sep></#list>);\");\n\n        <#list fields!! as f>\n        set(\"@${(f.field)!}\", () -> ${(f.field)!});\n        </#list>\n\n    }\n\n}\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144748,"update_fulltime":20200117144754,"use_whitelist":""},{"file_id":29,"file_type":2,"tag":"_code","label":"","path":"/_code/paas_stats_save","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"function insertOrUpdateResult(target_date, <#list fields!! as f><#if f.field != pri_key>${(f.field)!}<#sep>, </#sep></#if></#list>) {\n    <#list fields!! as f>\n    <#if f.field != pri_key>\n    if (!${f.field}) {\n    ${f.field} = 0;\n    }\n    </#if>\n    </#list>\n\n  var is_exist = water\n    .db(\"${tag}.${key}\")\n    .table(\"${tb}\")\n   .where(\"target_date = ?\", target_date)\n    .selectCount();\n \n  if (is_exist && 0 < is_exist) {\n   water\n            .db(\"${tag}.${key}\")\n            .table(\"${tb}\")\n            <#list fields!! as f>\n            <#if f.field != pri_key>\n            .set(\"${f.field}\", ${f.field})\n            </#if>\n            </#list>\n     .set(\"update_date\", now.getDate())\n      .set(\"update_fulltime\", now.getFulltime())\n      .where(\"target_date = ?\", target_date)\n      .update();\n  } else {\n    water\n            .db(\"${tag}.${key}\")\n            .table(\"${tb}\")\n            .set(\"${pri_key}\", rock.client.newID(\"${tag?upper_case}\", \"${tb}_id\", 315360000))\n            <#list fields!! as f>\n            <#if f.field != pri_key>\n            .set(\"${f.field}\", ${f.field})\n            </#if>\n            </#list>\n      .set(\"target_date\", target_date)\n            .set(\"create_date\", now.getDate())\n            .set(\"create_fulltime\", now.getFulltime())\n      .set(\"update_date\", now.getDate())\n      .set(\"update_fulltime\", now.getFulltime())\n      .insert();\n  }\n}","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144807,"update_fulltime":20210405161428,"use_whitelist":""},{"file_id":30,"file_type":2,"tag":"_code","label":"","path":"/_code/wood_xml_insert","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"<sql id=\"add_${tb!}\"\n     :return=\"long\"\n     :caching=\"cache_${key!}\"\n     :cacheClear=\"${tb!}_<#noparse>${</#noparse>${pri_key!}<#noparse>}</#noparse>\"\n     :remarks=\"新增${tb!}\">\n    INSERT INTO `${tb!}` (<#list fields!! as f>`${(f.field)!}`<#sep>, </#sep></#list>)\n                  VALUES (<#list fields!! as f>@{${(f.field)!}:${(f.type)!}}<#sep>, </#sep></#list>)\n</sql>","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144834,"update_fulltime":20200807141835,"use_whitelist":""},{"file_id":31,"file_type":2,"tag":"_code","label":"","path":"/_code/java_model_ibinder_2","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"import org.noear.wood.*;\n\nimport java.util.*;\n\npublic class ${table_camel!}Model implements IBinder {\n    \n    <#list fields!! as f>\n // ${(f.comment)!}\n    public ${(f.type)!} ${(f.field)!};\n    </#list>\n\n  public void bind(GetHandlerEx s) {\n        <#list fields as f>\n        ${(f.field)!} = s.get(\"${(f.field)!}\").value(${(f.def)!});\n        </#list>\n }\n \n  public IBinder clone() {\n    return new ${table_camel!}Model();\n  }\n\n}\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200117144857,"update_fulltime":20200117144907,"use_whitelist":""},{"file_id":35,"file_type":0,"tag":"water","label":"","path":"/water/paas/help/api/","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"var System = Java.type('java.lang.System');\n\n\nvar sysinfo = ('Running on Java version: ' + System.getProperty('java.version')) + '；' + ('Unix time from Java: ' + System.currentTimeMillis());\n\n\nreturn modelAndView(\"/water/paas/help/api/view\",{sysinfo:sysinfo,\"hahah\":\"hahahah\"});","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200205112559,"update_fulltime":1643339797685,"use_whitelist":""},{"file_id":36,"file_type":0,"tag":"water","label":"","path":"/water/paas/help/api/view","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"code/internal","content":"<!doctype html>\n<html class=\"frm10\">\n<head>\n    <title>接口手册111111111111111111111111111111111111111111</title>\n    <link rel=\"stylesheet\" href=\"//jtx.noear.org/img/_core/durian/main.css?v=14\" />\n    <script src=\"//cdn.bootcss.com/jquery/3.4.1/jquery.min.js\"></script>\n    <style>\n    block{margin:0 10px;}\n    </style>\n</head>\n<body>\n<main>\n\n<div class=\"mar10-t mar10-b\"><h2>概要：</h2></div>\n<br/>\n\n<block>\n${sysinfo!}\n</block>\n<br/>\n<block>\n    <h2>已安装的 脚本或模板执行器</h2>\n    <hr/>\n    <ul>\n        <#list XUtil.executorList() as m1>\n        <li>\n            <div>${m1}</div>\n        </li>\n        </#list>\n    </ul>\n</block>\n<br/>\n\n<block>\n    <h2>脚本和模板执行器 共享嵌入接口或对象</h2>\n    <hr/>\n    <ul>\n        <li>\n            <div class=\"t3\">/** 默认数据访问对象（:org.noear.wood.DbContext） */</div>\n            <div>db</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 默认缓存服务对象（:org.noear.wood.cache.ICacheServiceEx），可被替换 */</div>\n            <div>cache</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 当前上下文对象（:org.noear.solon.core.handle.Context） */</div>\n            <div>ctx</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 本地缓存服务对象（:org.noear.wood.cache.ICacheServiceEx） */</div>\n            <div>localCache</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入基础工具 */</div>\n            <div>XUtil</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入锁工具 */</div>\n            <div>XLock</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入函数总线（用于跨语法共享函数） */</div>\n            <div>XFun</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 引擎嵌入消息总线（用于水平拆分或扩展业务处理） */</div>\n            <div>XMsg</div>\n        </li>\n    </ul>\n</block>\n<br/>\n\n<block>\n    <h2>脚本执行器 专属嵌入接口或对象11</h2>\n    <hr/>\n    <ul>\n        <li>\n            <div class=\"t3\">/** 加载模块或类 */</div>\n            <div>var obj = <b>requireX</b>(path);</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 返回模块和视图 */</div>\n            <div>return <b>modelAndView</b>(path, model);</div>\n        </li>\n        <li>\n            <div class=\"t3\">/** 其它嵌入类 */</div>\n            <div>Context、ONode、Datetime、Timecount、Timespan</div>\n        </li>\n    </ul>\n</block>\n\n<br/>\n<div class=\"mar10-t mar10-b\"><h2>具体：<n style='font-size:1rem;font-weight:normal; '>（可借用浏览器查找功能快速定位）</n></h2></div>\n<br/>\n\n<#list XUtil.interfaceList() as l1>\n<block>\n    <div><h2>${l1.name}::${l1.type}</h2></div>\n    <hr/>\n    <ul>\n        <#list l1.methods as s1>\n        <li>\n            <div class=\"t3\">${XUtil.htmlEncode(s1.note)!}</div>\n            <div>${s1.code}</div>\n        </li>\n        </#list>\n    </ul>\n</block>\n</#list>\n\n\n</main>\n</body>\n</html>","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200205113727,"update_fulltime":1643339768553,"use_whitelist":""},{"file_id":119,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/get.h5.card.uv","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"var row_id= ctx.paramAsInt(\"row_id\",0);\n\n/**\n1004412：h5首页卡片\n1004382：原生首页卡片\n*/\n\nvar value =water.db(\"sponge/sponge_track\")\n                .table(\"short_url_ex_track_stat\")\n         .where(\" vi= 3\")\n                .and(\"url_id = ?\", 1004412)\n                .and(\"row_id >=?\",row_id)\n                .limit(100)\n                .select(\"row_id,uv_today,vd,vi\")\n                .getMapList();\nreturn value;","note":"获取h5首页卡片uv","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615125857,"update_fulltime":20200615130008,"use_whitelist":""},{"file_id":120,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/log.day","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,date\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\",\"date\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id = ctx.paramAsInt(\"tag_id\");\nvar date   = ctx.paramAsInt(\"date\");\nvar page   = ctx.paramAsInt(\"page\");\nvar size   = ctx.paramAsInt(\"size\");\n\nif(!size){\n  size=50;\n}\n\nvar list = water.db(\"sponge/sponge_track\")\n                .table(\"short_redirect_log_30d\")\n         .where(\"log_date = ?\",date)\n                         .and(\"tag_id = ?\", tag_id)\n                         .groupBy(\"user_key\")\n                         .limit(page*size, size)\n                  .select(\"user_key AS ukey, log_date\")\n                         .getMapList();\n\nif (list && list.length > 0) {\n  return {code:1,msg:'success',list:list};\n} else {\n  return {code:2,msg:'没有相关数据',list:[]};\n}","note":"参数：tag_id,date","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615130056,"update_fulltime":20211009144242,"use_whitelist":""},{"file_id":121,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/log.day.no.duplicate","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：log_date,tag_id\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\nif (!_api.checkParamsIsOk(ctx,[\"log_date\", \"tag_id\"])) {\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"size\"])){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar page     = ctx.paramAsInt(\"page\");\nvar size     = ctx.paramAsInt(\"size\");\nvar tag_id   = ctx.paramAsInt('tag_id');\nvar log_date = ctx.paramAsInt('log_date');\n\nvar click_list = water.db(\"sponge/sponge_track\")\n                      .table(\"short_redirect_log_30d s\")\n                      .innerJoin(\"short_url s1\").on(\"s.url_id = s1.url_id\")\n                      .where(\"s.tag_id = ?\", tag_id).and(\"s.log_date = ?\", log_date)\n                      .groupBy(\"s.user_key,s1.url_partner_key\")\n                      .limit(page*size, size)\n                      .select(\"s.url_id,s.tag_id,s.user_id,s.user_key,s1.url_partner_key,s1.url_name,s.v5 udid\")\n                      .getMapList();\n\nif (click_list && click_list.length > 0) {\n    return {code:1, msg:'success', list:click_list};\n} else {\n    return {code:2,msg:'没有相关数据',list:[]};\n}\n","note":"参数：log_date,tag_id","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615130616,"update_fulltime":20201014163256,"use_whitelist":""},{"file_id":122,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/log.ukey.time","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,page,size,log_date\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"size\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\n\nvar tag_id   = ctx.paramAsInt(\"tag_id\");\nvar page     = ctx.paramAsInt(\"page\");\nvar size     = ctx.paramAsInt(\"size\");\nvar log_date = ctx.paramAsInt(\"log_date\");\n\n\nvar list = water.db(\"sponge/sponge_track\")\n                .table(\"short_redirect_log_30d\")\n          .where(\"log_date = ?\",log_date).and(\"tag_id = ?\", tag_id)\n                .groupBy(\"user_key\")\n                .orderBy(\"log_id\")\n                .limit(page*size, size)\n              .select(\"user_key AS ukey, MIN(log_date) AS first_date\")\n                .getMapList();\n\nif (list && list.length > 0) {\n  return {code:1,msg:'success',list:list};\n} else {\n  return {code:2,msg:'没有相关数据',list:[]};\n}\n","note":"参数：tag_id,page,size,log_date","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615130830,"update_fulltime":20211009144250,"use_whitelist":""},{"file_id":123,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/log.ukey.time.new","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,size,page,log_date\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"size\"])){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n    return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\n\nvar tag_id   = ctx.paramAsInt(\"tag_id\");\nvar page     = ctx.paramAsInt(\"page\");\nvar size     = ctx.paramAsInt(\"size\");\nvar log_date = ctx.paramAsInt(\"log_date\");\n\n\nvar list = water.db(\"sponge/sponge_track\")\n                .table(\"short_redirect_log_30d\")\n                .where(\"log_date = ?\",log_date).and(\"tag_id = ?\", tag_id)\n                .groupBy(\"user_key\")\n                .orderBy(\"log_id\")\n                .limit(page*size, size)\n                .select(\"user_key AS ukey, MIN(log_date) AS first_loan_date, \" +\n                    \"MIN(log_fulltime) AS first_loan_time, MAX(log_date) AS last_loan_date, \" +\n                    \"MAX(log_fulltime) AS last_loan_time\")\n                .getMapList();\n\nif (list && list.length > 0) {\n    return {code:1,msg:'success',list:list};\n} else {\n    return {code:2,msg:'没有相关数据',list:[]};\n}","note":"用户首次与最近登录贷超","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615131149,"update_fulltime":20211009144300,"use_whitelist":""},{"file_id":124,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/log.urls","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：user_key,tag_id?,date?\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\nif(!_api.checkParamsIsOk(ctx,[\"udid\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar udid = ctx.param(\"udid\");\nvar tag_id   = ctx.paramAsInt(\"tag_id\",0);\nvar date     = ctx.paramAsInt(\"date\",0);\n\n\nvar tb = water.db(\"sponge/sponge_track\").table(\"short_redirect_log_30d s\")\n   .innerJoin(\"short_url u\")\n   .innerJoin(\"track_tag t\")\n   .on(\"s.url_id = u.url_id\")\n   .and(\"s.tag_id = t.tag_id\")\n   .where(\"s.v5 = ?\",udid);\n\nif(tag_id>0){\n  tb.and(\"s.tag_id = ?\", tag_id);\n}\n\nif (date > 0) {\n  tb.and(\"s.log_date = ?\",date);\n}\n\nvar list = tb.orderBy(\"s.log_fulltime desc\")\n              .limit(50)\n              .select(\"u.url_name,u.url_partner_key,t.tag_name,s.url_id,s.tag_id,s.log_date,DATE_FORMAT(s.log_fulltime,'%Y-%m-%d %H:%i:%s') log_fulltime\")\n              .getMapList();\n\n\nlet code = 1;\nlet msg = 'success';\n\nreturn {code:code, msg:msg, data:list};\n","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615134921,"update_fulltime":20200918154532,"use_whitelist":""},{"file_id":125,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/pui.tag.urls","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,date\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\",\"date\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id = ctx.paramAsInt(\"tag_id\");\nvar date   = ctx.paramAsInt(\"date\");\n\nvar list = water.db('sponge/sponge_track')\n                .exe(`SELECT s.url_id,s.url_name,s.url_partner_key,t.pv,t.uv,t.ip FROM stat_date_hour_pv_uv_ip t INNER JOIN short_url s ON t.url_id = s.url_id WHERE t.tag_id = ${tag_id} AND t.log_date = ${date} AND t.log_hour = -1`);\n\n\nreturn {code:1,msg:'success',data:list};","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615134957,"update_fulltime":20211009144308,"use_whitelist":""},{"file_id":126,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/pui.track.get","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：vi,vd,date_start,date_end,url_id,log_hour\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\n\nif(!_api.checkParamsIsNot0(ctx,[\"date_start\",\"date_end\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\n\nvar vi          = ctx.paramAsInt(\"vi\");\nvar vd          = ctx.param(\"vd\");\nvar notvd       = ctx.param(\"notvd\");\nvar date_start  = ctx.paramAsInt(\"date_start\");\nvar date_end    = ctx.paramAsInt(\"date_end\");\nvar url_id      = ctx.paramAsInt(\"url_id\");\nvar log_hour    = ctx.paramAsInt(\"log_hour\");\nvar inlist      = ctx.param(\"inlist\");\n\nvar selectDb = water.db(\"sponge/sponge_track\")\n                .table(\"stat_track_date_hour_pv_uv_ip\")\n         .where(\"1 = 1\")\n                .and(\"log_date >= ?\", date_start)\n                .and(\"log_date <= ?\", date_end);\nif(vd){\n   selectDb.and(\"vd = ?\", vd);\n}\nif(vi>0){\n   selectDb.and(\"vi = ?\", vi);\n}\nif(url_id==-1||url_id>0){\n   selectDb.and(\"url_id = ?\", url_id);\n}\nif (log_hour<25) {\n   selectDb.and(\"log_hour = ?\", log_hour);\n}\nif(notvd){\n   var arr = notvd.split(',');\n   for(var i in arr){\n     selectDb.and(\"vd != ?\", arr[i]);\n   }\n}\nif(inlist){\n   var sql = '(';\n   var array = inlist.split(',');\n   for(i in array){\n     sql = sql + ' vd = '+array[i]+' or';\n   }\n   sql = sql.substring(0,sql.length-2) +')';\n   selectDb.and(sql);\n}\n\nvar list = selectDb.orderBy(\"log_date asc\")\n          .select(\"*\")\n                .getMapList();\n                \n\nif (list && list.length > 0) {\n  return {code:1,msg:'success',list:list};\n} else {\n  return {code:2,msg:'没有数据',list:[]};\n}","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135009,"update_fulltime":20211009144320,"use_whitelist":""},{"file_id":127,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/pui.url","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：url_partner_key,tag_id,date?\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\nif(!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar upkey  = ctx.param(\"url_partner_key\");\nvar tag_id = ctx.paramAsInt(\"tag_id\");\nvar date   = ctx.paramAsInt(\"date\");\n\n\nvar db_cfg = \"sponge/sponge_track\";\n\nvar surl = water.db(db_cfg).exe(`map::SELECT * FROM short_url WHERE tag_id = ${tag_id} AND url_partner_key = '${upkey}'`);\n\n\nvar tb = water.db(db_cfg).table('stat_date_hour_pv_uv_ip')\n                   .where('url_id=? AND tag_id=? AND log_hour=-1',surl.url_id,tag_id);\n\nif(date>0){ \n    tb.and('log_date=?',date);\n}\n\nvar list = tb.select('url_id,pv,uv,ip,log_date').getMapList();\n\nlist.forEach(m=>{\n  m.url_name = surl.url_name;\n  m.url_partner_key = surl.url_partner_key;\n});\n\nreturn {code:1,msg:'success',data:list};","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135025,"update_fulltime":20211009144329,"use_whitelist":""},{"file_id":128,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/short.url.partner.key.get","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\n\nif(!_api.checkParamsIsOk(ctx,[\"url_key\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar url_key = ctx.param(\"url_key\");\n\n\nvar surl = water.db(\"sponge/sponge_track\").table(\"short_url\")\n                .where(\"url_key = ?\", url_key)\n                .select(\"url_partner_key\")\n                .getValue();\n\nreturn {code:1, msg:'success', data:surl};","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135036,"update_fulltime":20200615140707,"use_whitelist":""},{"file_id":129,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/url.add","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：url_partner_key,url_name,tag_id,tag_access_key\n//\n\nlet _api = requireX('/_funs/_api.clz');\nlet _tool = requireX('/sponge_track/_tool.lib');\n\n\nif (!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"url_name\",\"tag_id\",\"tag_access_key\"])) {\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.ip_isWhitelist(ctx)){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_access_key  = ctx.param(\"tag_access_key\");\nvar tag_id          = ctx.paramAsInt(\"tag_id\",0);\nvar build_link      = ctx.param(\"build_link\");\n\nif (build_link) {\n  if (_tool.checkBuildLink(build_link) === false) {\n    return {code:6,msg:\"构建链接格式不正确\"};\n  }\n}\n\nvar tag = water.db(\"sponge/sponge_track\").table(\"track_tag\")\n      .where(\"tag_id = ?\",tag_id).and(\"tag_access_key = ?\",tag_access_key)\n      .select(\"*\")\n      .getMap();\n\n\nif (tag.tag_id === 0) {\n  return {code:5,msg:\"tag_access_key错误\"};\n}else {\n  var oNode = _tool.addShortUrlApi(ctx); \n\n  if (oNode.url) {\n    return {code:1,msg:\"success\",data:oNode};\n  }else{\n    return {code:4,msg:\"源网址已是短地址格式\"};\n  }\n}\n\n","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135047,"update_fulltime":20200909183538,"use_whitelist":""},{"file_id":130,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/url.get.by.tag.pk","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,url_partner_key\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\nif (!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"tag_id\"])) {\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id          = ctx.paramAsInt(\"tag_id\");\nvar url_partner_key = ctx.paramAsInt(\"url_partner_key\");\n\nvar obj = water.db(\"sponge/sponge_track\").table(\"short_url\")\n            .where(\"tag_id = ?\",tag_id).and(\"url_partner_key = ?\",url_partner_key)\n            .select(\"*\")\n            .getMap();\n\nreturn {code:1,msg:\"success\",data:obj};","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135058,"update_fulltime":20200615142727,"use_whitelist":""},{"file_id":131,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/url.pui.get","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,url_ids,date\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\",\"date_start\",\"date_end\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nlet tag_id      = ctx.paramAsInt(\"tag_id\");\nlet date_start  = ctx.param(\"date_start\");\nlet date_end    = ctx.param(\"date_end\");\nlet url_ids     = ctx.param(\"url_ids\",\"\");\n\nlet selectDb = water.db(\"sponge/sponge_track\")\n                .table(\"stat_date_hour_pv_uv_ip\")\n          .where(\"log_hour = -1\")\n                .and(\"tag_id = ?\", tag_id)\n                .and(\"log_date >= ?\", date_start)\n                .and(\"log_date <= ?\", date_end);\n\nif(url_ids){\n   let sql = '(';\n   let array = url_ids.split(',');\n   \n   for(let i in array){\n     sql = sql + ' url_id = '+array[i]+' or';\n   }\n   \n   sql = sql.substring(0,sql.length-2) +')';\n   selectDb.and(sql);\n}\n\nlet list = selectDb.select(\"*\")\n                .getMapList();              \n                \nif (list && list.length > 0) {\n  return {code:1,msg:'success',list:list};\n} else {\n  return {code:2,msg:'没有数据',list:[]};\n}","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135109,"update_fulltime":20211009144832,"use_whitelist":""},{"file_id":132,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/url.update.by.tag.pk","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"application/json","content":"//\n// 参数：tag_id,url_partner_key,url_val\n//\n\nlet _api = requireX('/_funs/_api.clz');\n\n\nif (!_api.checkParamsIsOk(ctx,[\"url_partner_key\",\"url_val\",\"tag_id\"])) {\n return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nif(!_api.checkParamsIsNot0(ctx,[\"tag_id\"])){\n  return {code:ctx.attrMap().code, msg:ctx.attrMap().msg};\n}\n\nvar tag_id          = ctx.param(\"tag_id\");\nvar url_partner_key = ctx.paramAsInt(\"url_partner_key\");\nvar url_val         = ctx.param(\"url_val\");\n\nvar url_val_md5 = XUtil.md5(url_val);\n\nwater.db(\"sponge/sponge_track\").table(\"short_url\")\n            .where(\"tag_id = ?\",tag_id)\n            .and(\"url_partner_key = ?\",url_partner_key)\n     .set(\"url_val_md5\", url_val_md5)\n      .set(\"url_val\", url_val)\n            .set(\"update_time\", \"$NOW()\")\n            .update();\n\nreturn {code:1,msg:\"success\"};","note":"ok","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615135119,"update_fulltime":20211009144841,"use_whitelist":""},{"file_id":133,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/_tool.lib","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"code/internal","content":"this.addShortUrlApi = function(ctx){\n    var prefix = water.cfg('sponge/track_uri').value;\n    \n    var tag_id          = ctx.paramAsInt(\"tag_id\",0);\n    var tag_access_key  = ctx.param(\"tag_access_key\");\n    var url_partner_key = ctx.param(\"url_partner_key\");\n    var url_name        = ctx.param(\"url_name\");\n    var url_val         = ctx.param(\"url_val\");\n    var track_params    = ctx.param(\"track_params\");\n    var trans_params    = ctx.param(\"trans_params\");\n    var user_field      = ctx.param(\"user_field\");\n    var build_link      = ctx.param(\"build_link\");\n    var note            = ctx.param(\"note\");\n    \n    if (url_val && url_val.indexOf(prefix) >= 0) { \n      return {};\n    } \n    \n    var dbx = water.db(\"sponge/sponge_track\");\n    \n    \n    var shortUrl = dbx.table(\"short_url\")\n                .where(\"tag_id = ?\",tag_id).and(\"url_partner_key = ?\",url_partner_key)\n                .select(\"*\")\n                .getMap();\n    \n    var url_id = shortUrl.url_id;\n    var trackParamsNum = 0;\n    var tag = dbx.table(\"track_tag\")\n          .where(\"tag_id = ?\",tag_id)\n         .select(\"*\")\n          .getMap();\n    \n    var tag_host = tag.tag_host;\n    if(tag_host){\n       if(tag_host.substr(-1)!='/'){\n       tag_host = tag_host + '/';\n       }\n       prefix = tag_host;\n    }\n    var dbQueryUpdate = dbx.table(\"short_url\")\n          .set(\"tag_id\", tag_id)\n          .set(\"url_partner_key\", url_partner_key)\n          .set(\"url_name\",url_name)\n                .set(\"update_time\", \"$NOW()\");\n\n    if(track_params) {\n        trackParamsNum = track_params.split(',').length;\n        dbQueryUpdate.set(\"track_params\", track_params)\n          .set(\"track_params_num\", trackParamsNum);\n    } else{\n      track_params = tag.t_track_params;\n\n       if(track_params){\n        trackParamsNum = track_params.split(',').length;\n       }\n    }\n    \n    if(!trans_params) { \n        trans_params = tag.t_trans_params;\n    } else {\n        dbQueryUpdate.set(\"trans_params\", trans_params);\n    }\n    \n    if(!user_field) { \n        user_field = tag.t_user_field;\n    } else {\n       dbQueryUpdate.set(\"user_field\",user_field);\n    }\n    \n    if(!build_link) { \n        build_link = tag.t_build_link;\n    } else {\n        dbQueryUpdate.set(\"build_link\",build_link);\n    }\n    \n    var url_md5 = '';\n    if(url_val) { \n        url_md5 = XUtil.md5(url_val);\n        dbQueryUpdate.set(\"url_val\", url_val)\n                     .set(\"url_val_md5\", url_md5);\n    }\n    XUtil.log(track_params+\"a1,\"+trackParamsNum+\"a2,\"+trans_params+\"a3\");\n    var dbQuery = dbx.table(\"short_url\")\n          .set(\"tag_id\", tag_id)\n          .set(\"url_partner_key\", url_partner_key)\n          .set(\"url_name\",url_name)\n         .set(\"url_val_md5\", url_md5)\n          .set(\"url_val\", url_val)\n          .set(\"track_params\", track_params)\n          .set(\"track_params_num\", trackParamsNum)\n          .set(\"trans_params\", trans_params)\n          .set(\"user_field\",user_field)\n         .set(\"build_link\",build_link)\n                .set(\"update_time\", \"$NOW()\");\n    \n    if(!url_id){ \n       /*公共函数调用  tag名_函数名*/\n       url_id = this.getUrlID();\n       var url_key = this.getCodeByID(url_id);\n       \n      dbQuery.set(\"url_id\", url_id)\n           .set(\"create_fulltime\", \"$NOW()\")\n           .set(\"url_key\", url_key)\n             .set(\"note\",note)\n            .insert();\n      \n      dbx.table(\"short_url_ex_stat\")\n          .set(\"url_id\", url_id)\n          .set(\"tag_id\", tag_id)\n          .insert();\n          \n       return {'url':prefix+url_key,'url_id':url_id};\n    }else{\n     dbQueryUpdate.where(\"url_id = ?\", url_id).update();\n     return {'url':prefix+shortUrl.url_key,'url_id':url_id};\n    }\n}\n\n\nthis.checkBuildLink = function(build_link){\n    if(!build_link || build_link.indexOf('::')<0){\n      return false;\n    }\n    \n    return true;\n}\n\nthis.getCodeByID = function(id){\n    var key = 999999999;\n    id = id + key;\n    id = id - (key / 100);\n    id = id + (key / 10000);\n    id = id - (key / 1000000);\n    id = parseInt(id + 2);\n    \n    return id.toString(36);\n}\n\nthis.getShortUrlByPartnerKey = function(url_partner_key,tag_id){\n    return water.db('sponge/sponge_track')\n                .exe(`map::SELECT * FROM short_url WHERE url_partner_key=${url_partner_key} AND tag_id=${tag_id}`);\n}\n\nthis.getTag = function(tag_id){\n    return water.db('sponge/sponge_track')\n                .exe(`map::SELECT * FROM track_tag WHERE tag_id=${tag_id}`);\n}\n\nthis.getUrlID = function(){\n    return rock.client.newID('SPONGE_ID','url_id',60 * 60 * 24 * 365) + 1000000;\n}\n\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200615140917,"update_fulltime":20210405161301,"use_whitelist":""},{"file_id":188,"file_type":2,"tag":"_code","label":"","path":"/_code/java_crud_xml_template","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"INSERT INTO `group_buying` (\n<#list fields!! as f>\n`${(f.field)!}`,\n</#list>\n) VALUES(\n<#list fields!! as f>\n@{${(f.field)!}:${(f.type)!}} ,\n</#list>\n)","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200708104315,"update_fulltime":20200708105354,"use_whitelist":""},{"file_id":267,"file_type":2,"tag":"_ops","label":"","path":"/_ops/peapi.sh","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"sh","content_type":"text/plain","content":"#!/usr/bin/bash\n\nname=\"pepperapi\"\ndpdir=/data/sss/pepper.zmapi.cn\n\nbackup(){\nbackuptime=$(date '+%Y%m%d_%H:%M:%S')\nbackupdir=\"/data/backup/$name/$backuptime\"\nmkdir -p \"${backupdir}\"\nscp $host:${dpdir}/pepperapi.jar ${backupdir}\n}\n\ndeploy(){\nrsync -avz --delete pepperapi.jar ${host}:${dpdir}\nssh -t root@${host} <<EOF\nsed -i '/127.0.0.1:8081/s/^.*$/    server 127.0.0.1:8081 down;/g'  /data/_nginx.conf/pepper.zmapi.cn \nnginx -s reload\nsleep 7\nsystemctl restart pepperapi1\nwhile :\n    do\n        curl -m 3 -sI  \"http://127.0.0.1:8081/run/check/\" | grep 200\n        if [[ $? -eq 0 ]]\n            then\n            echo \"service1 is ok\"\n            break\n        fi\n        sleep 3\n    done\nsleep 3\nsed -i '/127.0.0.1:8081/s/^.*$/    server 127.0.0.1:8081 weight=10;/g'  /data/_nginx.conf/pepper.zmapi.cn\nsed -i '/127.0.0.1:8082/s/^.*$/    server 127.0.0.1:8082 down;/g'  /data/_nginx.conf/pepper.zmapi.cn\nnginx -s reload\nsleep 7\nsystemctl restart pepperapi2\nwhile :\n    do\n        curl -m 3 -sI  \"http://127.0.0.1:8082/run/check/\" | grep 200\n        if [[ $? -eq 0 ]]\n            then\n            echo \"service2 is ok\"\n            break\n        fi\n        sleep 3\n    done\nsleep 3\nsed -i '/127.0.0.1:8082/s/^.*$/    server 127.0.0.1:8082 weight=10;/g'  /data/_nginx.conf/pepper.zmapi.cn\nnginx -s reload\nEOF\n}\n\nhost=api\nbackup\n\nfor host in  {api,api2}\ndo\ndeploy\ndone\nif [[ $? -eq 0 ]]\n    then\n    curl \"http://water2/run/push/?target=@alarm&msg=pepperapi发布成功\"\n    else\n    curl \"http://water2/run/push/?target=@alarm&msg=pepperapi发布失败\"\n    break\nfi\n\nrm -rf ${name}.jar\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200901152715,"update_fulltime":20200901152956,"use_whitelist":""},{"file_id":268,"file_type":2,"tag":"_ops","label":"","path":"/_ops/rockrpc.sh","rank":0,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"sh","content_type":"text/plain","content":"#!/usr/bin/bash\n\nname=\"rockrpc\"\ndpdir=/data/sss/water.zmapi.cn\n\nbackup(){\nbackuptime=$(date '+%Y%m%d_%H:%M:%S')\nbackupdir=\"/data/backup/$name/$backuptime\"\nmkdir -p \"${backupdir}\"\nscp $host1:${dpdir}/rockrpc.jar ${backupdir}\n}\n\ndeploy(){\nrsync -avz --delete rockrpc.jar ${host}:${dpdir}\nssh -t root@${host} <<EOF\nip=$(ip addr |grep inet |grep -v inet6 |grep eth0 | awk '{print $2}' | awk -F \"/\" '{print $1}')\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8085,0\nsleep 2\nsystemctl restart rockrpc1\nsleep 2\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8085,1\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8086,0\nsleep 2\nsystemctl restart rockrpc2\nsleep 2\ncurl http://water2/sev/set/?s=rockrpc@${ip}:8086,1\nEOF\n}\n\nhost=water\nbackup\n\nfor host in  {waterapi,waterapi2}\ndo\ndeploy\ndone\nif [[ $? -eq 0 ]]\n    then\n    curl \"http://water2/run/push/?target=@alarm&msg=rockrpc发布成功\"\n    else\n    curl \"http://water2/run/push/?target=@alarm&msg=rockrpc发布失败\"\n    break\nfi\n\nrm -rf ${name}.jar\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20200901152815,"update_fulltime":20210517170318,"use_whitelist":""},{"file_id":281,"file_type":0,"tag":"sponge_track","label":"","path":"/sponge_track/get.original.url","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let tag_id= ctx.paramAsInt(\"tag_id\",0);\nlet url_partner_key=ctx.param(\"url_partner_key\");\n\n\nvar value =water.db(\"sponge/sponge_track\")\n                .table(\"short_url\")\n         .where(\" tag_id= ?\",tag_id)\n                .and(\"url_partner_key = ?\", url_partner_key)\n                .limit(1)\n                .select(\"url_val\")\n                .getValue();\nreturn {code:1,msg:\"success\",url:value};","note":"获取短地址的原始连接","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20201010105841,"update_fulltime":20201010112852,"use_whitelist":""},{"file_id":352,"file_type":1,"tag":"water","label":"","path":"/water/log_del_15d_bef","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let list = water.db(\"water/water\")\n                .sql(\"SELECT logger_id,tag,logger,keep_days,DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -keep_days DAY),'%Y%m%d') date FROM water_cfg_logger\")\n                .getMapList();\n\nlet hub = Java.type('org.noear.water.protocol.ProtocolHub');\nlet map = {};\n\nfor(let i in list){\n    let m = list[i];\n    \n    try{\n        let timecount = new Timecount().start();\n        let num = hub.logQuerier.clear(m.logger, m.keep_days, 100000);\n        map[m.logger] = num;\n        \n        XUtil.log(`${m.logger} deleted : ${num} - ${timecount.stop().milliseconds()}ms`);\n    }catch(err){\n      XUtil.log(err);\n    }\n}\n\nreturn map;\n","note":"日志-删除过期的数据","plan_state":9,"plan_begin_time":1579236868000,"plan_last_time":1676964059649,"plan_last_timespan":667,"plan_next_time":1676969668649,"plan_interval":"1h","plan_max":0,"plan_count":6911,"create_fulltime":20200117125441,"update_fulltime":20210508103956,"use_whitelist":""},{"file_id":353,"file_type":1,"tag":"water","label":"","path":"/water/msg_del_3d","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"var date3 = Datetime.Now().addDay(-3).getDate();\n\nvar hub = Java.type('org.noear.water.protocol.ProtocolHub');\n\n//删除\n//\nfor(let ms of hub.getMsgBrokerList()){\n    ms.getSource().clear(date3);\n}\n\nreturn \"ok\";","note":"消息清理和统计","plan_state":9,"plan_begin_time":1579237979000,"plan_last_time":1676964059649,"plan_last_timespan":170,"plan_next_time":1676967179649,"plan_interval":"1h","plan_max":0,"plan_count":7059,"create_fulltime":20200117131300,"update_fulltime":20211104121009,"use_whitelist":""},{"file_id":354,"file_type":1,"tag":"water","label":"","path":"/water/msg_reset","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"\nlet hub = Java.type('org.noear.water.protocol.ProtocolHub');\nlet map = {};\n\nfor(let ms of hub.getMsgBrokerList()){\n    let rst = ms.getSource().reset(30);\n    \n    map[ms.getName()] = rst;\n\n    XUtil.log(ms.getName() + \"::reset-\" + rst);\n}\n\nreturn map;","note":"消息异常重置","plan_state":9,"plan_begin_time":1579239545000,"plan_last_time":1676964486506,"plan_last_timespan":12,"plan_next_time":1676964545506,"plan_interval":"1m","plan_max":0,"plan_count":920,"create_fulltime":20200117132352,"update_fulltime":20211104122534,"use_whitelist":""},{"file_id":355,"file_type":1,"tag":"water","label":"","path":"/water/speed_del_30","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let t1 = new Datetime().addDay(-3).getTicks();\nlet d2 = new Datetime().addDay(-3).getDate();\nlet d3 = new Datetime().addDay(-30).getDate();\n\nlet db1= water.db('water/water');\ndb1.exe(`DELETE FROM water_reg_service_speed WHERE gmt_modified <?`, t1);\ndb1.exe(`DELETE FROM water_reg_service_speed_date WHERE log_date <?`, d2);\ndb1.exe(`DELETE FROM water_reg_service_speed_hour WHERE log_date <?`, d3);\n\nlet rd2 = water.rd('water/water_redis',5);\nrd2.open0(function(ru){\n  return ru.key('monitor_keys').delete();\n});\n\nreturn 'OK';\n","note":"接口性能-删除超时的记录","plan_state":9,"plan_begin_time":1588695000000,"plan_last_time":1676964059648,"plan_last_timespan":252,"plan_next_time":1676967000648,"plan_interval":"1h","plan_max":0,"plan_count":7011,"create_fulltime":20200506093544,"update_fulltime":1650607098162,"use_whitelist":""},{"file_id":356,"file_type":1,"tag":"water","label":"","path":"/water/speed_sync_ref","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"var date = new Datetime().getDate();\n\nvar db2 = water.db(`water/water`);\n\ndb2.exe(`UPDATE water_reg_service_speed s,water_reg_service_speed_date d\n            SET s.average_ref = d.average\n            WHERE d.log_date=? AND s.service = d.service AND s.tag = d.tag AND s.name_md5 = d.name_md5`, date);\n\n\nreturn 'OK';","note":"接口性能-数据引用同步","plan_state":9,"plan_begin_time":1588694400000,"plan_last_time":1676964301181,"plan_last_timespan":177,"plan_next_time":1676964600181,"plan_interval":"5m","plan_max":0,"plan_count":1438,"create_fulltime":20200506093917,"update_fulltime":20210326153805,"use_whitelist":""},{"file_id":361,"file_type":1,"tag":"_ops","label":"","path":"/_ops/_service_disable_auto","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('water/water');\n\n//\n//分开执行，可以用到索引，进而不用锁全表\n//\ndb2.exe(`\nUPDATE water_reg_service SET is_enabled=0 \nWHERE (address LIKE ?) AND check_last_state=1`, '192.%');\n\n\ndb2.exe(`\nUPDATE water_reg_service SET is_enabled=0 \nWHERE (address LIKE ?) AND check_last_state=1`, '169.%');\n\n\ndb2.exe(`\nUPDATE water_reg_service SET is_enabled=0 \nWHERE (address LIKE ?) AND check_last_state=1`, '10.37.%');\n\n\nreturn 'OK';","note":"服务-内网自动禁用","plan_state":9,"plan_begin_time":1589644800000,"plan_last_time":1638675301000,"plan_last_timespan":73,"plan_next_time":0,"plan_interval":"2m","plan_max":0,"plan_count":4476,"create_fulltime":20200517073534,"update_fulltime":20200819114927,"use_whitelist":""},{"file_id":362,"file_type":1,"tag":"_ops","label":"","path":"/_ops/_msg_subscriber_disable_auto","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('water/water');\n\n//禁用操作\n\n//内网IP\n//\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,'%//192.%');\n\n\n\n//本机IP\n//\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,'%//0:0:%');\n\ndb2.exe(`UPDATE water_msg_subscriber SET is_enabled=0 \nWHERE is_enabled=1 AND check_last_state=1 AND receive_url LIKE ?`,'%//127.0%');\n\n\nreturn \"OK\";","note":"消息-删除无意义的内网订阅者","plan_state":9,"plan_begin_time":1589644800000,"plan_last_time":1638675301000,"plan_last_timespan":111,"plan_next_time":0,"plan_interval":"2m","plan_max":0,"plan_count":4475,"create_fulltime":20200517073835,"update_fulltime":1638675726251,"use_whitelist":""},{"file_id":364,"file_type":1,"tag":"water","label":"","path":"/water/_service_consumer_del_3h","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let date = Datetime.Now().addHour(-3).getTicks();\n\nlet db2 = water.db('water/water');\n\ndb2.table('water_reg_consumer')\n   .where('chk_fulltime < ?',date)\n   .delete();\n     \n     \nreturn 'OK';","note":"网关-删除3小时没活跃的消息者记录","plan_state":9,"plan_begin_time":1592150400000,"plan_last_time":1676964059648,"plan_last_timespan":104,"plan_next_time":1676966400648,"plan_interval":"1h","plan_max":0,"plan_count":7018,"create_fulltime":20200615161006,"update_fulltime":1638676079707,"use_whitelist":""},{"file_id":365,"file_type":1,"tag":"water","label":"","path":"/water/msg_persistence","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let date90 = Datetime.Now().addDay(-90).getDate();\nlet date2 = Datetime.Now().addDay(-2).getDate();\n\nlet hub = Java.type('org.noear.water.protocol.ProtocolHub');\n\nfor(let ms of hub.getMsgBrokerList()){\n    ms.getSource().persistence(date2,date90);\n}\n\n\nreturn \"ok\";","note":"消息持久化处理","plan_state":9,"plan_begin_time":1593370800000,"plan_last_time":1653983922168,"plan_last_timespan":559,"plan_next_time":1654023600168,"plan_interval":"1d","plan_max":0,"plan_count":528,"create_fulltime":20200630111248,"update_fulltime":20211104120701,"use_whitelist":""},{"file_id":366,"file_type":1,"tag":"water","label":"","path":"/water/_service_consumer_sync","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('water/water');\n\ndb2.exe(`UPDATE water_reg_consumer c, water_reg_service s \n            SET c.chk_fulltime = s.check_last_time,\n                c.chk_last_state = s.check_last_state,\n                c.is_enabled = s.is_enabled\n          WHERE c.consumer_address = s.address`);\n          \n          \nreturn 'OK';","note":"网关-同步消费者记录","plan_state":9,"plan_begin_time":1593705600000,"plan_last_time":1676964481448,"plan_last_timespan":50,"plan_next_time":1676964540448,"plan_interval":"1m","plan_max":0,"plan_count":7389,"create_fulltime":20200703101656,"update_fulltime":20200706100940,"use_whitelist":""},{"file_id":367,"file_type":1,"tag":"water","label":"","path":"/water/log_alarm","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db(\"water/water\");\n\nlet list = db2.sql(\"SELECT logger_id,tag,logger,source FROM water_cfg_logger WHERE is_alarm=1\")\n              .getMapList();\n                \n\nlet map1  = XUtil.newMap();\nlet list1 = db2.sql(\"SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed WHERE service=? AND TAG=?\",'_waterlog','logger')\n               .getMapList();\n\nfor(let m1 of list1){\n   map1.put(m1.name, m1.total_num_slow5);\n}\n\nlet alarm_sign = XUtil.cfgGet('water/alarm_sign');\n\nlet date1 = Datetime.Now().getDate();\nlet hub = Java.type('org.noear.water.protocol.ProtocolHub');\n                \nfor(let m of list){\n    \n    // try{\n        let key2 = \"log_num__\" + m.logger;\n        let num2_old = XUtil.cfgGet(key2);\n        if(!num2_old){\n            num2_old = \"0\";\n        }\n\n        \n        let num2 = map1.get(m.logger);\n        \n        if(num2){\n            if((parseInt(num2_old) != num2)){\n                let msg = `预警：错误日志数量::${num2}`;\n                let sgin = `[${m.logger}][${alarm_sign}]`;\n                \n                water.heihei('@alarm,@'+m.tag, msg, sgin);\n\n                XUtil.cfgSet(key2, num2+'');\n            }\n            \n            XUtil.log(`${m.logger} err old:${num2_old} new:${num2}`);\n        }\n        \n    // }catch(err){\n    //   XUtil.log({content:err.message});\n    // }\n}\n\nreturn 'OK';","note":"日志-检查错误数量并告警","plan_state":9,"plan_begin_time":1595347200000,"plan_last_time":1676964481447,"plan_last_timespan":106,"plan_next_time":1676964600447,"plan_interval":"2m","plan_max":0,"plan_count":2864,"create_fulltime":20200723141233,"update_fulltime":1637391264306,"use_whitelist":""},{"file_id":368,"file_type":1,"tag":"water","label":"","path":"/water/_service_runtime_pull","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db(\"water/water\");\n\nlet serivers = db2.table(\"water_reg_service\").whereEq(\"check_type\",0).andEq('is_enabled',1).select(\"key,name,address\").getMapList();\nlet datetime = Datetime.Now();\n\n//let TrackBuffer = Java.type(\"org.noear.water.track.TrackBuffer\")\n\nfunction execDo(s1){\n   try{\n      let rst_str = water.getStatus(s1.address);\n\n      if(rst_str && rst_str.startsWith(\"{\")){\n         let rst = JSON.parse(rst_str);\n\n         if(rst.data){\n            rst = rst.data;\n         }\n\n         if(!rst.memoryMax){\n            return;\n         }\n\n         let logM = XUtil.newMap();\n         logM.tag = \"sevchk\";\n         logM.tag1 = s1.address;\n         logM.tag2 = s1.name;\n         \n         logM.content = rst_str;\n         water.logInfo(\"water_log_sev\", logM);\n\n         logM.content = `App:: memoryMax:${rst.memoryMax} - memoryTotal:${rst.memoryTotal} - memoryUsed:${rst.memoryUsed} - threadCount:${rst.threadCount}`;\n         water.logDebug(\"water_log_sev\", logM);\n\n   \n         db2.table(\"water_reg_service_runtime\")\n            .set(\"key\",s1.key)\n            .set(\"name\",s1.name)\n            .set(\"address\",s1.address)\n            .set(\"log_date\",datetime.getDate())\n            .set(\"log_hour\",datetime.getHours())\n            .set(\"log_minute\",datetime.getMinutes())\n            .set(\"log_fulltime\",\"$NOW()\")\n            .set(\"memory_max\", rst.memoryMax)\n            .set(\"memory_total\", rst.memoryTotal)\n            .set(\"memory_used\", rst.memoryUsed)\n            .set(\"thread_peak_count\", rst.threadPeakCount)\n            .set(\"thread_count\", rst.threadCount)\n            .set(\"thread_daemon_count\", rst.threadDaemonCount)\n            .insertBy(\"key,log_date,log_hour,log_minute\");\n      }\n   }catch(err){\n      XUtil.log(err);\n   }\n}\n\nserivers.parallelStream().forEach(execDo);\n\nreturn \"OK\";","note":"服务-运行时信息拉取","plan_state":9,"plan_begin_time":1600048619000,"plan_last_time":1676964359961,"plan_last_timespan":844,"plan_next_time":1676964659961,"plan_interval":"5m","plan_max":0,"plan_count":4618,"create_fulltime":20200914092930,"update_fulltime":1638495543457,"use_whitelist":""},{"file_id":369,"file_type":1,"tag":"water","label":"","path":"/water/_service_runtime_15d_del","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":" var db2 = water.db(\"water/water\");\n var date = Datetime.Now().addDay(-15).getDate();\n \n db2.table(\"water_reg_service_runtime\").where('log_date<?',date).delete();\n\n\n return 'OK';","note":"服务-运行时信息超时删除","plan_state":9,"plan_begin_time":1611072000000,"plan_last_time":1676964059649,"plan_last_timespan":174,"plan_next_time":1676966400649,"plan_interval":"1h","plan_max":0,"plan_count":7042,"create_fulltime":20210120144139,"update_fulltime":20210818172652,"use_whitelist":""},{"file_id":370,"file_type":1,"tag":"water","label":"","path":"/water/msg_stat_sync","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2= water.db('water/water');\n\nlet date = Datetime.Now();\n\nlet yesterday = date.addDay(-1).getDate();\n\n\nlet list1 = db2.exe(\"list::SELECT name, total_num FROM water_reg_service_speed WHERE service=? AND TAG=?\",'_watermsg','topic');\nlet list2 = db2.exe(\"list::SELECT name, total_num FROM water_reg_service_speed_date WHERE service=? AND TAG=? AND log_date=?\",'_watermsg','topic',yesterday);\n\nfor(let m of list1){\n    db2.table('water_msg_topic')\n       .set('stat_msg_day_num',m.total_num)\n       .whereEq('topic_name',m.name)\n       .update();\n}\n\nfor(let m of list2){\n    db2.table('water_msg_topic')\n       .set('stat_msg_day_num','$stat_msg_day_num+'+m.total_num)\n       .whereEq('topic_name',m.name)\n       .update();\n}\n\nreturn 'OK';\n\n","note":"消息统计同步","plan_state":9,"plan_begin_time":1619193600000,"plan_last_time":1676964059650,"plan_last_timespan":207,"plan_next_time":1676964600650,"plan_interval":"10m","plan_max":0,"plan_count":617,"create_fulltime":20210424182443,"update_fulltime":20211104122405,"use_whitelist":""},{"file_id":371,"file_type":1,"tag":"water","label":"","path":"/water/log_stat_sync","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2= water.db('water/water');\nlet date = Datetime.Now();\n\nlet yesterday = date.addDay(-1).getDate();\nlet beforeday = date.addDay(-1).getDate();\n\nlet list1 = db2.exe(\"list::SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed WHERE service=? AND TAG=?\",'_waterlog','logger');\nlet list2 = db2.exe(\"list::SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed_date WHERE service=? AND TAG=? AND log_date=?\",'_waterlog','logger',yesterday);\nlet list3 = db2.exe(\"list::SELECT name, total_num, total_num_slow5 FROM water_reg_service_speed_date WHERE service=? AND TAG=? AND log_date=?\",'_waterlog','logger',beforeday);\n\n\nXUtil.tran(()=>{\n    for(let m of list1){\n        db2.table('water_cfg_logger')\n        .set('row_num_today',m.total_num)\n        .set('row_num_today_error',m.total_num_slow5)\n        .whereEq('logger',m.name)\n        .update();\n    }\n});\n\nXUtil.tran(()=>{\n    for(let m of list2){\n        db2.table('water_cfg_logger')\n        .set('row_num_yesterday',m.total_num)\n        .set('row_num_yesterday_error',m.total_num_slow5)\n        .whereEq('logger',m.name)\n        .update();\n    }\n});\n\nXUtil.tran(()=>{\n    for(let m of list3){\n        db2.table('water_cfg_logger')\n        .set('row_num_beforeday',m.total_num)\n        .set('row_num_beforeday_error',m.total_num_slow5)\n        .whereEq('logger',m.name)\n        .update();\n    }\n});\n\nreturn 'OK';\n\n","note":"日志统计同步","plan_state":9,"plan_begin_time":1619193600000,"plan_last_time":1676964059650,"plan_last_timespan":531,"plan_next_time":1676964600650,"plan_interval":"10m","plan_max":0,"plan_count":576,"create_fulltime":20210424192104,"update_fulltime":1676964232603,"use_whitelist":""},{"file_id":372,"file_type":1,"tag":"water","label":"","path":"/water/speed_sync","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let util = requireX('/water/speed_sync.fun');\n\nlet rd = water.rd('water/water_redis',5);\n\nlet rlist = rd.open1(function(ru){\n  return ru.key('monitor_keys').hashGetAll();\n});\n\nvar jlist = [];\nrlist.forEach(function(k,v){\n  jlist.push(k);\n});\n\nXUtil.log('monitor_keys.size = ' + jlist.length);\n\nlet now = new Datetime();\n\nlet log_date = now.toString('yyyyMMdd');\nlet list = XUtil.newList();\n\nfor(let i in jlist){\n  let ikey = jlist[i];\n  let dkey = ikey +'$'+ log_date;\n\n  let dd = rd.open1((ru)=>{\n  return ru.key(dkey).hashGetAll();\n  });\n\n  if(dd && dd.size()>0){\n    let ss = ikey.split('$');\n    let mm = util.map2json(dd);\n\n    mm.service = ss[0];\n    mm.tag = ss[1];\n    mm.name_md5 = ss[2];\n    mm.name = WaterClient.Track.getName(mm.name_md5);\n    mm.name_md5 = WaterClient.Track.getNameMd5(mm.name_md5);//兼容旧的数据\n    mm.lastupdated = rlist.get(ikey);\n\n    if(mm.lastupdated){\n      if(mm.lastupdated.indexOf('-') < 0){\n        mm.lastupdated = mm.lastupdated;\n      }else{\n        mm.lastupdated = Datetime.parse(mm.lastupdated, \"yyyy-MM-dd HH:mm:ss\").getTicks();\n      }\n    }\n\n    if(mm.name && mm.name.length > 900){\n      mm.name = mm.name.substr(0,900);\n    }\n\n\n    if(mm.service && mm.service != 'null'){\n        list.add(mm);\n    }\n  }\n}\n\nXUtil.tran(()=>{\n  for(let mm of list){\n    util.speed_log(mm);\n  }\n});\n\nreturn 'OK';\n\n","note":"接口性能-从Reids同步概况数据","plan_state":9,"plan_begin_time":1588723200000,"plan_last_time":1676964301182,"plan_last_timespan":3251,"plan_next_time":1676964600182,"plan_interval":"5m","plan_max":0,"plan_count":5240,"create_fulltime":20200506173845,"update_fulltime":1676964232265,"use_whitelist":""},{"file_id":373,"file_type":1,"tag":"water","label":"","path":"/water/speed_sync_date","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let util = requireX('/water/speed_sync.fun');\n\nlet rd = water.rd('water/water_redis',5);\n\nlet rlist = rd.open1(function(ru){\n  return ru.key('monitor_keys').hashGetAll();\n});\n\nvar jlist = [];\nrlist.forEach(function(k,v){\n  jlist.push(k);\n});\n\nXUtil.log('monitor_keys.size = ' + jlist.length);\n\nlet now = new Datetime();\n\nlet log_date = now.toString('yyyyMMdd');\nlet list = XUtil.newList();\n\nfor(var i in jlist){\n  let ikey = jlist[i];\n  let dkey = ikey +'$'+ log_date;\n\n  let dd = rd.open1((ru)=>{\n    return ru.key(dkey).hashGetAll();\n  });\n\n  if(dd && dd.size()>0){\n    let ss = ikey.split('$');\n    let mm = util.map2json(dd);\n\n    mm.service = ss[0];\n    mm.tag = ss[1];\n    mm.name_md5 = ss[2];\n    mm.name = WaterClient.Track.getName(mm.name_md5);\n    mm.name_md5 = WaterClient.Track.getNameMd5(mm.name_md5);//兼容旧的数据\n    mm.log_date = log_date;\n\n    if(mm.name && mm.name.length > 900){\n      mm.name = mm.name.substr(0,900);\n    }\n\n    if(mm.service && mm.service != 'null'){\n        list.add(mm);\n    }\n  }\n}\n\nXUtil.tran(()=>{\n  for(let mm of list){\n    util.speed_log_date(mm);\n  }\n});\n\n\n\nreturn 'OK';\n\n","note":"接口性能-从Reids同步日纬度数据","plan_state":9,"plan_begin_time":1588723200000,"plan_last_time":1676964301182,"plan_last_timespan":3060,"plan_next_time":1676964600182,"plan_interval":"5m","plan_max":0,"plan_count":5276,"create_fulltime":20200506173856,"update_fulltime":1676964232432,"use_whitelist":""},{"file_id":374,"file_type":1,"tag":"water","label":"","path":"/water/speed_sync_hour","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let util = requireX('/water/speed_sync.fun');\n\nlet rd = water.rd('water/water_redis',5);\n\nlet rlist = rd.open1(function(ru){\n  return ru.key('monitor_keys').hashGetAll();\n});\n\nvar jlist = [];\nrlist.forEach(function(k,v){\n  jlist.push(k);\n});\n\nXUtil.log('monitor_keys.size = ' + jlist.length);\n\nlet now = new Datetime();\n\nlet log_date = now.toString('yyyyMMdd');\nlet log_hour = now.toString('HH');\nlet list = XUtil.newList();\n\n\nfor(let i in jlist){\n  let ikey = jlist[i];\n  let dkey = ikey +'$'+ log_date + log_hour;\n\n  let dd = rd.open1((ru)=>{\n  return ru.key(dkey).hashGetAll();\n  });\n\n  if(dd && dd.size()>0){\n    let ss = ikey.split('$');\n    let mm = util.map2json(dd);\n\n    mm.service = ss[0];\n    mm.tag = ss[1];\n    mm.name_md5 = ss[2];\n    mm.name = WaterClient.Track.getName(mm.name_md5);\n    mm.name_md5 = WaterClient.Track.getNameMd5(mm.name_md5);//兼容旧的数据\n    mm.log_date = log_date;\n    mm.log_hour = log_hour;\n\n    if(mm.name && mm.name.length > 900){\n      mm.name = mm.name.substr(0,900);\n    }\n\n    if(mm.service && mm.service != 'null'){\n        list.add(mm);\n    }\n  }\n}\n\nXUtil.tran(()=>{\n  for(let mm of list){\n    util.speed_log_hour(mm);\n  }\n});\n\nreturn 'OK';\n","note":"接口性能-从Reids同步时纬度数据","plan_state":9,"plan_begin_time":1588723200000,"plan_last_time":1676964301183,"plan_last_timespan":3001,"plan_next_time":1676964600183,"plan_interval":"5m","plan_max":0,"plan_count":5278,"create_fulltime":20200506173905,"update_fulltime":1676964232516,"use_whitelist":""},{"file_id":375,"file_type":1,"tag":"water","label":"","path":"/water/speed_sync.fun","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"this.map2json = function (map){\n  var obj = {};\n  map.forEach(function(k,v){\n    obj[k] = v;\n  });\n  \n  return obj;\n}\n\n\n\nthis.speed_log = function(m){\n    if(!m.tag || !m.name || !m.average){\n       return 'ERROR';\n    }\n    \n    if(!m.total_num_slow1){\n      m.total_num_slow1=0;\n    }\n    \n    if(!m.total_num_slow2){\n      m.total_num_slow2=0;\n    }\n    \n    if(!m.total_num_slow5){\n      m.total_num_slow5=0;\n    }\n    \n    if(!m.slowest){\n      m.slowest=0;\n    }\n    \n    if(!m.fastest){\n      m.fastest=0;\n    }\n    \n    water.db('water/water')\n      .table('water_reg_service_speed')\n      .set('average',m.average).set('fastest',m.fastest)\n      .set('slowest',m.slowest).set('total_num',m.total_num)\n      .set('service',m.service)\n      .set('tag',m.tag)\n      .set('name_md5',m.name_md5)\n      .set('name',m.name)\n      .set('total_num_slow1',m.total_num_slow1)\n      .set('total_num_slow2',m.total_num_slow2)\n      .set('total_num_slow5',m.total_num_slow5)\n      .build(function(tb){\n        if(m.lastupdated){\n          tb.set('gmt_modified',m.lastupdated);\n        }\n      })\n      .upsert('service,tag,name_md5');\n    \n    return 'OK';\n}\n\nthis.speed_log_date = function(m){\n    if(!m.tag || !m.name || !m.average || !m.log_date){\n       return 'ERROR';\n    }\n    \n    if(!m.slowest){\n      m.slowest=0;\n    }\n    \n    if(!m.fastest){\n      m.fastest=0;\n    }\n    \n    if(m.total_time){\n       m.average = parseInt(m.total_time/m.total_num);\n    }\n    \n    water.db('water/water')\n      .table('water_reg_service_speed_date')\n      .set('average',m.average).set('fastest',m.fastest)\n      .set('slowest',m.slowest).set('total_num',m.total_num)\n      .set('service',m.service)\n      .set('tag',m.tag)\n      .set('name',m.name)\n      .set('name_md5',m.name_md5)\n      .set('log_date',m.log_date)\n      .build(function(tb){\n        if(m.total_num_slow1){\n        tb.set('total_num_slow1',m.total_num_slow1);\n      }\n      \n        if(m.total_num_slow2){\n       tb.set('total_num_slow2',m.total_num_slow2);\n      }\n      \n        if(m.total_num_slow5){\n       tb.set('total_num_slow5',m.total_num_slow5);\n      }\n      })\n      .upsert('service,tag,name_md5,log_date');\n    \n    return 'OK';    \n}\n\n\nthis.speed_log_hour = function(m){\n    if(!m.tag || !m.name || !m.average || !m.log_date || !m.log_hour){\n       return 'ERROR';\n    }\n    \n    if(!m.slowest){\n      m.slowest=0;\n    }\n    \n    if(!m.fastest){\n      m.fastest=0;\n    }\n    \n    water.db('water/water')\n      .table('water_reg_service_speed_hour')\n      .set('average',m.average).set('fastest',m.fastest)\n      .set('slowest',m.slowest).set('total_num',m.total_num)\n      .set('service',m.service)\n      .set('tag',m.tag)\n      .set('name',m.name)\n      .set('name_md5',m.name_md5)\n      .set('log_date',m.log_date)\n      .set('log_hour',m.log_hour)\n      .build(function(tb){\n        if(m.total_num_slow1){\n       tb.set('total_num_slow1',m.total_num_slow1);\n      }\n      \n        if(m.total_num_slow2){\n       tb.set('total_num_slow2',m.total_num_slow2);\n      }\n      \n        if(m.total_num_slow5){\n       tb.set('total_num_slow5',m.total_num_slow5);\n      }\n      })\n      .upsert('service,tag,name_md5,log_date,log_hour');\n    \n    \n    return 'OK';    \n}\n\n\n","note":"接口性能-公共函数","plan_state":1,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"1h","plan_max":0,"plan_count":0,"create_fulltime":20200506174048,"update_fulltime":1637651952119,"use_whitelist":""},{"file_id":378,"file_type":3,"tag":"_demo","label":"@demo.topic.name","path":"/_demo/demo.topic.name","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"\nlet eventDo = ctx.attr('event'); //::MessageM{times,trace_id,key,topic,message,sgin,tags,toJson()}\n\nif(eventDo){\n    XUtil.log(\"event: \" + eventDo.toJson());\n    XUtil.log(\"event.message: \" + eventDo.message);\n}else{\n    XUtil.log(\"no event\")\n}\n\n\n//返回大写的OK，才算事件执行成功\nreturn 'OK';","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20210819122931,"update_fulltime":20211025134908,"use_whitelist":""},{"file_id":379,"file_type":1,"tag":"water","label":"","path":"/water/msg_alarm","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let hub = Java.type('org.noear.water.protocol.ProtocolHub');\n\nlet alarm_sign = XUtil.cfgGet('water/alarm_sign');\n\nfor(let ms of hub.getMsgBrokerList()){\n    let num = ms.getSource().getWarnCount();\n\n    if(num > 10){\n        let msg = `预警：未派发消息数::${num}`;\n        let sgin = `[${ms.getName()}][${alarm_sign}]`;\n\n        water.heihei('@alarm', msg, sgin);\n    }\n}\n\n","note":"消息尝试告警","plan_state":9,"plan_begin_time":1609430400000,"plan_last_time":1676964481450,"plan_last_timespan":15,"plan_next_time":1676964540450,"plan_interval":"1m","plan_max":0,"plan_count":3803,"create_fulltime":20211104114704,"update_fulltime":1637391300039,"use_whitelist":""},{"file_id":380,"file_type":0,"tag":"water","label":"","path":"/water/code/generate","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"\nlet tag = ctx.param('tag');\nlet key = ctx.param('key');\nlet tb  = ctx.param(\"tb\");\n\nlet db2 = water.db(tag+'/'+key);\n\n\nlet tbs = XUtil.newList();\n\ndb2.getMetaData().getTableAll().forEach((tw)=>{\n    tbs.add(tw.getName());\n});\n\ntbs.sort(null);\n\nreturn {code: 1, msg:\"成功\", tbs: tbs};\n\n","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"create_fulltime":20211107072624,"update_fulltime":1644927696387,"use_whitelist":""},{"file_id":382,"file_type":2,"tag":"_code","label":"","path":"/_code/java_model2","rank":-1,"is_staticize":true,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"freemarker","content_type":"","content":"import lombok.Data;\nimport java.util.*;\n\n@Data\npublic class ${table_camel!}Do {\n    \n    <#list fields!! as f>\n  /** ${(f.comment)!} */\n    public ${(f.type2)!} ${(f.field)!};\n    </#list>\n\n}","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"update_fulltime":1637763140180,"use_whitelist":""},{"file_id":405,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/del_stat_360d","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\nvar date = Datetime.Now().addDay(-360).getDate();  //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -360 DAY),'%Y%m%d')\nvar date2 = Datetime.Now().addDay(-90).getDate(); //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -90 DAY),'%Y%m%d')\n\ndb2.exe(`DELETE FROM stat_city_date_pv_uv_ip WHERE log_date <?`, date);\ndb2.exe(`DELETE FROM stat_ua_client_date_pv_uv_ip WHERE log_date <?`, date);\ndb2.exe(`DELETE FROM stat_ua_platform_date_pv_uv_ip WHERE log_date <?`, date);\n\n\ndb2.exe(`DELETE FROM stat_date_hour_pv_uv_ip WHERE log_date <?  AND log_hour>=0`, date2);\n\ndb2.exe(`DELETE FROM stat_track_date_hour_pv_uv_ip WHERE log_date <?`, date2);\n\nreturn \"OK\";\n","note":"删除超360天的统计数据","plan_state":9,"plan_begin_time":1592064000000,"plan_last_time":1649779200737,"plan_last_timespan":21982,"plan_next_time":1649865600737,"plan_interval":"1d","plan_max":0,"plan_count":39,"create_fulltime":20200615113928,"update_fulltime":20200819115431,"use_whitelist":""},{"file_id":406,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/del_track_log_30d","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\nvar date = Datetime.Now().addDay(-30).getDate(); //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -30 DAY),'%Y%m%d')\n\ndb2.exe(`DELETE FROM short_redirect_log_30d WHERE log_date <= ?`, date);\n\nreturn 'OK';","note":"删除超30天的日志数据","plan_state":9,"plan_begin_time":1592064000000,"plan_last_time":1649779200738,"plan_last_timespan":9136,"plan_next_time":1649865600738,"plan_interval":"1d","plan_max":0,"plan_count":39,"create_fulltime":20200615114245,"update_fulltime":20200819115456,"use_whitelist":""},{"file_id":407,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/ip_city_code","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\n//\n// old::APPCODE 42a57d3dd8c543a291ff9d5a06a4fb77\n//\n// new::APPCODE 4a18b43e438942fb940f68e1e250f5d3\n//\nfunction doItem(item){\n  let txt  = XUtil.http(\"http://iploc.market.alicloudapi.com/v3/ip?ip=\"+item.ip_val)\n                  .header(\"Authorization\",\"APPCODE 4a18b43e438942fb940f68e1e250f5d3\").get();\n  let ipx = JSON.parse(txt);\n  \n  if(typeof(ipx.adcode) == 'string'){\n    db2.exe(`UPDATE code_ip SET city_name=?,city_code=?,is_checked=1 WHERE ip_id =?`, ipx.city, ipx.adcode, item.ip_id);\n  }else{\n    db2.exe(`UPDATE code_ip SET is_checked = 1 WHERE ip_id = ?`, item.ip_id);\n }\n}\n\n\nlet list = db2.exe(`list::SELECT * FROM code_ip WHERE city_code=0 AND is_checked=0 LIMIT 2000`);\n\nif(list){\n  XUtil.log(\"size: \" + list.size());\n\n  list.parallelStream().forEach((item)=>{\n    doItem(item);\n  });\n}\n\nreturn 'OK';","note":"根据IP获取城市码-任务0","plan_state":9,"plan_begin_time":1592193207000,"plan_last_time":1649808088796,"plan_last_timespan":38,"plan_next_time":1649808687796,"plan_interval":"10m","plan_max":0,"plan_count":5402,"create_fulltime":20200615114652,"update_fulltime":1646191885741,"use_whitelist":""},{"file_id":408,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/notice_stat","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"var date1  = Datetime.Now().addDay(-1).getDate(); //SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY),'%Y%m%d')\n\n// XUtil.http(\"http://water.zmapi.cn/msg/send/\")\n//      .data(\"key\",XUtil.guid())\n//      .data(\"topic\",\"sponge.stat.notice\")\n//      .data(\"message\",date1)\n//      .post();\n\n\nwater.sendMessage(\"sponge.stat.notice\", date1+'');\n\nreturn 'OK';","note":"定时发现统计通知（由别人去统计）","plan_state":9,"plan_begin_time":1592196183000,"plan_last_time":1649808064442,"plan_last_timespan":18,"plan_next_time":1649808663442,"plan_interval":"10m","plan_max":0,"plan_count":5406,"create_fulltime":20200615115438,"update_fulltime":20200615120044,"use_whitelist":""},{"file_id":409,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/stat_city","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\nlet date1  = new Datetime().getDate();\n\n\ndb2.exe(`UPDATE short_redirect_log_30d l, code_ip u\nSET l.log_city_code = (u.city_code/10000)*10000\nWHERE l.log_city_code=0 AND l.log_ip_id = u.ip_id AND u.city_code>0`);\n\n\ndb2.exe(`DELETE FROM stat_city_date_pv_uv_ip WHERE log_date = ?`, date1);\n\n\ndb2.exe(`INSERT INTO stat_city_date_pv_uv_ip(url_id,tag_id,province_code,log_date,pv,uv,ip)\nSELECT -1,tag_id,log_city_code,log_date,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\nFROM short_redirect_log_30d \nWHERE log_date = ?\nGROUP BY tag_id,log_city_code`, date1);\n\n\ndb2.exe(`INSERT INTO stat_city_date_pv_uv_ip(url_id,tag_id,province_code,log_date,pv,uv,ip)\nSELECT url_id,any_value(tag_id),log_city_code,log_date,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\nFROM short_redirect_log_30d \nWHERE log_date = ?\nGROUP BY url_id,log_city_code`, date1);\n\n\n/* update uv2 */\ndb2.exe(`UPDATE stat_city_date_pv_uv_ip t,(\n   SELECT tag_id,province_code,log_date,SUM(uv) uv2 \n   FROM stat_city_date_pv_uv_ip \n   WHERE log_date= ? AND url_id<>-1\n    GROUP BY tag_id,province_code,log_date\n) t2\nSET t.uv2 = t2.uv2\nWHERE t.tag_id = t2.tag_id AND t.province_code = t2.province_code AND t.log_date = t2.log_date AND t.url_id=-1`, date1);\n\nreturn 'OK';\n","note":"统计城市数据","plan_state":9,"plan_begin_time":1592196189000,"plan_last_time":1649808370114,"plan_last_timespan":193,"plan_next_time":1649808669114,"plan_interval":"5m","plan_max":0,"plan_count":797,"create_fulltime":20200615121043,"update_fulltime":1646123959643,"use_whitelist":""},{"file_id":410,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/stat_ua_client","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\n\nvar date1  = new Datetime().getDate();\n\n\ndb2.exe(`DELETE FROM stat_ua_client_date_pv_uv_ip WHERE log_date = ?`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_client_date_pv_uv_ip(url_id,tag_id,ua_client,log_date,pv,uv,ip)\nSELECT -1,s.tag_id,u.client,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.tag_id,u.client`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_client_date_pv_uv_ip(url_id,tag_id,ua_client,log_date,pv,uv,ip)\nSELECT s.url_id,any_value(s.tag_id),u.client,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.url_id,u.client`, date1);\n\n/* update uv2 */\ndb2.exe(`UPDATE stat_ua_client_date_pv_uv_ip t,(\n    SELECT tag_id,ua_client,log_date,SUM(uv) uv2 \n   FROM stat_ua_client_date_pv_uv_ip \n    WHERE log_date= ? AND url_id<>-1\n    GROUP BY tag_id,ua_client,log_date\n) t2\nSET t.uv2 = t2.uv2\nWHERE t.tag_id = t2.tag_id AND t.ua_client = t2.ua_client AND t.log_date = t2.log_date AND t.url_id=-1`, date1);\n\nreturn 'OK';\n","note":"统计客户端UA数据","plan_state":9,"plan_begin_time":1592196194000,"plan_last_time":1649808375185,"plan_last_timespan":150,"plan_next_time":1649808674185,"plan_interval":"5m","plan_max":0,"plan_count":798,"create_fulltime":20200615121057,"update_fulltime":1646123995142,"use_whitelist":""},{"file_id":411,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/stat_ua_platform","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\nvar date1  = new Datetime().getDate();\n\n\ndb2.exe(`DELETE FROM stat_ua_platform_date_pv_uv_ip WHERE log_date = ?`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_platform_date_pv_uv_ip(url_id,tag_id,ua_platform,log_date,pv,uv,ip)\nSELECT -1,s.tag_id,u.platform,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.tag_id,u.platform`, date1);\n\n\ndb2.exe(`INSERT INTO stat_ua_platform_date_pv_uv_ip(url_id,tag_id,ua_platform,log_date,pv,uv,ip)\nSELECT s.url_id,any_value(s.tag_id),u.platform,log_date,COUNT(*) pv,COUNT(DISTINCT s.user_key) uv,COUNT(DISTINCT s.log_ip_id) ip\nFROM short_redirect_log_30d s INNER JOIN code_ua u ON s.log_ua_id=u.ua_id\nWHERE s.log_date = ?\nGROUP BY s.url_id,u.platform`, date1);\n\n\n/* update uv2 */\ndb2.exe(`UPDATE stat_ua_platform_date_pv_uv_ip t,(\n    SELECT tag_id,ua_platform,log_date,SUM(uv) uv2 \n   FROM stat_ua_platform_date_pv_uv_ip \n    WHERE log_date= ? AND url_id<>-1\n    GROUP BY tag_id,ua_platform,log_date\n) t2\nSET t.uv2 = t2.uv2\nWHERE t.tag_id = t2.tag_id AND t.ua_platform = t2.ua_platform AND t.log_date = t2.log_date AND t.url_id=-1`, date1);\n\nreturn 'OK';\n","note":"统计平台UA数据","plan_state":9,"plan_begin_time":1592196199000,"plan_last_time":1649808380252,"plan_last_timespan":145,"plan_next_time":1649808679252,"plan_interval":"5m","plan_max":0,"plan_count":798,"create_fulltime":20200615121108,"update_fulltime":1646124037158,"use_whitelist":""},{"file_id":412,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/stat_url","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\n\nlet date1  = Datetime.Now().addDay(-1).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY),'%Y%m%d')\nlet date30 = Datetime.Now().addDay(-30).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -30 DAY),'%Y%m%d')\nlet date0  = Datetime.Now().getDate(); //$<SELECT DATE_FORMAT(NOW(),'%Y%m%d')\nlet dateX  = 0;\nlet hour0  = Datetime.Now().getHours();\n\n\nif(hour0>=4){\n  dateX = date0;\n}else{\n  dateX = date1;\n}\n\ndb2.exe(`DELETE FROM stat_date_hour_pv_uv_ip WHERE log_date>=?`, dateX);\n\nfunction stat_url() {\n\n  /*统计典线图：日数据*/\n db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n    SELECT url_id,any_value(tag_id),log_date,-1, COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY url_id,log_date`, dateX);\n\n    db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n    SELECT -1,tag_id,log_date,-1, COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY tag_id,log_date`, dateX);\n    \n  /*update date uv2*/\n db2.exe(`UPDATE stat_date_hour_pv_uv_ip t,(\n   SELECT tag_id,log_date,SUM(uv) uv2 \n   FROM stat_date_hour_pv_uv_ip \n   WHERE log_date>= ? AND log_hour=-1 AND url_id<>-1\n   GROUP BY tag_id,log_date\n        ) t2\n      SET t.uv2 = t2.uv2\n      WHERE t.tag_id = t2.tag_id AND t.log_date = t2.log_date AND t.log_hour=-1 AND t.url_id=-1`, dateX);\n   \n\n  /*统计典线图：小时数据*/\n    db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n    SELECT url_id,any_value(tag_id),log_date, log_hour,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY url_id,log_date,log_hour`, dateX);\n\n    db2.exe(`INSERT INTO stat_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,pv,uv,ip)\n   SELECT -1,tag_id,log_date, log_hour,COUNT(*) pv,COUNT(DISTINCT user_key) uv,COUNT(DISTINCT log_ip_id) ip\n    FROM short_redirect_log_30d \n    WHERE log_date>=?\n   GROUP BY tag_id,log_date,log_hour`, dateX);\n   \n  /*update hour uv2*/\n db2.exe(`UPDATE stat_date_hour_pv_uv_ip t,(\n   SELECT tag_id,log_date,log_hour,SUM(uv) uv2 \n    FROM stat_date_hour_pv_uv_ip \n   WHERE log_date>= ? AND log_hour<>-1 AND url_id<>-1\n    GROUP BY tag_id,log_date,log_hour\n        ) t2\n      SET t.uv2 = t2.uv2\n      WHERE t.tag_id = t2.tag_id AND t.log_date = t2.log_date AND t.log_hour=t2.log_hour AND t.url_id=-1`, dateX);\n}\n\nfunction stat_url_sum(){\n  /*总量统计：url记录昨日数据*/\n  db2.exe(`UPDATE short_url_ex_stat SET uv_yesterday=0,pv_yesterday=0,ip_yesterday=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE short_url_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_yesterday = ss.uv, se.pv_yesterday = ss.pv, se.ip_yesterday = ss.ip\n WHERE se.url_id = ss.url_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id>0`, date1);\n  \n  /*总量统计：url记录今日数据*/\n  db2.exe(`UPDATE short_url_ex_stat SET uv_today=0,pv_today=0,ip_today=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE short_url_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_today = ss.uv, se.pv_today = ss.pv, se.ip_today = ss.ip\n WHERE se.url_id = ss.url_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id>0`, date0);\n\n  /*总量统计：url合计总数*/\n  db2.exe(`TRUNCATE TABLE _tmp_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_total_pv_uv_ip(obj_id,pv,uv,ip)\n SELECT url_id,SUM(pv) pv, SUM(uv) uv,SUM(ip) ip\n FROM stat_date_hour_pv_uv_ip WHERE log_date>=? AND log_hour=-1 AND url_id>0 GROUP BY url_id`, date30);\n\n    db2.exe(`UPDATE short_url_ex_stat SET uv_total=0,pv_total=0,ip_total=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE short_url_ex_stat u, _tmp_total_pv_uv_ip s\n  SET u.pv_total = s.pv, u.uv_total = s.uv, u.ip_total = s.ip\n WHERE u.url_id = s.obj_id`);\n\n\n\n  /*总量统计：tag记录昨日数据*/\n  db2.exe(`UPDATE track_tag_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_yesterday = ss.uv, se.pv_yesterday = ss.pv, se.ip_yesterday = ss.ip\n WHERE se.tag_id = ss.tag_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id=-1`, date1);\n \n  /*总量统计：tag记录今日数据*/\n  db2.exe(`UPDATE track_tag_ex_stat SET uv_today=0,pv_today=0,ip_today=0 WHERE 1=1`);\n \n  db2.exe(`UPDATE track_tag_ex_stat se, stat_date_hour_pv_uv_ip ss\n  SET se.uv_today = ss.uv, se.pv_today = ss.pv, se.ip_today = ss.ip\n WHERE se.tag_id = ss.tag_id AND ss.log_date=? AND ss.log_hour=-1 AND ss.url_id=-1`, date0);\n \n  /*总量统计：tag合计总数*/\n  db2.exe(`TRUNCATE TABLE _tmp_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_total_pv_uv_ip(obj_id,pv,uv,ip)\n SELECT tag_id,SUM(pv) pv, SUM(uv) uv,SUM(ip) ip\n FROM stat_date_hour_pv_uv_ip WHERE log_date>=? AND log_hour=-1 AND url_id=-1 GROUP BY tag_id`,date30);\n  \n  db2.exe(`UPDATE track_tag_ex_stat u, _tmp_total_pv_uv_ip s\n  SET u.pv_total = s.pv, u.uv_total = s.uv, u.ip_total = s.ip\n WHERE u.tag_id = s.obj_id`);\n}\n\nstat_url();\nstat_url_sum();\n\nreturn 'OK';\n","note":"统计URL数据","plan_state":9,"plan_begin_time":1592196205000,"plan_last_time":1649808386368,"plan_last_timespan":762,"plan_next_time":1649808505368,"plan_interval":"2m","plan_max":0,"plan_count":6982,"create_fulltime":20200615121124,"update_fulltime":1646124101107,"use_whitelist":""},{"file_id":413,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/stat_url_track","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\nlet date1  = Datetime.Now().addDay(-1).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY),'%Y%m%d')\nlet date30 = Datetime.Now().addDay(-30).getDate(); //$<SELECT DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -30 DAY),'%Y%m%d')\nlet date0  = Datetime.Now().getDate(); //$<SELECT DATE_FORMAT(NOW(),'%Y%m%d')\nlet dateX  = 0;\nlet hour0  = Datetime.Now().getHours();\n\n\nif(hour0>=4){\n  dateX = date0;\n}else{\n  dateX = date1;\n}\n\n\ndb2.exe(`DELETE FROM stat_track_date_hour_pv_uv_ip WHERE log_date>=?`, dateX);\n\nfunction stat_track(i) {\n /*url*/\n let url_ids = db2.exe(`list::SELECT url_id FROM short_url WHERE track_params_num>=?`, i).stream().map(m1 => m1.url_id).toArray();\n \n  if(url_ids){\n    for(let j in url_ids){\n        db2.exe(`INSERT INTO stat_track_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,vi,vd,uv,pv,ip)\n      SELECT url_id,any_value(tag_id),log_date,-1,${i},v${i},COUNT(DISTINCT user_key) uv,COUNT(*) pv,COUNT(DISTINCT log_ip_id) ip\n      FROM short_redirect_log_30d \n      WHERE log_date>=? AND url_id =?\n     GROUP BY url_id,log_date,v${i}`, dateX, url_ids[j]);\n      \n      \n      db2.exe(`INSERT INTO stat_track_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,vi,vd,uv,pv,ip)\n      SELECT url_id,any_value(tag_id),log_date,log_hour,${i},v${i},COUNT(DISTINCT user_key) uv,COUNT(*) pv,COUNT(DISTINCT log_ip_id) ip\n      FROM short_redirect_log_30d \n      WHERE log_date>=? AND url_id =?\n     GROUP BY url_id,log_date,log_hour,v${i}`, dateX, url_ids[j]);\n   }\n }\n\n /*tag*/\n let tag_ids = db2.exe(`list::SELECT tag_id FROM track_tag WHERE t_track_params_num>=${i}`).stream().map(m1 => m1.tag_id).toArray();\n if(tag_ids){\n    for(let j in tag_ids){\n        db2.exe(`INSERT INTO stat_track_date_hour_pv_uv_ip(url_id,tag_id,log_date,log_hour,vi,vd,uv,pv,ip)\n      SELECT -1,tag_id,log_date,-1,${i},v${i},COUNT(DISTINCT user_key) uv,COUNT(*) pv,COUNT(DISTINCT log_ip_id) ip\n      FROM short_redirect_log_30d \n      WHERE log_date>=? AND tag_id = ?\n      GROUP BY tag_id,log_date,v${i}`, dateX, tag_ids[j]);\n    }\n }\n}\n\nfunction stat_track_sum(){\n\n  /*url total*/\n db2.exe(`TRUNCATE short_url_ex_track_stat`);\n  \n  db2.exe(`INSERT INTO short_url_ex_track_stat(url_id,tag_id,vi,vd,uv_total,pv_total,ip_total)\n  SELECT url_id,any_value(tag_id),vi,vd,SUM(uv) uv,SUM(pv) pv,SUM(ip) ip \n  FROM stat_track_date_hour_pv_uv_ip \n WHERE log_date>=? AND log_hour=-1 AND url_id>0\n  GROUP BY url_id,vi,vd`, date30);\n  \n  \n  /*url yesday*/\n  db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT url_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id>0`, date1);\n \n  db2.exe(`UPDATE short_url_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_yesterday = t.uv, s.pv_yesterday = t.pv, s.ip_yesterday = t.ip\n WHERE s.url_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n  \n  /*url today*/\n db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT url_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id>0`, date0);\n \n  db2.exe(`UPDATE short_url_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_today = t.uv, s.pv_today = t.pv, s.ip_today = t.ip\n WHERE s.url_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n  \n  \n  /*tag total*/\n db2.exe(`TRUNCATE track_tag_ex_track_stat`);\n  \n  db2.exe(`INSERT INTO track_tag_ex_track_stat(tag_id,vi,vd,uv_total,pv_total,ip_total)\n SELECT tag_id,vi,vd,SUM(uv) uv,SUM(pv) pv,SUM(ip) ip \n FROM stat_track_date_hour_pv_uv_ip \n WHERE log_date>=? AND log_hour=-1 AND url_id=-1\n GROUP BY tag_id,vi,vd`, date30);\n  \n  \n  /*tag yesday*/\n  db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT tag_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id=-1`, date1);\n  \n  db2.exe(`UPDATE track_tag_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_yesterday = t.uv, s.pv_yesterday = t.pv, s.ip_yesterday = t.ip\n WHERE s.tag_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n  \n  /*tag today*/\n db2.exe(`TRUNCATE _tmp_track_total_pv_uv_ip`);\n  \n  db2.exe(`INSERT INTO _tmp_track_total_pv_uv_ip(obj_id,vi,vd,uv,pv,ip)\n SELECT tag_id,vi,vd,uv,pv,ip FROM stat_track_date_hour_pv_uv_ip \n  WHERE log_date=? AND log_hour=-1 AND url_id=-1`, date0);\n  \n  db2.exe(`UPDATE track_tag_ex_track_stat s, _tmp_track_total_pv_uv_ip t\n  SET s.uv_today = t.uv, s.pv_today = t.pv, s.ip_today = t.ip\n WHERE s.tag_id = t.obj_id AND s.vi = t.vi AND s.vd = t.vd`);\n}\n\nstat_track(1);\nstat_track(2);\nstat_track(3);\nstat_track(4);\nstat_track(5);\n\nstat_track_sum();\n\nreturn 'OK';\n\n","note":"统计URL跟踪数据","plan_state":9,"plan_begin_time":1592196211000,"plan_last_time":1649807492048,"plan_last_timespan":995,"plan_next_time":1649809291048,"plan_interval":"30m","plan_max":0,"plan_count":1800,"create_fulltime":20200615121141,"update_fulltime":1646124143847,"use_whitelist":""},{"file_id":414,"file_type":1,"tag":"sponge_track","label":"","path":"/sponge_track/udp_user_agen_p_c","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let db2 = water.db('sponge/sponge_track');\n\nvar begin_id = 0;\n\nvar list1 = db2.exe(`list::SELECT * FROM code_enum WHERE type=1 AND keyword<>'' ORDER BY row_id ASC`);\nvar list2 = db2.exe(`list::SELECT * FROM code_enum WHERE type=2 AND keyword<>'' ORDER BY row_id ASC`);\n\n/*生成平台码*/\nfor(var idx in list1){\n  var m = list1[idx];\n  \n}\n\nfor(var idx in list1){\n  var m = list1[idx];\n  var kl = m.keyword.split('#');\n  for(var jdx in kl){\n var k2 = kl[jdx];\n db2.exe(`UPDATE code_ua SET platform=? WHERE ua_id>? AND platform=0 AND ua_val LIKE ?`, m.value, begin_id, k2);\n  }\n}\n\n\n\n/*生成客户端码（部份）*/\nfor(var idx in list2){\n  var m = list2[idx];\n  var kl = m.keyword.split('#');\n  for(var jdx in kl){\n var k2 = kl[jdx];\n    db2.exe(`UPDATE code_ua SET client=? WHERE ua_id>? AND client=0 AND ua_val LIKE ?`, m.value, begin_id, k2);\n  }\n}\n\n\nreturn 'OK';\n","note":"生成UDP数据","plan_state":9,"plan_begin_time":1592196217000,"plan_last_time":1649808097937,"plan_last_timespan":531,"plan_next_time":1649808697937,"plan_interval":"10m","plan_max":0,"plan_count":5399,"create_fulltime":20200615121159,"update_fulltime":20210508180404,"use_whitelist":""},{"file_id":415,"file_type":1,"tag":"demo","label":"","path":"/demo/_demoapi/_demo_test","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":true,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"return water.job('demoapi','demo_test',{});","note":"","plan_state":8,"plan_begin_time":1647269101000,"plan_last_time":1650556860000,"plan_last_timespan":54,"plan_next_time":0,"plan_interval":"0 1 * * * ?","plan_max":0,"plan_count":1,"create_fulltime":1647269102175,"update_fulltime":1647269102175,"use_whitelist":""},{"file_id":416,"file_type":1,"tag":"water","label":"","path":"/water/_upgrade","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"let upgrade_tag = 'water_upgrade_tag';\n\n//1.版本检测\nlet ver_old_str = XUtil.cfgGet(upgrade_tag);\nif(!ver_old_str){\n    ver_old_str = '0';\n}\n\nlet ver_new = 8;\nlet ver_old = parseInt(ver_old_str);\n\nif(ver_old >= ver_new){\n    return 'No upgrade';\n}\n\n//2.开始更新\n\nlet db2;\n\n//for 2.5.8\nif(ver_old < 1){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //::规则计算\n    let tmpRes = db2.table('grit_resource').whereEq('display_name','规则计算').limit(1).selectMap('*');\n    if(tmpRes.resource_id){\n        let idList = db2.table('grit_resource').whereEq('resource_pid', tmpRes.resource_id).selectArray('resource_id');\n        if(idList.size() > 0){\n            db2.table('grit_resource_linked').whereIn('resource_id',idList).delete();\n            db2.table('grit_resource').whereEq('resource_pid',tmpRes.resource_id).delete();\n            db2.table('grit_resource').whereEq('resource_id',tmpRes.resource_id).delete();\n        }\n    }\n\n    //::Ops\n    tmpRes = db2.table('grit_resource').whereEq('display_name','计算资源').limit(1).selectMap('*');\n    let rst = db2.table('grit_resource').set('link_uri','/cfg/server').set('resource_pid',9).set('order_index',21)\n                 .whereEq('resource_id',tmpRes.resource_id).andNeq('resource_pid',9)\n                 .update();\n\n    if(rst){ //如果更新成功\n        tmpRes.remove(\"resource_id\");\n\n        db2.table('grit_resource')\n        .setMap(tmpRes).set('display_name','$').set('order_index',20).set('link_uri','').set('resource_pid',9).set(\"guid\", XUtil.guid())\n        .usingNull(false)\n        .usingExpr(false)\n        .insert();\n    }\n\n    idList = db2.table('grit_resource').whereEq('resource_pid',13).selectArray('resource_id');\n    if(idList.size() > 0){\n        db2.table('grit_resource_linked').whereIn('resource_id',idList).delete();\n        db2.table('grit_resource').whereEq('resource_pid',13).delete();\n        db2.table('grit_resource').whereEq('resource_id',13).delete();\n    }\n\n    //::Dev\n    db2.table('grit_resource').set('display_name','开发助手').whereEq('resource_id',12).update();\n\n    //::FaaS\n    db2.table('grit_resource').set('display_name','函数计算').whereEq('resource_id',10).update();\n}\n\n//for 2.6.0\nif(ver_old < 2){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //::安全名单\n    let tmlRes = db2.table('grit_resource').whereEq('display_name','安全名单').limit(1).selectMap('*');\n    tmlRes.remove(\"resource_id\");\n\n    //::访问密钥\n    if(db2.table('grit_resource').whereEq('resource_pid',tmlRes.resource_pid).andEq('link_uri','/cfg/key').selectExists() == false){\n        db2.table('grit_resource')\n            .setMap(tmlRes).set('display_name','访问密钥').set('order_index',12).set('link_uri','/cfg/key').set(\"guid\", XUtil.guid())\n            .usingNull(false)\n            .usingExpr(false)\n            .insert();\n    }\n\n    //::多语言包\n    if(db2.table('grit_resource').whereEq('resource_pid',tmlRes.resource_pid).andEq('link_uri','/cfg/i18n').selectExists() == false){\n        db2.table('grit_resource')\n            .setMap(tmlRes).set('display_name','多语言包').set('order_index',13).set('link_uri','/cfg/i18n').set(\"guid\", XUtil.guid())\n            .usingNull(false)\n            .usingExpr(false)\n            .insert();\n    }\n\n}\n\n//for 2.6.1\nif(ver_old < 3){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //禁用\n    db2.table('grit_resource').set('is_disabled','1').whereEq('display_name','数据同步').andEq('link_uri','/tool/sync').update();\n    //改名\n    db2.table('grit_resource').set('order_index',5).set('display_name','上游配置').whereEq('display_name','网关配置').andEq('link_uri','/cfg/gateway').update();\n    db2.table('grit_resource').set('display_name','上游监控').whereEq('display_name','网关监控').andEq('link_uri','/mot/gw').update();\n}\n\n\n//for 2.7.0\nif(ver_old < 4){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //禁用\n    db2.table('grit_resource').whereEq('display_name','数据同步').andEq('link_uri','/tool/sync').delete();\n}\n\n//for 2.7.1\nif(ver_old < 5){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //资源改名\n    db2.table('grit_resource').set('display_name','告警工具').whereEq('display_name','日常工具').andEq('link_uri','/tool/').update();\n    //添加资源\n    let tmlRes = db2.table('grit_resource').whereEq('display_name','数据监视').andEq('link_uri','/tool/monitor').limit(1).selectMap('*');\n    if(tmlRes.size() > 0){\n        tmlRes.remove(\"resource_id\");\n\n        if(db2.table('grit_resource').whereEq('resource_pid',tmlRes.resource_pid).andEq('link_uri','/tool/detection').selectExists() == false){\n            db2.table('grit_resource')\n                .setMap(tmlRes).set('display_name','应用监视').set('order_index',11).set('link_uri','/tool/detection').set(\"guid\", XUtil.guid())\n                .usingNull(false)\n                .usingExpr(false)\n                .insert();\n        }\n    }\n\n}\n\n//for 2.7.2\nif(ver_old < 6){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //添加资源(服务发现)\n    let tmlRes = db2.table('grit_resource').whereEq('display_name','配置管理').andEq('link_uri','/cfg/').limit(1).selectMap('*');\n    if(tmlRes.size() > 0){\n        tmlRes.remove(\"resource_id\");\n\n        if(db2.table('grit_resource').whereEq('resource_pid',tmlRes.resource_pid).andEq('link_uri','/sev/').selectExists() == false){\n            let resId1 = db2.table('grit_resource')\n                .setMap(tmlRes).set('display_name','服务发现').set('order_index',4).set('link_uri','/sev/').set(\"guid\", XUtil.guid())\n                .usingNull(false)\n                .usingExpr(false)\n                .insert();\n\n            //资源改名(上游配置)\n            db2.table('grit_resource').set('resource_pid',resId1).set('link_uri','/sev/gateway')\n               .whereEq('display_name','上游配置').andEq('link_uri','/cfg/gateway')\n               .update();\n        }\n\n        //添加资源（服务列表）\n        tmlRes = db2.table('grit_resource').whereEq('display_name','上游配置').andEq('link_uri','/sev/gateway').limit(1).selectMap('*');\n        if(tmlRes.size() > 0){\n            tmlRes.remove(\"resource_id\");\n\n            if(db2.table('grit_resource').whereEq('resource_pid',tmlRes.resource_pid).andEq('link_uri','/sev/service').selectExists() == false){\n                let resId2 = db2.table('grit_resource')\n                .setMap(tmlRes).set('display_name','服务列表').set('order_index',0).set('link_uri','/sev/service').set(\"guid\", XUtil.guid())\n                .usingNull(false)\n                .usingExpr(false)\n                .insert();\n\n                //为'服务状态'的用户，添加'服务列表'\n                tmlRes = db2.table('grit_resource').whereEq('display_name','服务状态').andEq('link_uri','/mot/service').limit(1).selectMap('*');\n                if(tmlRes.resource_id){\n                    let resList = db2.table('grit_resource_linked').whereEq('resource_id',tmlRes.resource_id)\n                                     .selectDataList('resource_id,subject_id,subject_type');\n\n                    resList.forEach(r1 => {\n                        r1.set('resource_id',resId2);\n                    });\n\n                    db2.table('grit_resource_linked').insertList(resList.getRows());\n                }\n            }\n        }\n    }\n}\n\n//for 2.7.2\nif(ver_old < 7){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //资源改名\n    db2.table('grit_resource').set('display_name','系统监控').whereEq('display_name','服务监控').andEq('link_uri','/mot/').update();\n}\n\n//for 2.8.1\nif(ver_old < 8){\n    if(!db2){\n        db2 = water.db('water/water');\n    }\n\n    //添加资源（服务列表）\n    tmlRes = db2.table('grit_resource').whereEq('display_name','应用监视').andEq('link_uri','/tool/detection').limit(1).selectMap('*');\n    if(tmlRes.size() > 0){\n        let tmlResId = tmlRes.resource_id;\n        tmlRes.remove(\"resource_id\");\n\n        if(db2.table('grit_resource').whereEq('resource_pid',tmlRes.resource_pid).andEq('link_uri','/tool/certification').selectExists() == false){\n            let resId2 = db2.table('grit_resource')\n            .setMap(tmlRes).set('display_name','证书监视').set('order_index',10).set('link_uri','/tool/certification').set(\"guid\", XUtil.guid())\n            .usingNull(false)\n            .usingExpr(false)\n            .insert();\n\n            //为'应用监视'的用户，添加'证书监视'\n            if(tmlResId){\n                let resList = db2.table('grit_resource_linked').whereEq('resource_id',tmlResId)\n                                    .selectDataList('resource_id,subject_id,subject_type');\n\n                resList.forEach(r1 => {\n                    r1.set('resource_id',resId2);\n                });\n\n                db2.table('grit_resource_linked').insertList(resList.getRows());\n            }\n        }\n    }\n}\n\n//3.设定版本\nXUtil.cfgSet(upgrade_tag, ver_new+'');\n\nreturn 'OK';","note":"框架升级","plan_state":9,"plan_begin_time":1647579578000,"plan_last_time":1676964253306,"plan_last_timespan":5662,"plan_next_time":1676969978306,"plan_interval":"1h","plan_max":0,"plan_count":1747,"update_fulltime":1671007186426,"use_whitelist":""},{"file_id":421,"file_type":0,"tag":"demo","label":"","path":"/demo/mot/test","rank":0,"is_staticize":false,"is_editable":true,"is_disabled":false,"is_exclude":false,"link_to":"","edit_mode":"javascript","content_type":"","content":"return {num:23};","note":"","plan_state":0,"plan_last_timespan":0,"plan_next_time":0,"plan_interval":"","plan_max":0,"plan_count":0,"update_fulltime":1653657703374,"use_whitelist":"server"}]